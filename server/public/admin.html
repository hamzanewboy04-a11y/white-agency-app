<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>White Agency - –ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å</title>
  <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * { font-family: 'Inter', sans-serif; }
    .glass { background: rgba(255,255,255,0.05); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1); }
    .status-pending { background: #fbbf24; color: #000; }
    .status-working { background: #6b7280; color: #fff; }
    .status-completed { background: #10b981; color: #fff; }
    .status-cancelled { background: #ef4444; color: #fff; }
    .tab-active { background: #fff; color: #000; }
    .notification-badge { animation: pulse 2s infinite; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    .order-card:hover { transform: translateY(-2px); box-shadow: 0 10px 40px rgba(0, 0, 0, 0.4); }
    .fade-in { animation: fadeIn 0.3s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .stat-card { transition: all 0.3s ease; }
    .stat-card:hover { background: rgba(255,255,255,0.08); }
    .nav-btn { transition: all 0.2s ease; }
    .nav-btn:hover { background: rgba(255,255,255,0.1); }
    .nav-btn.active { background: #fff; color: #000; }
  </style>
</head>
<body class="bg-black text-white min-h-screen">
  <!-- Login Screen -->
  <div id="loginScreen" class="min-h-screen flex items-center justify-center p-4">
    <div class="glass rounded-2xl p-8 w-full max-w-md">
      <div class="text-center mb-8">
        <div class="text-4xl mb-4">‚ö°</div>
        <h1 class="text-2xl font-bold tracking-tight">WHITE AGENCY</h1>
        <p class="text-gray-500 mt-2">–í–≤–µ–¥–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –≤—Ö–æ–¥–∞</p>
      </div>
      
      <div class="space-y-4">
        <div>
          <label class="block text-sm text-gray-500 mb-2">API URL</label>
          <input type="text" id="apiUrl" placeholder="https://your-api.railway.app" 
            class="w-full bg-gray-900/50 border border-gray-800 rounded-xl px-4 py-3 focus:outline-none focus:border-white transition">
        </div>
        <div>
          <label class="block text-sm text-gray-500 mb-2">Admin Key</label>
          <input type="password" id="adminKey" placeholder="–í–∞—à ADMIN_KEY –∏–∑ .env" 
            class="w-full bg-gray-900/50 border border-gray-800 rounded-xl px-4 py-3 focus:outline-none focus:border-white transition">
        </div>
        <button onclick="login()" 
          class="w-full bg-white text-black hover:bg-gray-200 py-3 rounded-xl font-semibold transition">
          –í–æ–π—Ç–∏
        </button>
        <p id="loginError" class="text-red-400 text-center text-sm hidden"></p>
      </div>
    </div>
  </div>

  <!-- Main Admin Panel -->
  <div id="adminPanel" class="hidden">
    <!-- Header -->
    <header class="glass sticky top-0 z-50 border-b border-gray-800/50">
      <div class="max-w-7xl mx-auto px-4 py-4 flex items-center justify-between">
        <div class="flex items-center gap-3">
          <span class="text-xl">‚ö°</span>
          <h1 class="text-lg font-bold tracking-tight">WHITE AGENCY</h1>
          <span class="text-[10px] px-2 py-0.5 bg-white text-black rounded-full font-medium">ADMIN</span>
        </div>
        <div class="flex items-center gap-4">
          <div id="connectionStatus" class="flex items-center gap-2 text-xs">
            <span class="w-2 h-2 bg-white rounded-full"></span>
            <span class="text-gray-500">–ü–æ–¥–∫–ª—é—á–µ–Ω–æ</span>
          </div>
          <button onclick="logout()" class="text-gray-500 hover:text-white transition">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/>
            </svg>
          </button>
        </div>
      </div>
    </header>

    <!-- Stats Bar -->
    <div class="max-w-7xl mx-auto px-4 py-6">
      <div class="grid grid-cols-2 md:grid-cols-5 gap-3">
        <div class="glass rounded-xl p-4 stat-card cursor-default">
          <div class="text-gray-500 text-xs mb-1">–í—Å–µ–≥–æ –∑–∞–∫–∞–∑–æ–≤</div>
          <div class="text-2xl font-bold" id="statOrders">‚Äî</div>
        </div>
        <div class="glass rounded-xl p-4 stat-card cursor-default">
          <div class="text-gray-500 text-xs mb-1">–û–∂–∏–¥–∞—é—Ç</div>
          <div class="text-2xl font-bold text-gray-400" id="statPending">‚Äî</div>
        </div>
        <div class="glass rounded-xl p-4 stat-card cursor-default">
          <div class="text-gray-500 text-xs mb-1">–í —Ä–∞–±–æ—Ç–µ</div>
          <div class="text-2xl font-bold text-gray-300" id="statWorking">‚Äî</div>
        </div>
        <div class="glass rounded-xl p-4 stat-card cursor-default">
          <div class="text-gray-500 text-xs mb-1">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</div>
          <div class="text-2xl font-bold text-gray-400" id="statUsers">‚Äî</div>
        </div>
        <div class="glass rounded-xl p-4 stat-card cursor-default">
          <div class="text-gray-500 text-xs mb-1">–î–æ—Ö–æ–¥</div>
          <div class="text-2xl font-bold text-white" id="statRevenue">‚Äî</div>
        </div>
      </div>
    </div>

    <!-- Tabs -->
    <div class="max-w-7xl mx-auto px-4">
      <div class="flex gap-1 overflow-x-auto pb-2">
        <button onclick="switchTab('orders')" class="nav-btn active px-4 py-2 rounded-lg whitespace-nowrap text-sm font-medium" data-tab="orders">
          –ó–∞–∫–∞–∑—ã
        </button>
        <button onclick="switchTab('users')" class="nav-btn px-4 py-2 rounded-lg whitespace-nowrap text-sm font-medium" data-tab="users">
          –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏
        </button>
        <button onclick="switchTab('referrals')" class="nav-btn px-4 py-2 rounded-lg whitespace-nowrap text-sm font-medium" data-tab="referrals">
          –†–µ—Ñ–µ—Ä–∞–ª—ã
        </button>
        <button onclick="switchTab('notifications')" class="nav-btn px-4 py-2 rounded-lg whitespace-nowrap text-sm font-medium" data-tab="notifications">
          –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
        </button>
        <button onclick="switchTab('settings')" class="nav-btn px-4 py-2 rounded-lg whitespace-nowrap text-sm font-medium" data-tab="settings">
          –ù–∞—Å—Ç—Ä–æ–π–∫–∏
        </button>
      </div>
    </div>

    <!-- Content -->
    <main class="max-w-7xl mx-auto px-4 py-6">
      <!-- Orders Tab -->
      <div id="ordersTab" class="tab-content">
        <!-- Filters -->
        <div class="glass rounded-xl p-4 mb-6 flex flex-wrap gap-3 items-center">
          <div class="flex-1 min-w-[200px]">
            <input type="text" id="orderSearch" placeholder="–ü–æ–∏—Å–∫ –ø–æ ID –∏–ª–∏ –∫–ª–∏–µ–Ω—Ç—É..." 
              class="w-full bg-gray-900/50 border border-gray-800 rounded-lg px-4 py-2 text-sm focus:outline-none focus:border-white transition"
              oninput="filterOrders()">
          </div>
          <select id="orderStatusFilter" class="bg-gray-900/50 border border-gray-800 rounded-lg px-4 py-2 text-sm focus:outline-none focus:border-white" onchange="filterOrders()">
            <option value="">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
            <option value="pending">–û–∂–∏–¥–∞–µ—Ç</option>
            <option value="working">–í —Ä–∞–±–æ—Ç–µ</option>
            <option value="completed">–ì–æ—Ç–æ–≤</option>
            <option value="cancelled">–û—Ç–º–µ–Ω—ë–Ω</option>
          </select>
          <button onclick="loadOrders()" class="bg-white text-black hover:bg-gray-200 px-4 py-2 rounded-lg text-sm font-medium transition flex items-center gap-2">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>
            –û–±–Ω–æ–≤–∏—Ç—å
          </button>
        </div>

        <!-- Orders List -->
        <div id="ordersList" class="space-y-3">
          <div class="text-center text-gray-500 py-12">–ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–∫–∞–∑–æ–≤...</div>
        </div>
      </div>

      <!-- Users Tab -->
      <div id="usersTab" class="tab-content hidden">
        <div class="glass rounded-xl p-4 mb-6 flex gap-3 items-center">
          <input type="text" id="userSearch" placeholder="–ü–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏ –∏–ª–∏ username..." 
            class="flex-1 bg-gray-900/50 border border-gray-800 rounded-lg px-4 py-2 text-sm focus:outline-none focus:border-white transition"
            oninput="filterUsers()">
          <button onclick="loadUsers()" class="bg-white text-black hover:bg-gray-200 px-4 py-2 rounded-lg text-sm font-medium transition flex items-center gap-2">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>
            –û–±–Ω–æ–≤–∏—Ç—å
          </button>
        </div>
        <div id="usersList" class="grid gap-3">
          <div class="text-center text-gray-500 py-12">–ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π...</div>
        </div>
      </div>

      <!-- Referrals Tab -->
      <div id="referralsTab" class="tab-content hidden">
        <div class="glass rounded-xl p-4 mb-6">
          <h3 class="font-medium mb-4 text-gray-400 text-sm uppercase tracking-wide">–û–∂–∏–¥–∞—é—â–∏–µ –≤—ã–ø–ª–∞—Ç—ã</h3>
          <div id="pendingPayouts" class="space-y-3">
            <div class="text-center text-gray-500 py-4">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
          </div>
        </div>
        <div class="glass rounded-xl p-4">
          <h3 class="font-medium mb-4 text-gray-400 text-sm uppercase tracking-wide">–í—Å–µ —Ä–µ—Ñ–µ—Ä–∞–ª—ã</h3>
          <div id="referralsList" class="space-y-3">
            <div class="text-center text-gray-500 py-4">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
          </div>
        </div>
      </div>

      <!-- Notifications Tab -->
      <div id="notificationsTab" class="tab-content hidden">
        <div class="glass rounded-xl p-6 mb-6">
          <h3 class="font-medium mb-4 text-gray-400 text-sm uppercase tracking-wide">–û—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ</h3>
          <div class="space-y-4">
            <div>
              <label class="block text-xs text-gray-500 mb-2 uppercase tracking-wide">–ü–æ–ª—É—á–∞—Ç–µ–ª—å</label>
              <select id="notifRecipient" class="w-full bg-gray-900/50 border border-gray-800 rounded-lg px-4 py-2 text-sm focus:outline-none focus:border-white">
                <option value="all">–í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</option>
              </select>
            </div>
            <div>
              <label class="block text-xs text-gray-500 mb-2 uppercase tracking-wide">–ó–∞–≥–æ–ª–æ–≤–æ–∫</label>
              <input type="text" id="notifTitle" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ù–æ–≤–æ—Å—Ç—å" 
                class="w-full bg-gray-900/50 border border-gray-800 rounded-lg px-4 py-2 text-sm focus:outline-none focus:border-white transition">
            </div>
            <div>
              <label class="block text-xs text-gray-500 mb-2 uppercase tracking-wide">–°–æ–æ–±—â–µ–Ω–∏–µ</label>
              <textarea id="notifMessage" rows="3" placeholder="–¢–µ–∫—Å—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è..." 
                class="w-full bg-gray-900/50 border border-gray-800 rounded-lg px-4 py-2 text-sm focus:outline-none focus:border-white transition"></textarea>
            </div>
            <div class="flex items-center gap-4">
              <label class="flex items-center gap-2 cursor-pointer">
                <input type="checkbox" id="sendTelegram" checked class="w-4 h-4 accent-white">
                <span class="text-sm text-gray-400">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ Telegram</span>
              </label>
            </div>
            <button onclick="sendNotification()" class="w-full bg-white text-black hover:bg-gray-200 py-3 rounded-xl font-medium transition">
              –û—Ç–ø—Ä–∞–≤–∏—Ç—å
            </button>
          </div>
        </div>

        <div class="glass rounded-xl p-6">
          <h3 class="font-medium mb-4 text-gray-400 text-sm uppercase tracking-wide">–ò—Å—Ç–æ—Ä–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π</h3>
          <div id="notificationsHistory" class="space-y-3">
            <div class="text-center text-gray-500 py-4">–ò—Å—Ç–æ—Ä–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –±—É–¥–µ—Ç –∑–¥–µ—Å—å</div>
          </div>
        </div>
      </div>

      <!-- Settings Tab -->
      <div id="settingsTab" class="tab-content hidden">
        <div class="grid md:grid-cols-2 gap-6">
          <div class="glass rounded-xl p-6">
            <h3 class="font-medium mb-4 text-gray-400 text-sm uppercase tracking-wide">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ API</h3>
            <div class="space-y-4">
              <div>
                <label class="block text-xs text-gray-500 mb-2 uppercase tracking-wide">API URL</label>
                <input type="text" id="settingsApiUrl" 
                  class="w-full bg-gray-900/50 border border-gray-800 rounded-lg px-4 py-2 text-sm focus:outline-none focus:border-white transition">
              </div>
              <div>
                <label class="block text-xs text-gray-500 mb-2 uppercase tracking-wide">Admin Key</label>
                <input type="password" id="settingsAdminKey" 
                  class="w-full bg-gray-900/50 border border-gray-800 rounded-lg px-4 py-2 text-sm focus:outline-none focus:border-white transition">
              </div>
              <button onclick="saveSettings()" class="bg-white text-black hover:bg-gray-200 px-4 py-2 rounded-lg text-sm font-medium transition">
                –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
              </button>
            </div>
          </div>

          <div class="glass rounded-xl p-6">
            <h3 class="font-medium mb-4 text-gray-400 text-sm uppercase tracking-wide">–ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è</h3>
            <div class="space-y-2">
              <button onclick="exportOrders()" class="w-full bg-gray-900/50 hover:bg-gray-800 px-4 py-3 rounded-lg transition text-left text-sm flex items-center gap-3">
                <span class="text-gray-400">‚Üì</span> –≠–∫—Å–ø–æ—Ä—Ç –∑–∞–∫–∞–∑–æ–≤ –≤ CSV
              </button>
              <button onclick="exportUsers()" class="w-full bg-gray-900/50 hover:bg-gray-800 px-4 py-3 rounded-lg transition text-left text-sm flex items-center gap-3">
                <span class="text-gray-400">‚Üì</span> –≠–∫—Å–ø–æ—Ä—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ CSV
              </button>
              <button onclick="refreshAllData()" class="w-full bg-gray-900/50 hover:bg-gray-800 px-4 py-3 rounded-lg transition text-left text-sm flex items-center gap-3">
                <span class="text-gray-400">‚Üª</span> –û–±–Ω–æ–≤–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ
              </button>
            </div>
          </div>

          <div class="glass rounded-xl p-6 md:col-span-2">
            <h3 class="font-medium mb-4 text-gray-400 text-sm uppercase tracking-wide">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h3>
            <div class="bg-gray-900/50 rounded-lg p-4 text-sm text-gray-400">
              <p class="mb-2">‚úÖ –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å —É—Å–ø–µ—à–Ω–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∞ –∫ —Å–µ—Ä–≤–µ—Ä—É</p>
              <p class="mb-2">üìä –í—Å–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã —É–∂–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã –≤ server.js</p>
              <p>üîî –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è –≤ Telegram –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏</p>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- Order Detail Modal -->
  <div id="orderModal" class="fixed inset-0 bg-black/90 z-50 hidden items-center justify-center p-4">
    <div class="glass rounded-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto border border-gray-800">
      <div class="sticky top-0 glass p-4 border-b border-gray-800 flex items-center justify-between">
        <h3 class="font-medium">–î–µ—Ç–∞–ª–∏ –∑–∞–∫–∞–∑–∞</h3>
        <button onclick="closeOrderModal()" class="text-gray-500 hover:text-white">‚úï</button>
      </div>
      <div id="orderModalContent" class="p-6">
        <!-- Content loaded dynamically -->
      </div>
    </div>
  </div>

  <!-- Toast Container -->
  <div id="toastContainer" class="fixed bottom-4 right-4 z-50 space-y-2"></div>

  <script>
    // State
    let apiUrl = localStorage.getItem('apiUrl') || '';
    let adminKey = localStorage.getItem('adminKey') || '';
    let ordersData = [];
    let usersData = [];
    let referralsData = [];

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      if (apiUrl && adminKey) {
        document.getElementById('apiUrl').value = apiUrl;
        document.getElementById('adminKey').value = adminKey;
        login();
      }
    });

    // Auth
    async function login() {
      const url = document.getElementById('apiUrl').value.trim().replace(/\/$/, '');
      const key = document.getElementById('adminKey').value.trim();
      
      if (!url || !key) {
        showError('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è');
        return;
      }
      
      apiUrl = url;
      adminKey = key;
      
      try {
        const response = await fetch(`${apiUrl}/health`);
        if (!response.ok) throw new Error('Server not responding');
        
        localStorage.setItem('apiUrl', apiUrl);
        localStorage.setItem('adminKey', adminKey);
        
        document.getElementById('loginScreen').classList.add('hidden');
        document.getElementById('adminPanel').classList.remove('hidden');
        
        document.getElementById('settingsApiUrl').value = apiUrl;
        document.getElementById('settingsAdminKey').value = adminKey;
        
        refreshAllData();
      } catch (error) {
        showError('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è: ' + error.message);
      }
    }

    function logout() {
      localStorage.removeItem('apiUrl');
      localStorage.removeItem('adminKey');
      location.reload();
    }

    function showError(msg) {
      const el = document.getElementById('loginError');
      el.textContent = msg;
      el.classList.remove('hidden');
      setTimeout(() => el.classList.add('hidden'), 3000);
    }

    // API Calls
    async function apiCall(endpoint, method = 'GET', body = null) {
      const options = {
        method,
        headers: {
          'Content-Type': 'application/json',
          'X-Admin-Key': adminKey
        }
      };
      
      if (body) {
        options.body = JSON.stringify(body);
      }
      
      const response = await fetch(`${apiUrl}${endpoint}`, options);
      
      if (!response.ok) {
        throw new Error(`API Error: ${response.status}`);
      }
      
      return response.json();
    }

    // Load Data
    async function loadOrders() {
      try {
        ordersData = await apiCall('/api/admin/orders');
        renderOrders();
        updateStats();
      } catch (error) {
        console.error('Error loading orders:', error);
        document.getElementById('ordersList').innerHTML = `
          <div class="text-center text-gray-500 py-12">
            <div class="text-2xl mb-2">‚ö†Ô∏è</div>
            –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∑–∞–∫–∞–∑—ã<br>
            <small class="text-gray-600">${error.message}</small>
          </div>`;
      }
    }

    async function loadUsers() {
      try {
        usersData = await apiCall('/api/admin/users');
        renderUsers();
        updateStats();
        updateNotifRecipients();
      } catch (error) {
        console.error('Error loading users:', error);
        document.getElementById('usersList').innerHTML = `
          <div class="text-center text-gray-500 py-12">
            <div class="text-2xl mb-2">‚ö†Ô∏è</div>
            –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π<br>
            <small class="text-gray-600">${error.message}</small>
          </div>`;
      }
    }

    async function loadReferrals() {
      try {
        referralsData = await apiCall('/api/admin/referrals');
        renderReferrals();
      } catch (error) {
        console.error('Error loading referrals:', error);
      }
    }

    async function refreshAllData() {
      showToast('–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö...', 'info');
      await Promise.all([loadOrders(), loadUsers(), loadReferrals()]);
      showToast('–î–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω—ã', 'success');
    }

    // Render Functions
    function renderOrders() {
      const search = document.getElementById('orderSearch').value.toLowerCase();
      const statusFilter = document.getElementById('orderStatusFilter').value;
      
      let filtered = ordersData.filter(o => {
        const matchSearch = !search || 
          o.id.toLowerCase().includes(search) ||
          (o.user_name && o.user_name.toLowerCase().includes(search)) ||
          (o.username && o.username.toLowerCase().includes(search));
        const matchStatus = !statusFilter || o.status === statusFilter;
        return matchSearch && matchStatus;
      });
      
      if (filtered.length === 0) {
        document.getElementById('ordersList').innerHTML = `
          <div class="text-center text-gray-500 py-12">–ó–∞–∫–∞–∑—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>`;
        return;
      }
      
      document.getElementById('ordersList').innerHTML = filtered.map(order => `
        <div class="order-card glass rounded-xl p-4 transition cursor-pointer fade-in border border-gray-800/50 hover:border-gray-700" onclick="openOrderModal('${order.id}')">
          <div class="flex flex-wrap items-start justify-between gap-4">
            <div class="flex-1 min-w-[200px]">
              <div class="flex items-center gap-3 mb-2">
                <span class="font-mono text-sm text-gray-400">#${order.id}</span>
                <span class="status-${order.status} px-2 py-0.5 rounded-full text-xs font-medium">
                  ${getStatusText(order.status)}
                </span>
              </div>
              <div class="text-gray-400 text-sm space-y-1">
                <div>${order.user_name || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'} ${order.username ? `@${order.username}` : ''}</div>
                <div class="text-gray-500">${order.service} ¬∑ ${order.niche}</div>
                <div class="text-gray-600">${formatDate(order.created_at)}</div>
              </div>
            </div>
            <div class="text-right">
              <div class="text-xl font-medium">$${order.total}</div>
              <div class="text-xs text-gray-600">${order.payment_method || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}</div>
            </div>
          </div>
        </div>
      `).join('');
    }

    function renderUsers() {
      const search = document.getElementById('userSearch').value.toLowerCase();
      
      let filtered = usersData.filter(u => {
        return !search || 
          (u.name && u.name.toLowerCase().includes(search)) ||
          (u.username && u.username.toLowerCase().includes(search));
      });
      
      if (filtered.length === 0) {
        document.getElementById('usersList').innerHTML = '<div class="text-center text-gray-500 py-12">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';
        return;
      }
      
      document.getElementById('usersList').innerHTML = filtered.map(user => `
        <div class="glass rounded-xl p-4 fade-in border border-gray-800/50">
          <div class="flex flex-wrap items-center justify-between gap-4">
            <div class="flex items-center gap-4">
              <div class="w-10 h-10 bg-gray-800 rounded-full flex items-center justify-center text-sm font-medium">
                ${(user.name || 'U').charAt(0).toUpperCase()}
              </div>
              <div>
                <div class="font-medium">${user.name || '–ë–µ–∑ –∏–º–µ–Ω–∏'}</div>
                <div class="text-sm text-gray-500">@${user.username || '–Ω–µ—Ç username'}</div>
                <div class="text-xs text-gray-600">ID: ${user.telegram_id}</div>
              </div>
            </div>
            <div class="flex items-center gap-6 text-sm">
              <div class="text-center">
                <div class="text-sm font-medium ${getLevelColor(user.level)}">${(user.level || 'none').toUpperCase()}</div>
                <div class="text-xs text-gray-600">–£—Ä–æ–≤–µ–Ω—å</div>
              </div>
              <div class="text-center">
                <div class="text-sm font-medium text-white">$${user.total_spent || 0}</div>
                <div class="text-xs text-gray-600">–ü–æ—Ç—Ä–∞—á–µ–Ω–æ</div>
              </div>
              <div class="text-center">
                <div class="text-sm font-medium text-gray-400">$${(user.cashback || 0).toFixed(2)}</div>
                <div class="text-xs text-gray-600">–ö–µ—à–±—ç–∫</div>
              </div>
              <button onclick="sendMessageToUser(${user.id}, '${user.name || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'}')" class="bg-gray-800 hover:bg-gray-700 px-3 py-2 rounded-lg text-sm transition">
                ‚úâ
              </button>
            </div>
          </div>
        </div>
      `).join('');
    }

    function renderReferrals() {
      const pending = referralsData.filter(r => r.earnings > 0);
      
      document.getElementById('pendingPayouts').innerHTML = pending.length > 0 ? pending.map(r => `
        <div class="bg-gray-900/50 rounded-lg p-3 flex items-center justify-between border border-gray-800">
          <div>
            <div class="font-medium text-sm">${r.referrer_name}</div>
            <div class="text-xs text-gray-500">–ó–∞: ${r.referred_name}</div>
            <div class="text-xs text-gray-600 mt-1">${r.trc20_wallet || '–ö–æ—à–µ–ª—ë–∫ –Ω–µ —É–∫–∞–∑–∞–Ω'}</div>
          </div>
          <div class="text-right">
            <div class="text-lg font-medium">$${r.earnings.toFixed(2)}</div>
            <button onclick="markAsPaid(${r.id})" class="text-xs bg-gray-800 hover:bg-gray-700 px-2 py-1 rounded mt-1 transition">
              –í—ã–ø–ª–∞—á–µ–Ω–æ
            </button>
          </div>
        </div>
      `).join('') : '<div class="text-gray-600 text-center text-sm">–ù–µ—Ç –æ–∂–∏–¥–∞—é—â–∏—Ö –≤—ã–ø–ª–∞—Ç</div>';
      
      document.getElementById('referralsList').innerHTML = referralsData.length > 0 ? referralsData.map(r => `
        <div class="bg-gray-900/50 rounded-lg p-3 flex items-center justify-between border border-gray-800">
          <div class="text-sm">
            <span class="text-gray-400">${r.referrer_name}</span> 
            –ø—Ä–∏–≥–ª–∞—Å–∏–ª 
            <span class="text-gray-400">${r.referred_name}</span>
          </div>
          <div class="text-gray-400 font-medium text-sm">+$${r.earnings.toFixed(2)}</div>
        </div>
      `).join('') : '<div class="text-gray-600 text-center text-sm">–ù–µ—Ç —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤</div>';
    }

    function updateStats() {
      document.getElementById('statOrders').textContent = ordersData.length;
      document.getElementById('statPending').textContent = ordersData.filter(o => o.status === 'pending').length;
      document.getElementById('statWorking').textContent = ordersData.filter(o => o.status === 'working').length;
      document.getElementById('statUsers').textContent = usersData.length;
      
      const revenue = ordersData
        .filter(o => o.status === 'completed')
        .reduce((sum, o) => sum + (o.total || 0), 0);
      document.getElementById('statRevenue').textContent = '$' + revenue.toFixed(0);
    }

    function updateNotifRecipients() {
      const select = document.getElementById('notifRecipient');
      select.innerHTML = '<option value="all">–í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</option>';
      usersData.forEach(u => {
        select.innerHTML += `<option value="${u.id}">${u.name || '–ë–µ–∑ –∏–º–µ–Ω–∏'} (@${u.username || '–Ω–µ—Ç'})</option>`;
      });
    }

    // Order Modal
    function openOrderModal(orderId) {
      const order = ordersData.find(o => o.id === orderId);
      if (!order) return;
      
      let formatsStr = '-';
      try {
        const formats = JSON.parse(order.formats || '[]');
        formatsStr = formats.length > 0 ? formats.join(', ') : '-';
      } catch(e) {
        formatsStr = order.formats || '-';
      }
      
      document.getElementById('orderModalContent').innerHTML = `
        <div class="space-y-6">
          <div class="flex items-center justify-between">
            <span class="font-mono text-lg text-gray-400">#${order.id}</span>
            <span class="status-${order.status} px-3 py-1 rounded-full text-sm font-medium">
              ${getStatusText(order.status)}
            </span>
          </div>
          
          <div class="grid grid-cols-2 gap-3">
            <div class="bg-gray-900/50 rounded-lg p-3">
              <div class="text-xs text-gray-600 mb-1 uppercase tracking-wide">–ö–ª–∏–µ–Ω—Ç</div>
              <div class="font-medium">${order.user_name || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}</div>
              <div class="text-sm text-gray-500">@${order.username || '–Ω–µ—Ç'}</div>
            </div>
            <div class="bg-gray-900/50 rounded-lg p-3">
              <div class="text-xs text-gray-600 mb-1 uppercase tracking-wide">–°—É–º–º–∞</div>
              <div class="font-medium text-xl">$${order.total}</div>
            </div>
          </div>
          
          <div class="bg-gray-900/50 rounded-lg p-4 space-y-2 text-sm">
            <div class="flex justify-between"><span class="text-gray-600">–£—Å–ª—É–≥–∞:</span><span>${order.service}</span></div>
            <div class="flex justify-between"><span class="text-gray-600">–ù–∏—à–∞:</span><span>${order.niche}</span></div>
            <div class="flex justify-between"><span class="text-gray-600">–§–æ—Ä–º–∞—Ç—ã:</span><span>${formatsStr}</span></div>
            <div class="flex justify-between"><span class="text-gray-600">–û–ø–ª–∞—Ç–∞:</span><span>${order.payment_method || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}</span></div>
            ${order.tx_hash ? `<div class="flex justify-between"><span class="text-gray-600">TxHash:</span><span class="text-xs font-mono">${order.tx_hash.substring(0, 20)}...</span></div>` : ''}
          </div>
          
          ${order.description ? `
          <div class="bg-gray-900/50 rounded-lg p-4">
            <div class="text-xs text-gray-600 mb-2 uppercase tracking-wide">–û–ø–∏—Å–∞–Ω–∏–µ</div>
            <div class="text-sm text-gray-400">${order.description}</div>
          </div>` : ''}
          
          ${order.refs ? `
          <div class="bg-gray-900/50 rounded-lg p-4">
            <div class="text-xs text-gray-600 mb-2 uppercase tracking-wide">–†–µ—Ñ–µ—Ä–µ–Ω—Å—ã</div>
            <div class="text-sm text-gray-400 break-all">${order.refs}</div>
          </div>` : ''}
          
          <div class="border-t border-gray-800 pt-4">
            <div class="text-xs text-gray-600 mb-3 uppercase tracking-wide">–ò–∑–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å:</div>
            <div class="grid grid-cols-2 gap-2">
              <button onclick="updateOrderStatus('${order.id}', 'pending')" class="status-pending py-2 rounded-lg font-medium text-sm ${order.status === 'pending' ? 'ring-2 ring-white' : ''}">
                –û–∂–∏–¥–∞–µ—Ç
              </button>
              <button onclick="updateOrderStatus('${order.id}', 'working')" class="status-working py-2 rounded-lg font-medium text-sm ${order.status === 'working' ? 'ring-2 ring-white' : ''}">
                –í —Ä–∞–±–æ—Ç–µ
              </button>
              <button onclick="updateOrderStatus('${order.id}', 'completed')" class="status-completed py-2 rounded-lg font-medium text-sm ${order.status === 'completed' ? 'ring-2 ring-white' : ''}">
                –ì–æ—Ç–æ–≤
              </button>
              <button onclick="updateOrderStatus('${order.id}', 'cancelled')" class="status-cancelled py-2 rounded-lg font-medium text-sm ${order.status === 'cancelled' ? 'ring-2 ring-white' : ''}">
                –û—Ç–º–µ–Ω—ë–Ω
              </button>
            </div>
          </div>
          
          <div class="border-t border-gray-800 pt-4">
            <div class="text-xs text-gray-600 mb-3 uppercase tracking-wide">–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç—É:</div>
            <textarea id="orderMessage" rows="2" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." 
              class="w-full bg-gray-900/50 border border-gray-800 rounded-lg px-4 py-2 text-sm mb-2 focus:outline-none focus:border-white transition"></textarea>
            <button onclick="sendOrderMessage('${order.id}')" class="w-full bg-white text-black hover:bg-gray-200 py-2 rounded-lg font-medium text-sm transition">
              –û—Ç–ø—Ä–∞–≤–∏—Ç—å
            </button>
          </div>
        </div>
      `;
      
      document.getElementById('orderModal').classList.remove('hidden');
      document.getElementById('orderModal').classList.add('flex');
    }

    function closeOrderModal() {
      document.getElementById('orderModal').classList.add('hidden');
      document.getElementById('orderModal').classList.remove('flex');
    }

    // Actions
    async function updateOrderStatus(orderId, status) {
      try {
        await apiCall(`/api/admin/orders/${orderId}/status`, 'POST', { status });
        showToast(`–°—Ç–∞—Ç—É—Å –∏–∑–º–µ–Ω—ë–Ω –Ω–∞ "${getStatusText(status)}"`, 'success');
        await loadOrders();
        openOrderModal(orderId);
      } catch (error) {
        showToast('–û—à–∏–±–∫–∞: ' + error.message, 'error');
      }
    }

    async function sendOrderMessage(orderId) {
      const message = document.getElementById('orderMessage').value.trim();
      if (!message) {
        showToast('–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ', 'warning');
        return;
      }
      
      try {
        await apiCall(`/api/admin/orders/${orderId}/message`, 'POST', { message });
        showToast('–°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ', 'success');
        document.getElementById('orderMessage').value = '';
      } catch (error) {
        showToast('–û—à–∏–±–∫–∞: ' + error.message, 'error');
      }
    }

    async function sendNotification() {
      const recipient = document.getElementById('notifRecipient').value;
      const title = document.getElementById('notifTitle').value.trim();
      const message = document.getElementById('notifMessage').value.trim();
      const sendTelegram = document.getElementById('sendTelegram').checked;
      
      if (!title || !message) {
        showToast('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –∑–∞–≥–æ–ª–æ–≤–æ–∫ –∏ —Å–æ–æ–±—â–µ–Ω–∏–µ', 'warning');
        return;
      }
      
      try {
        await apiCall('/api/admin/notify', 'POST', {
          userId: recipient,
          title,
          message,
          sendTelegram
        });
        showToast('–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ', 'success');
        document.getElementById('notifTitle').value = '';
        document.getElementById('notifMessage').value = '';
      } catch (error) {
        showToast('–û—à–∏–±–∫–∞: ' + error.message, 'error');
      }
    }

    function sendMessageToUser(userId, name) {
      switchTab('notifications');
      document.getElementById('notifRecipient').value = userId;
      document.getElementById('notifTitle').value = `–°–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è ${name}`;
      document.getElementById('notifTitle').focus();
    }

    async function markAsPaid(referralId) {
      try {
        await apiCall(`/api/admin/referrals/${referralId}/paid`, 'POST', {});
        showToast('–û—Ç–º–µ—á–µ–Ω–æ –∫–∞–∫ –≤—ã–ø–ª–∞—á–µ–Ω–æ', 'success');
        await loadReferrals();
      } catch (error) {
        showToast('–û—à–∏–±–∫–∞: ' + error.message, 'error');
      }
    }

    // Tabs
    function switchTab(tabName) {
      document.querySelectorAll('.tab-content').forEach(t => t.classList.add('hidden'));
      document.querySelectorAll('.nav-btn').forEach(b => {
        b.classList.remove('active');
      });
      
      document.getElementById(tabName + 'Tab').classList.remove('hidden');
      document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
    }

    function filterOrders() {
      renderOrders();
    }

    function filterUsers() {
      renderUsers();
    }

    // Export
    function exportOrders() {
      const csv = [
        ['ID', '–ö–ª–∏–µ–Ω—Ç', 'Username', '–£—Å–ª—É–≥–∞', '–ù–∏—à–∞', '–°—É–º–º–∞', '–°—Ç–∞—Ç—É—Å', '–û–ø–ª–∞—Ç–∞', '–î–∞—Ç–∞'].join(','),
        ...ordersData.map(o => [
          o.id,
          o.user_name || '',
          o.username || '',
          o.service,
          o.niche,
          o.total,
          o.status,
          o.payment_method || '',
          o.created_at
        ].join(','))
      ].join('\n');
      
      downloadFile('orders.csv', csv);
      showToast('–ó–∞–∫–∞–∑—ã —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã', 'success');
    }

    function exportUsers() {
      const csv = [
        ['ID', 'Telegram ID', '–ò–º—è', 'Username', '–£—Ä–æ–≤–µ–Ω—å', '–ü–æ—Ç—Ä–∞—á–µ–Ω–æ', '–ö–µ—à–±—ç–∫', '–†–µ—Ñ. –∫–æ–¥', '–ö–æ—à–µ–ª—ë–∫', '–î–∞—Ç–∞'].join(','),
        ...usersData.map(u => [
          u.id,
          u.telegram_id,
          u.name || '',
          u.username || '',
          u.level,
          u.total_spent,
          u.cashback,
          u.referral_code,
          u.trc20_wallet || '',
          u.created_at
        ].join(','))
      ].join('\n');
      
      downloadFile('users.csv', csv);
      showToast('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã', 'success');
    }

    function downloadFile(filename, content) {
      const blob = new Blob([content], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      a.click();
      URL.revokeObjectURL(url);
    }

    function saveSettings() {
      apiUrl = document.getElementById('settingsApiUrl').value.trim().replace(/\/$/, '');
      adminKey = document.getElementById('settingsAdminKey').value.trim();
      localStorage.setItem('apiUrl', apiUrl);
      localStorage.setItem('adminKey', adminKey);
      showToast('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã', 'success');
    }

    // Helpers
    function getStatusText(status) {
      const statuses = {
        pending: '–û–∂–∏–¥–∞–µ—Ç',
        working: '–í —Ä–∞–±–æ—Ç–µ',
        completed: '–ì–æ—Ç–æ–≤',
        cancelled: '–û—Ç–º–µ–Ω—ë–Ω'
      };
      return statuses[status] || status;
    }

    function getLevelColor(level) {
      const colors = {
        none: 'text-gray-500',
        bronze: 'text-orange-400',
        silver: 'text-gray-300',
        gold: 'text-yellow-400',
        platinum: 'text-white'
      };
      return colors[level] || 'text-gray-500';
    }

    function formatDate(dateStr) {
      if (!dateStr) return '-';
      const date = new Date(dateStr);
      return date.toLocaleDateString('ru-RU', {
        day: 'numeric',
        month: 'short',
        hour: '2-digit',
        minute: '2-digit'
      });
    }

    function showToast(message, type = 'info') {
      const container = document.getElementById('toastContainer');
      const colors = {
        success: 'bg-white text-black',
        error: 'bg-red-600 text-white',
        warning: 'bg-gray-700 text-white',
        info: 'bg-gray-600 text-white'
      };
      
      const toast = document.createElement('div');
      toast.className = `${colors[type]} px-4 py-3 rounded-lg shadow-lg fade-in text-sm`;
      toast.textContent = message;
      container.appendChild(toast);
      
      setTimeout(() => {
        toast.remove();
      }, 3000);
    }

    // Close modal on outside click
    document.getElementById('orderModal').addEventListener('click', (e) => {
      if (e.target.id === 'orderModal') {
        closeOrderModal();
      }
    });

    // Auto-refresh every 30 seconds
    setInterval(() => {
      if (!document.getElementById('adminPanel').classList.contains('hidden')) {
        loadOrders();
      }
    }, 30000);
  </script>
</body>
</html>
