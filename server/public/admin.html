<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>White Agency - –ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å</title>
  <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * { font-family: 'Inter', sans-serif; }
    .glass { background: rgba(255,255,255,0.05); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1); }
    .status-pending { background: #fbbf24; color: #000; }
    .status-working { background: #6b7280; color: #fff; }
    .status-completed { background: #10b981; color: #fff; }
    .status-cancelled { background: #ef4444; color: #fff; }
    .tab-active { background: #fff; color: #000; }
    .notification-badge { animation: pulse 2s infinite; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    .order-card:hover { transform: translateY(-2px); box-shadow: 0 10px 40px rgba(0, 0, 0, 0.4); }
    .fade-in { animation: fadeIn 0.3s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .stat-card { transition: all 0.3s ease; }
    .stat-card:hover { background: rgba(255,255,255,0.08); }
    .nav-btn { transition: all 0.2s ease; }
    .nav-btn:hover { background: rgba(255,255,255,0.1); }
    .nav-btn.active { background: #fff; color: #000; }
    .spinner { border: 2px solid rgba(255,255,255,0.1); border-top-color: #fff; border-radius: 50%; width: 16px; height: 16px; animation: spin 0.8s linear infinite; display: inline-block; }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>
<body class="bg-black text-white min-h-screen">
  <!-- Login Screen -->
  <div id="loginScreen" class="min-h-screen flex items-center justify-center p-4">
    <div class="glass rounded-2xl p-8 w-full max-w-md">
      <div class="text-center mb-8">
        <div class="text-4xl mb-4">‚ö°</div>
        <h1 class="text-2xl font-bold tracking-tight">WHITE AGENCY</h1>
        <p class="text-gray-500 mt-2">–í–≤–µ–¥–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –≤—Ö–æ–¥–∞</p>
      </div>
      
      <div class="space-y-4">
        <div>
          <label class="block text-sm text-gray-500 mb-2">API URL <span class="text-gray-600">(–æ—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º –µ—Å–ª–∏ –Ω–∞ —Ç–æ–º –∂–µ —Å–µ—Ä–≤–µ—Ä–µ)</span></label>
          <input type="text" id="apiUrl" placeholder="https://your-api.railway.app –∏–ª–∏ –ø—É—Å—Ç–æ" 
            class="w-full bg-gray-900/50 border border-gray-800 rounded-xl px-4 py-3 focus:outline-none focus:border-white transition">
        </div>
        <div>
          <label class="block text-sm text-gray-500 mb-2">Admin Key</label>
          <input type="password" id="adminKey" placeholder="–í–∞—à ADMIN_KEY –∏–∑ .env" 
            class="w-full bg-gray-900/50 border border-gray-800 rounded-xl px-4 py-3 focus:outline-none focus:border-white transition">
        </div>
        <button onclick="login()" id="loginBtn"
          class="w-full bg-white text-black hover:bg-gray-200 py-3 rounded-xl font-semibold transition flex items-center justify-center gap-2">
          <span>–í–æ–π—Ç–∏</span>
        </button>
        <div id="loginError" class="text-red-400 text-center text-sm hidden p-3 bg-red-500/10 rounded-lg"></div>
        <div id="loginInfo" class="text-gray-500 text-center text-xs hidden"></div>
      </div>
      
      <div class="mt-6 text-center text-gray-600 text-xs">
        <p>–ü–æ–¥—Å–∫–∞–∑–∫–∞: ADMIN_KEY –∑–∞–¥–∞—ë—Ç—Å—è –≤ .env —Ñ–∞–π–ª–µ —Å–µ—Ä–≤–µ—Ä–∞</p>
      </div>
    </div>
  </div>

  <!-- Main Admin Panel -->
  <div id="adminPanel" class="hidden">
    <!-- Header -->
    <header class="glass sticky top-0 z-50 border-b border-gray-800/50">
      <div class="max-w-7xl mx-auto px-4 py-4 flex items-center justify-between">
        <div class="flex items-center gap-3">
          <span class="text-xl">‚ö°</span>
          <h1 class="text-lg font-bold tracking-tight">WHITE AGENCY</h1>
          <span class="text-[10px] px-2 py-0.5 bg-white text-black rounded-full font-medium">ADMIN</span>
        </div>
        <div class="flex items-center gap-4">
          <div id="connectionStatus" class="flex items-center gap-2 text-xs">
            <span class="w-2 h-2 bg-green-500 rounded-full"></span>
            <span class="text-gray-500">–ü–æ–¥–∫–ª—é—á–µ–Ω–æ</span>
          </div>
          <button onclick="logout()" class="text-gray-500 hover:text-white transition" title="–í—ã–π—Ç–∏">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/>
            </svg>
          </button>
        </div>
      </div>
    </header>

    <!-- Stats Bar -->
    <div class="max-w-7xl mx-auto px-4 py-6">
      <div class="grid grid-cols-2 md:grid-cols-5 gap-3">
        <div class="glass rounded-xl p-4 stat-card cursor-default">
          <div class="text-gray-500 text-xs mb-1">–í—Å–µ–≥–æ –∑–∞–∫–∞–∑–æ–≤</div>
          <div class="text-2xl font-bold" id="statOrders">‚Äî</div>
        </div>
        <div class="glass rounded-xl p-4 stat-card cursor-default">
          <div class="text-gray-500 text-xs mb-1">–û–∂–∏–¥–∞—é—Ç</div>
          <div class="text-2xl font-bold text-yellow-400" id="statPending">‚Äî</div>
        </div>
        <div class="glass rounded-xl p-4 stat-card cursor-default">
          <div class="text-gray-500 text-xs mb-1">–í —Ä–∞–±–æ—Ç–µ</div>
          <div class="text-2xl font-bold text-blue-400" id="statWorking">‚Äî</div>
        </div>
        <div class="glass rounded-xl p-4 stat-card cursor-default">
          <div class="text-gray-500 text-xs mb-1">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</div>
          <div class="text-2xl font-bold text-purple-400" id="statUsers">‚Äî</div>
        </div>
        <div class="glass rounded-xl p-4 stat-card cursor-default">
          <div class="text-gray-500 text-xs mb-1">–î–æ—Ö–æ–¥</div>
          <div class="text-2xl font-bold text-green-400" id="statRevenue">‚Äî</div>
        </div>
      </div>
    </div>

    <!-- Tabs -->
    <div class="max-w-7xl mx-auto px-4">
      <div class="flex gap-1 overflow-x-auto pb-2">
        <button onclick="switchTab('orders')" class="nav-btn active px-4 py-2 rounded-lg whitespace-nowrap text-sm font-medium" data-tab="orders">
          –ó–∞–∫–∞–∑—ã
        </button>
        <button onclick="switchTab('users')" class="nav-btn px-4 py-2 rounded-lg whitespace-nowrap text-sm font-medium" data-tab="users">
          –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏
        </button>
        <button onclick="switchTab('referrals')" class="nav-btn px-4 py-2 rounded-lg whitespace-nowrap text-sm font-medium" data-tab="referrals">
          –†–µ—Ñ–µ—Ä–∞–ª—ã
        </button>
        <button onclick="switchTab('notifications')" class="nav-btn px-4 py-2 rounded-lg whitespace-nowrap text-sm font-medium" data-tab="notifications">
          –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
        </button>
        <button onclick="switchTab('promos')" class="nav-btn px-4 py-2 rounded-lg whitespace-nowrap text-sm font-medium" data-tab="promos">
          –ü—Ä–æ–º–æ–∫–æ–¥—ã
        </button>
        <button onclick="switchTab('withdrawals')" class="nav-btn px-4 py-2 rounded-lg whitespace-nowrap text-sm font-medium" data-tab="withdrawals">
          üí∏ –í—ã–ø–ª–∞—Ç—ã
        </button>
        <button onclick="switchTab('settings')" class="nav-btn px-4 py-2 rounded-lg whitespace-nowrap text-sm font-medium" data-tab="settings">
          –ù–∞—Å—Ç—Ä–æ–π–∫–∏
        </button>
      </div>
    </div>

    <!-- Content -->
    <main class="max-w-7xl mx-auto px-4 py-6">
      <!-- Orders Tab -->
      <div id="ordersTab" class="tab-content">
        <!-- Filters -->
        <div class="glass rounded-xl p-4 mb-6 flex flex-wrap gap-3 items-center">
          <div class="flex-1 min-w-[200px]">
            <input type="text" id="orderSearch" placeholder="–ü–æ–∏—Å–∫ –ø–æ ID –∏–ª–∏ –∫–ª–∏–µ–Ω—Ç—É..." 
              class="w-full bg-gray-900/50 border border-gray-800 rounded-lg px-4 py-2 text-sm focus:outline-none focus:border-white transition"
              oninput="filterOrders()">
          </div>
          <select id="orderStatusFilter" class="bg-gray-900/50 border border-gray-800 rounded-lg px-4 py-2 text-sm focus:outline-none focus:border-white" onchange="filterOrders()">
            <option value="">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
            <option value="pending">–û–∂–∏–¥–∞–µ—Ç</option>
            <option value="working">–í —Ä–∞–±–æ—Ç–µ</option>
            <option value="completed">–ì–æ—Ç–æ–≤</option>
            <option value="cancelled">–û—Ç–º–µ–Ω—ë–Ω</option>
          </select>
          <button onclick="loadOrders()" class="bg-white text-black hover:bg-gray-200 px-4 py-2 rounded-lg text-sm font-medium transition flex items-center gap-2">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>
            –û–±–Ω–æ–≤–∏—Ç—å
          </button>
        </div>

        <!-- Orders List -->
        <div id="ordersList" class="space-y-3">
          <div class="text-center text-gray-500 py-12">–ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–∫–∞–∑–æ–≤...</div>
        </div>
      </div>

      <!-- Users Tab -->
      <div id="usersTab" class="tab-content hidden">
        <div class="glass rounded-xl p-4 mb-6 flex gap-3 items-center">
          <input type="text" id="userSearch" placeholder="–ü–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏ –∏–ª–∏ username..." 
            class="flex-1 bg-gray-900/50 border border-gray-800 rounded-lg px-4 py-2 text-sm focus:outline-none focus:border-white transition"
            oninput="filterUsers()">
          <button onclick="loadUsers()" class="bg-white text-black hover:bg-gray-200 px-4 py-2 rounded-lg text-sm font-medium transition flex items-center gap-2">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>
            –û–±–Ω–æ–≤–∏—Ç—å
          </button>
        </div>
        <div id="usersList" class="grid gap-3">
          <div class="text-center text-gray-500 py-12">–ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π...</div>
        </div>
      </div>

      <!-- Referrals Tab -->
      <div id="referralsTab" class="tab-content hidden">
        <div class="glass rounded-xl p-4 mb-6">
          <h3 class="font-medium mb-4 text-gray-400 text-sm uppercase tracking-wide">–û–∂–∏–¥–∞—é—â–∏–µ –≤—ã–ø–ª–∞—Ç—ã</h3>
          <div id="pendingPayouts" class="space-y-3">
            <div class="text-center text-gray-500 py-4">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
          </div>
        </div>
        <div class="glass rounded-xl p-4">
          <h3 class="font-medium mb-4 text-gray-400 text-sm uppercase tracking-wide">–í—Å–µ —Ä–µ—Ñ–µ—Ä–∞–ª—ã</h3>
          <div id="referralsList" class="space-y-3">
            <div class="text-center text-gray-500 py-4">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
          </div>
        </div>
      </div>

      <!-- Notifications Tab -->
      <div id="notificationsTab" class="tab-content hidden">
        <div class="glass rounded-xl p-6 mb-6">
          <h3 class="font-medium mb-4 text-gray-400 text-sm uppercase tracking-wide">–û—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ</h3>
          <div class="space-y-4">
            <div>
              <label class="block text-xs text-gray-500 mb-2 uppercase tracking-wide">–ü–æ–ª—É—á–∞—Ç–µ–ª—å</label>
              <select id="notifRecipient" class="w-full bg-gray-900/50 border border-gray-800 rounded-lg px-4 py-2 text-sm focus:outline-none focus:border-white">
                <option value="all">–í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</option>
              </select>
            </div>
            <div>
              <label class="block text-xs text-gray-500 mb-2 uppercase tracking-wide">–ó–∞–≥–æ–ª–æ–≤–æ–∫</label>
              <input type="text" id="notifTitle" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ù–æ–≤–æ—Å—Ç—å" 
                class="w-full bg-gray-900/50 border border-gray-800 rounded-lg px-4 py-2 text-sm focus:outline-none focus:border-white transition">
            </div>
            <div>
              <label class="block text-xs text-gray-500 mb-2 uppercase tracking-wide">–°–æ–æ–±—â–µ–Ω–∏–µ</label>
              <textarea id="notifMessage" rows="3" placeholder="–¢–µ–∫—Å—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è..." 
                class="w-full bg-gray-900/50 border border-gray-800 rounded-lg px-4 py-2 text-sm focus:outline-none focus:border-white transition"></textarea>
            </div>
            <div class="flex items-center gap-4">
              <label class="flex items-center gap-2 cursor-pointer">
                <input type="checkbox" id="sendTelegram" checked class="w-4 h-4 accent-white">
                <span class="text-sm text-gray-400">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ Telegram</span>
              </label>
            </div>
            <button onclick="sendNotification()" class="w-full bg-white text-black hover:bg-gray-200 py-3 rounded-xl font-medium transition">
              –û—Ç–ø—Ä–∞–≤–∏—Ç—å
            </button>
          </div>
        </div>
      </div>

      <!-- Promos Tab -->
      <div id="promosTab" class="tab-content hidden">
        <div class="glass rounded-xl p-6 mb-6">
          <h3 class="font-medium mb-4 text-gray-400 text-sm uppercase tracking-wide">–°–æ–∑–¥–∞—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥</h3>
          <div class="grid md:grid-cols-2 gap-4">
            <div>
              <label class="block text-xs text-gray-500 mb-2 uppercase tracking-wide">–ö–æ–¥</label>
              <input type="text" id="promoCode" placeholder="SUMMER2024"
                class="w-full bg-gray-900/50 border border-gray-800 rounded-lg px-4 py-2 text-sm focus:outline-none focus:border-white uppercase">
            </div>
            <div>
              <label class="block text-xs text-gray-500 mb-2 uppercase tracking-wide">–°–∫–∏–¥–∫–∞ (%)</label>
              <input type="number" id="promoDiscount" min="1" max="100" placeholder="10"
                class="w-full bg-gray-900/50 border border-gray-800 rounded-lg px-4 py-2 text-sm focus:outline-none focus:border-white">
            </div>
            <div>
              <label class="block text-xs text-gray-500 mb-2 uppercase tracking-wide">–ú–∞–∫—Å. –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–π (–æ–ø—Ü.)</label>
              <input type="number" id="promoMaxUses" min="1" placeholder="100"
                class="w-full bg-gray-900/50 border border-gray-800 rounded-lg px-4 py-2 text-sm focus:outline-none focus:border-white">
            </div>
            <div>
              <label class="block text-xs text-gray-500 mb-2 uppercase tracking-wide">–ò—Å—Ç–µ–∫–∞–µ—Ç (–æ–ø—Ü.)</label>
              <input type="datetime-local" id="promoExpires"
                class="w-full bg-gray-900/50 border border-gray-800 rounded-lg px-4 py-2 text-sm focus:outline-none focus:border-white">
            </div>
          </div>
          <button onclick="createPromo()" class="mt-4 w-full bg-white text-black hover:bg-gray-200 py-3 rounded-xl font-medium transition">
            –°–æ–∑–¥–∞—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥
          </button>
        </div>

        <div class="glass rounded-xl p-6">
          <h3 class="font-medium mb-4 text-gray-400 text-sm uppercase tracking-wide">–ê–∫—Ç–∏–≤–Ω—ã–µ –ø—Ä–æ–º–æ–∫–æ–¥—ã</h3>
          <div id="promosList" class="space-y-3">
            <div class="text-center text-gray-500 py-4">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
          </div>
        </div>
      </div>

      <!-- Withdrawals Tab -->
      <div id="withdrawalsTab" class="tab-content hidden">
        <div class="glass rounded-xl p-6">
          <div class="flex items-center justify-between mb-6">
            <h3 class="font-medium text-gray-400 text-sm uppercase tracking-wide">–ó–∞–ø—Ä–æ—Å—ã –Ω–∞ –≤—ã–ø–ª–∞—Ç—É</h3>
            <button onclick="loadWithdrawals()" class="text-gray-500 hover:text-white transition" title="–û–±–Ω–æ–≤–∏—Ç—å">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
              </svg>
            </button>
          </div>

          <div class="mb-4 flex gap-2">
            <select id="withdrawalStatusFilter" onchange="renderWithdrawals()" class="bg-gray-900/50 border border-gray-800 rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-white transition flex-1">
              <option value="">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
              <option value="pending">–í –æ–∂–∏–¥–∞–Ω–∏–∏</option>
              <option value="completed">–í—ã–ø–ª–∞—á–µ–Ω–æ</option>
              <option value="cancelled">–û—Ç–º–µ–Ω–µ–Ω–æ</option>
            </select>
            <select id="withdrawalTypeFilter" onchange="renderWithdrawals()" class="bg-gray-900/50 border border-gray-800 rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-white transition flex-1">
              <option value="">–í—Å–µ —Ç–∏–ø—ã</option>
              <option value="cashback">–ö–µ—à–±—ç–∫</option>
              <option value="referral">–†–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–π</option>
            </select>
          </div>

          <div id="withdrawalsList" class="space-y-3">
            <div class="text-center text-gray-500 py-12">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
          </div>
        </div>
      </div>

      <!-- Settings Tab -->
      <div id="settingsTab" class="tab-content hidden">
        <!-- Products (Catalog) Management -->
        <div class="glass rounded-xl p-6 mb-6">
          <div class="flex items-center justify-between mb-4">
            <h3 class="font-medium text-gray-400 text-sm uppercase tracking-wide">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–∞—Ç–∞–ª–æ–≥–æ–º</h3>
            <button onclick="addProduct()" class="bg-white text-black hover:bg-gray-200 px-4 py-2 rounded-lg text-sm font-medium transition">
              + –î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä
            </button>
          </div>
          <div id="productsList" class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="col-span-full text-center text-gray-500 py-4">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
          </div>
        </div>

        <!-- Services Management -->
        <div class="glass rounded-xl p-6 mb-6">
          <div class="flex items-center justify-between mb-4">
            <h3 class="font-medium text-gray-400 text-sm uppercase tracking-wide">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —É—Å–ª—É–≥–∞–º–∏</h3>
            <button onclick="addService()" class="bg-white text-black hover:bg-gray-200 px-4 py-2 rounded-lg text-sm font-medium transition">
              + –î–æ–±–∞–≤–∏—Ç—å —É—Å–ª—É–≥—É
            </button>
          </div>
          <div id="servicesList" class="space-y-3">
            <div class="text-center text-gray-500 py-4">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
          </div>
        </div>

        <div class="grid md:grid-cols-2 gap-6">
          <div class="glass rounded-xl p-6">
            <h3 class="font-medium mb-4 text-gray-400 text-sm uppercase tracking-wide">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ API</h3>
            <div class="space-y-4">
              <div>
                <label class="block text-xs text-gray-500 mb-2 uppercase tracking-wide">API URL</label>
                <input type="text" id="settingsApiUrl" 
                  class="w-full bg-gray-900/50 border border-gray-800 rounded-lg px-4 py-2 text-sm focus:outline-none focus:border-white transition">
              </div>
              <div>
                <label class="block text-xs text-gray-500 mb-2 uppercase tracking-wide">Admin Key</label>
                <input type="password" id="settingsAdminKey" 
                  class="w-full bg-gray-900/50 border border-gray-800 rounded-lg px-4 py-2 text-sm focus:outline-none focus:border-white transition">
              </div>
              <button onclick="saveSettings()" class="bg-white text-black hover:bg-gray-200 px-4 py-2 rounded-lg text-sm font-medium transition">
                –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
              </button>
            </div>
          </div>

          <div class="glass rounded-xl p-6">
            <h3 class="font-medium mb-4 text-gray-400 text-sm uppercase tracking-wide">–ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è</h3>
            <div class="space-y-2">
              <button onclick="exportOrders()" class="w-full bg-gray-900/50 hover:bg-gray-800 px-4 py-3 rounded-lg transition text-left text-sm flex items-center gap-3">
                <span class="text-gray-400">‚Üì</span> –≠–∫—Å–ø–æ—Ä—Ç –∑–∞–∫–∞–∑–æ–≤ –≤ CSV
              </button>
              <button onclick="exportUsers()" class="w-full bg-gray-900/50 hover:bg-gray-800 px-4 py-3 rounded-lg transition text-left text-sm flex items-center gap-3">
                <span class="text-gray-400">‚Üì</span> –≠–∫—Å–ø–æ—Ä—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ CSV
              </button>
              <button onclick="refreshAllData()" class="w-full bg-gray-900/50 hover:bg-gray-800 px-4 py-3 rounded-lg transition text-left text-sm flex items-center gap-3">
                <span class="text-gray-400">‚Üª</span> –û–±–Ω–æ–≤–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ
              </button>
            </div>
          </div>

          <div class="glass rounded-xl p-6 md:col-span-2">
            <h3 class="font-medium mb-4 text-gray-400 text-sm uppercase tracking-wide">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h3>
            <div class="bg-gray-900/50 rounded-lg p-4 text-sm text-gray-400">
              <p class="mb-2">‚úÖ –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å —É—Å–ø–µ—à–Ω–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∞ –∫ —Å–µ—Ä–≤–µ—Ä—É</p>
              <p class="mb-2">üìä API URL: <code id="currentApiUrl" class="text-gray-300"></code></p>
              <p>üîî –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è –≤ Telegram –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏</p>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- Order Detail Modal -->
  <div id="orderModal" class="fixed inset-0 bg-black/90 z-50 hidden items-center justify-center p-4">
    <div class="glass rounded-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto border border-gray-800">
      <div class="sticky top-0 glass p-4 border-b border-gray-800 flex items-center justify-between">
        <h3 class="font-medium">–î–µ—Ç–∞–ª–∏ –∑–∞–∫–∞–∑–∞</h3>
        <button onclick="closeOrderModal()" class="text-gray-500 hover:text-white">‚úï</button>
      </div>
      <div id="orderModalContent" class="p-6">
        <!-- Content loaded dynamically -->
      </div>
    </div>
  </div>

  <!-- User Activity Modal -->
  <div id="activityModal" class="fixed inset-0 bg-black/90 z-50 hidden items-center justify-center p-4">
    <div class="glass rounded-2xl w-full max-w-4xl max-h-[90vh] overflow-y-auto border border-gray-800">
      <div class="sticky top-0 glass p-4 border-b border-gray-800 flex items-center justify-between">
        <h3 class="font-medium">–ò—Å—Ç–æ—Ä–∏—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h3>
        <button onclick="closeActivityModal()" class="text-gray-500 hover:text-white">‚úï</button>
      </div>
      <div id="activityModalContent" class="p-6">
        <!-- Content loaded dynamically -->
      </div>
    </div>
  </div>

  <!-- Toast Container -->
  <div id="toastContainer" class="fixed bottom-4 right-4 z-50 space-y-2"></div>

  <script>
    // State
    let apiUrl = localStorage.getItem('apiUrl') || '';
    let adminKey = localStorage.getItem('adminKey') || '';
    let ordersData = [];
    let usersData = [];
    let referralsData = [];

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      // Pre-fill saved values
      if (apiUrl) document.getElementById('apiUrl').value = apiUrl;
      if (adminKey) {
        document.getElementById('adminKey').value = adminKey;
        login(); // Auto-login
      }
    });

    // Auth
    async function login() {
      const urlInput = document.getElementById('apiUrl').value.trim().replace(/\/$/, '');
      const key = document.getElementById('adminKey').value.trim();
      
      if (!key) {
        showError('–í–≤–µ–¥–∏—Ç–µ Admin Key');
        return;
      }
      
      // Use current origin if URL is empty (same-server deployment)
      const effectiveUrl = urlInput || window.location.origin;
      
      const loginBtn = document.getElementById('loginBtn');
      const loginInfo = document.getElementById('loginInfo');
      
      // Show loading state
      loginBtn.disabled = true;
      loginBtn.innerHTML = '<span class="spinner"></span><span>–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...</span>';
      loginInfo.textContent = `–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ ${effectiveUrl}...`;
      loginInfo.classList.remove('hidden');
      hideError();
      
      try {
        // First, try health check
        let serverReachable = false;
        try {
          const healthResponse = await fetchWithTimeout(`${effectiveUrl}/health`, {}, 5000);
          serverReachable = healthResponse.ok;
          if (serverReachable) {
            loginInfo.textContent = '–°–µ—Ä–≤–µ—Ä –¥–æ—Å—Ç—É–ø–µ–Ω, –ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–ª—é—á–∞...';
          }
        } catch (e) {
          console.log('Health check failed:', e.message);
          loginInfo.textContent = '–ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏...';
        }
        
        // Try to authenticate with admin endpoint
        const response = await fetchWithTimeout(`${effectiveUrl}/api/admin/stats`, {
          method: 'GET',
          headers: {
            'X-Admin-Key': key,
            'Content-Type': 'application/json'
          }
        }, 10000);
        
        if (response.status === 401) {
          showError('–ù–µ–≤–µ—Ä–Ω—ã–π Admin Key');
          return;
        }
        
        if (!response.ok) {
          showError(`–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${response.status} ${response.statusText}`);
          return;
        }
        
        // Success! Save credentials
        apiUrl = effectiveUrl;
        adminKey = key;
        localStorage.setItem('apiUrl', urlInput); // Save original input
        localStorage.setItem('adminKey', adminKey);
        
        // Show admin panel
        document.getElementById('loginScreen').classList.add('hidden');
        document.getElementById('adminPanel').classList.remove('hidden');
        
        // Update settings fields
        document.getElementById('settingsApiUrl').value = effectiveUrl;
        document.getElementById('settingsAdminKey').value = adminKey;
        document.getElementById('currentApiUrl').textContent = effectiveUrl;
        
        // Load all data
        refreshAllData();
        
      } catch (error) {
        console.error('Login error:', error);
        
        // Provide helpful error messages
        if (error.name === 'AbortError') {
          showError('–¢–∞–π–º–∞—É—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è. –°–µ—Ä–≤–µ—Ä –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç.\n\n–ü—Ä–æ–≤–µ—Ä—å—Ç–µ:\n‚Ä¢ –ó–∞–ø—É—â–µ–Ω –ª–∏ —Å–µ—Ä–≤–µ—Ä (node server.js)\n‚Ä¢ –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –ª–∏ URL: ' + effectiveUrl);
        } else if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError') || error.message.includes('fetch')) {
          showError(`–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É.\n\n–ü—Ä–æ–≤–µ—Ä—å—Ç–µ:\n‚Ä¢ –ó–∞–ø—É—â–µ–Ω –ª–∏ —Å–µ—Ä–≤–µ—Ä\n‚Ä¢ URL: ${effectiveUrl}\n‚Ä¢ –ù–µ—Ç –ª–∏ CORS –æ—à–∏–±–æ–∫ –≤ –∫–æ–Ω—Å–æ–ª–∏`);
        } else {
          showError('–û—à–∏–±–∫–∞: ' + error.message);
        }
      } finally {
        loginBtn.disabled = false;
        loginBtn.innerHTML = '<span>–í–æ–π—Ç–∏</span>';
        loginInfo.classList.add('hidden');
      }
    }

    // Fetch with timeout helper
    function fetchWithTimeout(url, options = {}, timeout = 10000) {
      return Promise.race([
        fetch(url, options),
        new Promise((_, reject) => 
          setTimeout(() => reject(new Error('AbortError')), timeout)
        )
      ]);
    }

    function logout() {
      localStorage.removeItem('apiUrl');
      localStorage.removeItem('adminKey');
      location.reload();
    }

    function showError(msg) {
      const el = document.getElementById('loginError');
      el.innerHTML = msg.replace(/\n/g, '<br>');
      el.classList.remove('hidden');
    }

    function hideError() {
      document.getElementById('loginError').classList.add('hidden');
    }

    // API Calls
    async function apiCall(endpoint, method = 'GET', body = null) {
      const options = {
        method,
        headers: {
          'Content-Type': 'application/json',
          'X-Admin-Key': adminKey
        }
      };
      
      if (body) {
        options.body = JSON.stringify(body);
      }
      
      const response = await fetch(`${apiUrl}${endpoint}`, options);
      
      if (!response.ok) {
        throw new Error(`API Error: ${response.status}`);
      }
      
      return response.json();
    }

    // Load Data
    async function loadOrders() {
      try {
        ordersData = await apiCall('/api/admin/orders');
        renderOrders();
        updateStats();
      } catch (error) {
        console.error('Error loading orders:', error);
        document.getElementById('ordersList').innerHTML = `
          <div class="text-center text-gray-500 py-12">
            <div class="text-2xl mb-2">‚ö†Ô∏è</div>
            –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∑–∞–∫–∞–∑—ã<br>
            <small class="text-gray-600">${error.message}</small>
          </div>`;
      }
    }

    async function loadUsers() {
      try {
        usersData = await apiCall('/api/admin/users');
        renderUsers();
        updateStats();
        updateNotifRecipients();
      } catch (error) {
        console.error('Error loading users:', error);
        document.getElementById('usersList').innerHTML = `
          <div class="text-center text-gray-500 py-12">
            <div class="text-2xl mb-2">‚ö†Ô∏è</div>
            –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π<br>
            <small class="text-gray-600">${error.message}</small>
          </div>`;
      }
    }

    async function loadReferrals() {
      try {
        referralsData = await apiCall('/api/admin/referrals');
        renderReferrals();
      } catch (error) {
        console.error('Error loading referrals:', error);
      }
    }

    // Services Management
    let servicesData = [];

    async function loadServices() {
      try {
        const settings = await apiCall('/api/settings');
        servicesData = settings.services || [];
        renderServices();
      } catch (error) {
        console.error('Error loading services:', error);
        showToast('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —É—Å–ª—É–≥', 'error');
      }
    }

    function renderServices() {
      const container = document.getElementById('servicesList');
      if (!servicesData || servicesData.length === 0) {
        container.innerHTML = '<div class="text-center text-gray-500 py-4">–ù–µ—Ç —É—Å–ª—É–≥</div>';
        return;
      }

      container.innerHTML = servicesData.map((service, index) => `
        <div class="bg-gray-900/50 rounded-lg p-4 flex items-center gap-4">
          <div class="flex-1">
            <input type="text" value="${service.name}"
              onchange="updateServiceField(${index}, 'name', this.value)"
              class="bg-transparent border-b border-gray-700 focus:border-white outline-none text-sm font-medium mb-1 w-full"
              placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —É—Å–ª—É–≥–∏">
            <input type="text" value="${service.desc}"
              onchange="updateServiceField(${index}, 'desc', this.value)"
              class="bg-transparent border-b border-gray-700 focus:border-white outline-none text-xs text-gray-400 w-full"
              placeholder="–û–ø–∏—Å–∞–Ω–∏–µ">
          </div>
          <div class="w-24">
            <input type="number" value="${service.price}"
              onchange="updateServiceField(${index}, 'price', parseFloat(this.value))"
              class="bg-gray-800 border border-gray-700 rounded px-3 py-2 text-sm w-full focus:outline-none focus:border-white"
              placeholder="–¶–µ–Ω–∞">
          </div>
          <button onclick="deleteService(${index})"
            class="text-red-400 hover:text-red-300 transition"
            title="–£–¥–∞–ª–∏—Ç—å">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
            </svg>
          </button>
        </div>
      `).join('');
    }

    function updateServiceField(index, field, value) {
      servicesData[index][field] = value;
      saveServices();
    }

    function addService() {
      servicesData.push({
        name: '–ù–æ–≤–∞—è —É—Å–ª—É–≥–∞',
        desc: '–û–ø–∏—Å–∞–Ω–∏–µ',
        price: 10
      });
      renderServices();
      saveServices();
    }

    function deleteService(index) {
      if (confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç—É —É—Å–ª—É–≥—É?')) {
        servicesData.splice(index, 1);
        renderServices();
        saveServices();
      }
    }

    async function saveServices() {
      try {
        await apiCall('/api/admin/settings', 'POST', {
          services: servicesData,
          prices: {},
          form_fields: []
        });
        showToast('–£—Å–ª—É–≥–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã', 'success');
      } catch (error) {
        console.error('Error saving services:', error);
        showToast('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ' + error.message, 'error');
      }
    }

    // Products (Catalog) Management
    let productsData = [];

    async function loadProducts() {
      try {
        productsData = await apiCall('/api/admin/products');
        renderProducts();
      } catch (error) {
        console.error('Error loading products:', error);
        showToast('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ç–∞–ª–æ–≥–∞', 'error');
      }
    }

    function renderProducts() {
      const container = document.getElementById('productsList');
      if (!productsData || productsData.length === 0) {
        container.innerHTML = '<div class="col-span-full text-center text-gray-500 py-4">–ù–µ—Ç —Ç–æ–≤–∞—Ä–æ–≤</div>';
        return;
      }

      container.innerHTML = productsData.map(product => `
        <div class="bg-gray-900/50 rounded-lg p-4">
          <div class="flex gap-4 mb-4">
            <div class="w-16 h-16 bg-gradient-to-br from-gray-800 to-black rounded-xl flex items-center justify-center text-3xl flex-shrink-0">
              <input type="text" value="${product.icon}" maxlength="2"
                onchange="updateProductField(${product.id}, 'icon', this.value)"
                class="bg-transparent text-center w-full outline-none"
                title="–≠–º–æ–¥–∑–∏ –∏–∫–æ–Ω–∫–∞">
            </div>
            <div class="flex-1">
              <input type="text" value="${product.name}"
                onchange="updateProductField(${product.id}, 'name', this.value)"
                class="bg-transparent border-b border-gray-700 focus:border-white outline-none text-sm font-medium mb-2 w-full"
                placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞">
              <input type="text" value="${product.description || ''}"
                onchange="updateProductField(${product.id}, 'description', this.value)"
                class="bg-transparent border-b border-gray-700 focus:border-white outline-none text-xs text-gray-400 w-full"
                placeholder="–û–ø–∏—Å–∞–Ω–∏–µ">
            </div>
          </div>
          <div class="flex items-center gap-3">
            <div class="flex-1">
              <label class="block text-xs text-gray-500 mb-1">–¶–µ–Ω–∞ ($)</label>
              <input type="number" value="${product.price}"
                onchange="updateProductField(${product.id}, 'price', parseFloat(this.value))"
                class="bg-gray-800 border border-gray-700 rounded px-3 py-2 text-sm w-full focus:outline-none focus:border-white">
            </div>
            <div class="flex-1">
              <label class="block text-xs text-gray-500 mb-1">–ü–æ—Ä—è–¥–æ–∫</label>
              <input type="number" value="${product.sort_order || 0}"
                onchange="updateProductField(${product.id}, 'sort_order', parseInt(this.value))"
                class="bg-gray-800 border border-gray-700 rounded px-3 py-2 text-sm w-full focus:outline-none focus:border-white">
            </div>
            <div class="flex items-end gap-2">
              <label class="flex items-center gap-2 cursor-pointer">
                <input type="checkbox" ${product.is_active ? 'checked' : ''}
                  onchange="updateProductField(${product.id}, 'is_active', this.checked ? 1 : 0)"
                  class="rounded">
                <span class="text-xs text-gray-400">–ê–∫—Ç–∏–≤–µ–Ω</span>
              </label>
              <button onclick="deleteProduct(${product.id})"
                class="text-red-400 hover:text-red-300 transition p-2"
                title="–£–¥–∞–ª–∏—Ç—å">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                </svg>
              </button>
            </div>
          </div>
        </div>
      `).join('');
    }

    async function updateProductField(id, field, value) {
      try {
        const product = productsData.find(p => p.id === id);
        if (!product) return;

        product[field] = value;
        await apiCall(`/api/admin/products/${id}`, 'PUT', product);
        showToast('–¢–æ–≤–∞—Ä –æ–±–Ω–æ–≤–ª–µ–Ω', 'success');
        await loadProducts();
      } catch (error) {
        console.error('Error updating product:', error);
        showToast('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è: ' + error.message, 'error');
      }
    }

    async function addProduct() {
      try {
        const maxSortOrder = productsData.reduce((max, p) => Math.max(max, p.sort_order || 0), 0);
        const newProduct = {
          name: '–ù–æ–≤—ã–π —Ç–æ–≤–∞—Ä',
          description: '–û–ø–∏—Å–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞',
          price: 10,
          icon: 'üé®',
          sort_order: maxSortOrder + 1
        };

        await apiCall('/api/admin/products', 'POST', newProduct);
        showToast('–¢–æ–≤–∞—Ä –¥–æ–±–∞–≤–ª–µ–Ω', 'success');
        await loadProducts();
      } catch (error) {
        console.error('Error adding product:', error);
        showToast('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è: ' + error.message, 'error');
      }
    }

    async function deleteProduct(id) {
      if (!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —Ç–æ–≤–∞—Ä?')) return;

      try {
        await apiCall(`/api/admin/products/${id}`, 'DELETE');
        showToast('–¢–æ–≤–∞—Ä —É–¥–∞–ª–µ–Ω', 'success');
        await loadProducts();
      } catch (error) {
        console.error('Error deleting product:', error);
        showToast('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: ' + error.message, 'error');
      }
    }

    // Promo Codes Management
    let promosData = [];

    async function loadPromos() {
      try {
        promosData = await apiCall('/api/admin/promos');
        renderPromos();
      } catch (error) {
        console.error('Error loading promos:', error);
        showToast('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤', 'error');
      }
    }

    function renderPromos() {
      const container = document.getElementById('promosList');
      if (!promosData || promosData.length === 0) {
        container.innerHTML = '<div class="text-center text-gray-500 py-4">–ù–µ—Ç –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤</div>';
        return;
      }

      container.innerHTML = promosData.map(promo => {
        const expired = promo.expires_at && new Date(promo.expires_at) < new Date();
        const exhausted = promo.max_uses && promo.current_uses >= promo.max_uses;
        const statusText = expired ? '‚ùå –ò—Å—Ç—ë–∫' : exhausted ? '‚ùå –ò—Å—á–µ—Ä–ø–∞–Ω' : promo.is_active ? '‚úÖ –ê–∫—Ç–∏–≤–µ–Ω' : '‚ùå –ù–µ–∞–∫—Ç–∏–≤–µ–Ω';

        return `
          <div class="bg-gray-900/50 rounded-lg p-4 border border-gray-800">
            <div class="flex items-center justify-between">
              <div>
                <div class="flex items-center gap-3 mb-2">
                  <span class="font-mono text-lg font-bold">${promo.code}</span>
                  <span class="text-sm px-2 py-1 rounded-full ${expired || exhausted ? 'bg-red-500/20 text-red-400' : 'bg-green-500/20 text-green-400'}">
                    ${statusText}
                  </span>
                </div>
                <div class="text-sm text-gray-400 space-y-1">
                  <div>–°–∫–∏–¥–∫–∞: <span class="text-white font-medium">${promo.discount_percent}%</span></div>
                  <div>–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ: <span class="text-white">${promo.current_uses}</span> ${promo.max_uses ? `–∏–∑ ${promo.max_uses}` : ''}</div>
                  ${promo.expires_at ? `<div>–ò—Å—Ç–µ–∫–∞–µ—Ç: <span class="text-white">${new Date(promo.expires_at).toLocaleString('ru-RU')}</span></div>` : ''}
                  <div class="text-xs text-gray-600">–°–æ–∑–¥–∞–Ω: ${new Date(promo.created_at).toLocaleString('ru-RU')}</div>
                </div>
              </div>
              <button onclick="deletePromo(${promo.id})" class="text-red-400 hover:text-red-300 transition px-3 py-2" title="–£–¥–∞–ª–∏—Ç—å">
                üóëÔ∏è
              </button>
            </div>
          </div>
        `;
      }).join('');
    }

    async function createPromo() {
      const code = document.getElementById('promoCode').value.trim().toUpperCase();
      const discount = parseInt(document.getElementById('promoDiscount').value);
      const maxUses = document.getElementById('promoMaxUses').value ? parseInt(document.getElementById('promoMaxUses').value) : null;
      const expires = document.getElementById('promoExpires').value || null;

      if (!code) {
        showToast('–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –ø—Ä–æ–º–æ–∫–æ–¥–∞', 'error');
        return;
      }

      if (!discount || discount < 1 || discount > 100) {
        showToast('–°–∫–∏–¥–∫–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –æ—Ç 1 –¥–æ 100%', 'error');
        return;
      }

      try {
        await apiCall('/api/admin/promos', 'POST', {
          code,
          discount_percent: discount,
          max_uses: maxUses,
          expires_at: expires
        });

        showToast('–ü—Ä–æ–º–æ–∫–æ–¥ —Å–æ–∑–¥–∞–Ω!', 'success');

        // Clear form
        document.getElementById('promoCode').value = '';
        document.getElementById('promoDiscount').value = '';
        document.getElementById('promoMaxUses').value = '';
        document.getElementById('promoExpires').value = '';

        loadPromos();
      } catch (error) {
        showToast('–û—à–∏–±–∫–∞: ' + error.message, 'error');
      }
    }

    async function deletePromo(id) {
      if (!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –ø—Ä–æ–º–æ–∫–æ–¥?')) return;

      try {
        await apiCall(`/api/admin/promos/${id}`, 'DELETE');
        showToast('–ü—Ä–æ–º–æ–∫–æ–¥ —É–¥–∞–ª—ë–Ω', 'success');
        loadPromos();
      } catch (error) {
        showToast('–û—à–∏–±–∫–∞: ' + error.message, 'error');
      }
    }

    // Withdrawals Management
    let withdrawalsData = [];

    async function loadWithdrawals() {
      try {
        withdrawalsData = await apiCall('/api/admin/withdrawals');
        renderWithdrawals();
      } catch (error) {
        console.error('Error loading withdrawals:', error);
        showToast('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≤—ã–ø–ª–∞—Ç', 'error');
      }
    }

    function renderWithdrawals() {
      const container = document.getElementById('withdrawalsList');
      const statusFilter = document.getElementById('withdrawalStatusFilter').value;
      const typeFilter = document.getElementById('withdrawalTypeFilter').value;

      let filtered = withdrawalsData.filter(w => {
        const matchStatus = !statusFilter || w.status === statusFilter;
        const matchType = !typeFilter || w.type === typeFilter;
        return matchStatus && matchType;
      });

      if (filtered.length === 0) {
        container.innerHTML = '<div class="text-center text-gray-500 py-12">–ù–µ—Ç –∑–∞–ø—Ä–æ—Å–æ–≤ –Ω–∞ –≤—ã–ø–ª–∞—Ç—É</div>';
        return;
      }

      container.innerHTML = filtered.map(w => {
        const statusColors = {
          pending: 'bg-yellow-500/20 text-yellow-400 border-yellow-500/30',
          completed: 'bg-green-500/20 text-green-400 border-green-500/30',
          cancelled: 'bg-red-500/20 text-red-400 border-red-500/30'
        };

        const statusText = {
          pending: '–í –æ–∂–∏–¥–∞–Ω–∏–∏',
          completed: '–í—ã–ø–ª–∞—á–µ–Ω–æ',
          cancelled: '–û—Ç–º–µ–Ω–µ–Ω–æ'
        };

        const typeText = w.type === 'cashback' ? 'üí∞ –ö–µ—à–±—ç–∫' : 'üë• –†–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–π';
        const statusClass = statusColors[w.status] || 'bg-gray-500/20 text-gray-400';

        return `
          <div class="glass rounded-xl p-4 border border-gray-800/50">
            <div class="flex items-start justify-between mb-3">
              <div class="flex-1">
                <div class="flex items-center gap-2 mb-2">
                  <span class="text-sm font-medium">${w.user_name || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'}</span>
                  <span class="text-xs text-gray-600">@${w.username || '–Ω–µ—Ç'}</span>
                  <span class="${statusClass} px-2 py-0.5 rounded-full text-xs font-medium border">${statusText[w.status]}</span>
                </div>
                <div class="text-xs text-gray-500 space-y-1">
                  <div>ID: ${w.telegram_id}</div>
                  <div>${typeText} ¬∑ –ó–∞–ø—Ä–æ—Å #${w.id}</div>
                  <div>üí≥ –ö–æ—à–µ–ª–µ–∫: <span class="font-mono">${w.wallet_address}</span></div>
                  <div class="text-gray-600">–°–æ–∑–¥–∞–Ω: ${formatDate(w.created_at)}</div>
                  ${w.tx_hash ? `<div class="text-gray-600">TxHash: ${w.tx_hash.substring(0, 20)}...</div>` : ''}
                </div>
              </div>
              <div class="text-right">
                <div class="text-2xl font-bold text-green-400 mb-1">$${w.amount.toFixed(2)}</div>
                ${w.status === 'pending' ? `
                  <div class="text-xs text-gray-500 mb-2">
                    <div>–ë–∞–ª–∞–Ω—Å –∫–µ—à–±—ç–∫: $${(w.cashback || 0).toFixed(2)}</div>
                    <div>–ë–∞–ª–∞–Ω—Å —Ä–µ—Ñ: $${(w.referral_earnings || 0).toFixed(2)}</div>
                  </div>
                  <button onclick="processWithdrawal(${w.id})" class="w-full bg-green-600 hover:bg-green-700 text-white px-3 py-2 rounded-lg text-xs font-medium mb-1 transition">
                    ‚úÖ –í—ã–ø–ª–∞—Ç–∏—Ç—å
                  </button>
                  <button onclick="cancelWithdrawal(${w.id})" class="w-full bg-red-600 hover:bg-red-700 text-white px-3 py-2 rounded-lg text-xs font-medium transition">
                    ‚ùå –û—Ç–º–µ–Ω–∏—Ç—å
                  </button>
                ` : w.processed_at ? `
                  <div class="text-xs text-gray-600">–û–±—Ä–∞–±–æ—Ç–∞–Ω: ${formatDate(w.processed_at)}</div>
                ` : ''}
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    async function processWithdrawal(id) {
      const withdrawal = withdrawalsData.find(w => w.id === id);
      if (!withdrawal) return;

      const txHash = prompt(
        `–í—ã–ø–ª–∞—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é ${withdrawal.user_name}\n` +
        `–°—É–º–º–∞: $${withdrawal.amount}\n` +
        `–ö–æ—à–µ–ª–µ–∫: ${withdrawal.wallet_address}\n\n` +
        `–í–≤–µ–¥–∏—Ç–µ TxHash —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ (–∏–ª–∏ –æ—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º):`
      );

      if (txHash === null) return; // Cancel

      try {
        await apiCall(`/api/admin/withdrawals/${id}/process`, 'POST', { tx_hash: txHash || null });
        showToast('–í—ã–ø–ª–∞—Ç–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞!', 'success');
        await Promise.all([loadWithdrawals(), loadUsers()]);
      } catch (error) {
        showToast('–û—à–∏–±–∫–∞: ' + error.message, 'error');
      }
    }

    async function cancelWithdrawal(id) {
      const withdrawal = withdrawalsData.find(w => w.id === id);
      if (!withdrawal) return;

      const reason = prompt(
        `–û—Ç–º–µ–Ω–∞ –≤—ã–ø–ª–∞—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é ${withdrawal.user_name}\n` +
        `–°—É–º–º–∞: $${withdrawal.amount}\n\n` +
        `–í–≤–µ–¥–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É –æ—Ç–º–µ–Ω—ã:`
      );

      if (!reason) return;

      try {
        await apiCall(`/api/admin/withdrawals/${id}/cancel`, 'POST', { reason });
        showToast('–í—ã–ø–ª–∞—Ç–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞', 'success');
        await loadWithdrawals();
      } catch (error) {
        showToast('–û—à–∏–±–∫–∞: ' + error.message, 'error');
      }
    }

    async function addCashback(userId, userName) {
      const amount = prompt(`–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É –∫–µ—à–±–µ–∫–∞ –¥–ª—è ${userName}:\n(–ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ–µ —á–∏—Å–ª–æ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è, –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–æ–µ –¥–ª—è –≤—ã—á–∏—Ç–∞–Ω–∏—è)`);
      if (!amount) return;

      const amountNum = parseFloat(amount);
      if (isNaN(amountNum)) {
        showToast('–ù–µ–≤–µ—Ä–Ω–∞—è —Å—É–º–º–∞', 'error');
        return;
      }

      try {
        await apiCall(`/api/admin/users/${userId}/cashback`, 'POST', { amount: amountNum });
        showToast(`–ö–µ—à–±–µ–∫ –æ–±–Ω–æ–≤–ª—ë–Ω: ${amountNum > 0 ? '+' : ''}$${amountNum.toFixed(2)}`, 'success');
        loadUsers();
      } catch (error) {
        showToast('–û—à–∏–±–∫–∞: ' + error.message, 'error');
      }
    }

    async function refreshAllData() {
      showToast('–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö...', 'info');
      await Promise.all([loadOrders(), loadUsers(), loadReferrals(), loadServices(), loadProducts(), loadPromos(), loadWithdrawals()]);
      showToast('–î–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω—ã', 'success');
    }

    // Render Functions
    function renderOrders() {
      const search = document.getElementById('orderSearch').value.toLowerCase();
      const statusFilter = document.getElementById('orderStatusFilter').value;
      
      let filtered = ordersData.filter(o => {
        const matchSearch = !search || 
          o.id.toLowerCase().includes(search) ||
          (o.user_name && o.user_name.toLowerCase().includes(search)) ||
          (o.username && o.username.toLowerCase().includes(search));
        const matchStatus = !statusFilter || o.status === statusFilter;
        return matchSearch && matchStatus;
      });
      
      if (filtered.length === 0) {
        document.getElementById('ordersList').innerHTML = `
          <div class="text-center text-gray-500 py-12">–ó–∞–∫–∞–∑—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>`;
        return;
      }
      
      document.getElementById('ordersList').innerHTML = filtered.map(order => {
        // Determine order type
        let orderType = '';
        let orderDetails = '';
        let isCartOrder = false;

        try {
          if (order.items && typeof order.items === 'string') {
            const items = JSON.parse(order.items);
            if (Array.isArray(items) && items.length > 0) {
              isCartOrder = true;
              orderType = '<span class="px-2 py-0.5 bg-purple-500/20 text-purple-400 rounded text-xs font-medium border border-purple-500/30">üì¶ –ö–∞—Ç–∞–ª–æ–≥</span>';
              const itemsList = items.map(item => `${item.name} x${item.quantity}`).join(', ');
              orderDetails = `<div class="text-gray-500">${itemsList}</div>`;
            }
          }
        } catch (e) {
          // Not a cart order
        }

        if (!isCartOrder) {
          orderType = '<span class="px-2 py-0.5 bg-blue-500/20 text-blue-400 rounded text-xs font-medium border border-blue-500/30">üé® –£—Å–ª—É–≥–∞</span>';
          orderDetails = `<div class="text-gray-500">${order.service} ¬∑ ${order.niche}</div>`;
        }

        return `
          <div class="order-card glass rounded-xl p-4 transition cursor-pointer fade-in border border-gray-800/50 hover:border-gray-700" onclick="openOrderModal('${order.id}')">
            <div class="flex flex-wrap items-start justify-between gap-4">
              <div class="flex-1 min-w-[200px]">
                <div class="flex items-center gap-2 mb-2 flex-wrap">
                  <span class="font-mono text-sm text-gray-400">#${order.id}</span>
                  ${orderType}
                  <span class="status-${order.status} px-2 py-0.5 rounded-full text-xs font-medium">
                    ${getStatusText(order.status)}
                  </span>
                </div>
                <div class="text-gray-400 text-sm space-y-1">
                  <div>${order.user_name || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'} ${order.username ? `@${order.username}` : ''}</div>
                  ${orderDetails}
                  <div class="text-gray-600">${formatDate(order.created_at)}</div>
                </div>
              </div>
              <div class="text-right">
                <div class="text-xl font-medium">$${order.total}</div>
                <div class="text-xs text-gray-600">${order.payment_method || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}</div>
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    function renderUsers() {
      const search = document.getElementById('userSearch').value.toLowerCase();
      
      let filtered = usersData.filter(u => {
        return !search || 
          (u.name && u.name.toLowerCase().includes(search)) ||
          (u.username && u.username.toLowerCase().includes(search));
      });
      
      if (filtered.length === 0) {
        document.getElementById('usersList').innerHTML = '<div class="text-center text-gray-500 py-12">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';
        return;
      }
      
      document.getElementById('usersList').innerHTML = filtered.map(user => `
        <div class="glass rounded-xl p-4 fade-in border border-gray-800/50">
          <div class="flex flex-wrap items-center justify-between gap-4">
            <div class="flex items-center gap-4">
              <div class="w-10 h-10 bg-gray-800 rounded-full flex items-center justify-center text-sm font-medium">
                ${(user.name || 'U').charAt(0).toUpperCase()}
              </div>
              <div>
                <div class="font-medium">${user.name || '–ë–µ–∑ –∏–º–µ–Ω–∏'}</div>
                <div class="text-sm text-gray-500">@${user.username || '–Ω–µ—Ç username'}</div>
                <div class="text-xs text-gray-600">ID: ${user.telegram_id}</div>
              </div>
            </div>
            <div class="flex items-center gap-6 text-sm">
              <div class="text-center">
                <div class="text-sm font-medium ${getLevelColor(user.level)}">${(user.level || 'none').toUpperCase()}</div>
                <div class="text-xs text-gray-600">–£—Ä–æ–≤–µ–Ω—å</div>
              </div>
              <div class="text-center">
                <div class="text-sm font-medium text-white">$${user.total_spent || 0}</div>
                <div class="text-xs text-gray-600">–ü–æ—Ç—Ä–∞—á–µ–Ω–æ</div>
              </div>
              <div class="text-center">
                <div class="text-sm font-medium text-gray-400">$${(user.cashback || 0).toFixed(2)}</div>
                <div class="text-xs text-gray-600">–ö–µ—à–±—ç–∫</div>
              </div>
              <button onclick="sendMessageToUser(${user.id}, '${user.name || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'}')" class="bg-gray-800 hover:bg-gray-700 px-3 py-2 rounded-lg text-sm transition" title="–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ">
                ‚úâ
              </button>
              <button onclick="addCashback(${user.id}, '${user.name || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'}')" class="bg-green-800 hover:bg-green-700 px-3 py-2 rounded-lg text-sm transition" title="–î–æ–±–∞–≤–∏—Ç—å –∫–µ—à–±–µ–∫">
                üí∞
              </button>
              <button onclick="showUserActivity(${user.id}, '${user.name || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'}')" class="bg-blue-800 hover:bg-blue-700 px-3 py-2 rounded-lg text-sm transition" title="–ò—Å—Ç–æ—Ä–∏—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏">
                üìä
              </button>
            </div>
          </div>
        </div>
      `).join('');
    }

    function renderReferrals() {
      const pending = referralsData.filter(r => r.earnings > 0);
      
      document.getElementById('pendingPayouts').innerHTML = pending.length > 0 ? pending.map(r => `
        <div class="bg-gray-900/50 rounded-lg p-3 flex items-center justify-between border border-gray-800">
          <div>
            <div class="font-medium text-sm">${r.referrer_name}</div>
            <div class="text-xs text-gray-500">–ó–∞: ${r.referred_name}</div>
            <div class="text-xs text-gray-600 mt-1">${r.trc20_wallet || '–ö–æ—à–µ–ª—ë–∫ –Ω–µ —É–∫–∞–∑–∞–Ω'}</div>
          </div>
          <div class="text-right">
            <div class="text-lg font-medium text-green-400">$${r.earnings.toFixed(2)}</div>
            <button onclick="markAsPaid(${r.id})" class="text-xs bg-gray-800 hover:bg-gray-700 px-2 py-1 rounded mt-1 transition">
              –í—ã–ø–ª–∞—á–µ–Ω–æ
            </button>
          </div>
        </div>
      `).join('') : '<div class="text-gray-600 text-center text-sm">–ù–µ—Ç –æ–∂–∏–¥–∞—é—â–∏—Ö –≤—ã–ø–ª–∞—Ç</div>';
      
      document.getElementById('referralsList').innerHTML = referralsData.length > 0 ? referralsData.map(r => `
        <div class="bg-gray-900/50 rounded-lg p-3 flex items-center justify-between border border-gray-800">
          <div class="text-sm">
            <span class="text-gray-400">${r.referrer_name}</span> 
            –ø—Ä–∏–≥–ª–∞—Å–∏–ª 
            <span class="text-gray-400">${r.referred_name}</span>
          </div>
          <div class="text-gray-400 font-medium text-sm">+$${r.earnings.toFixed(2)}</div>
        </div>
      `).join('') : '<div class="text-gray-600 text-center text-sm">–ù–µ—Ç —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤</div>';
    }

    function updateStats() {
      document.getElementById('statOrders').textContent = ordersData.length;
      document.getElementById('statPending').textContent = ordersData.filter(o => o.status === 'pending').length;
      document.getElementById('statWorking').textContent = ordersData.filter(o => o.status === 'working').length;
      document.getElementById('statUsers').textContent = usersData.length;
      
      const revenue = ordersData
        .filter(o => o.status === 'completed')
        .reduce((sum, o) => sum + (o.total || 0), 0);
      document.getElementById('statRevenue').textContent = '$' + revenue.toFixed(0);
    }

    function updateNotifRecipients() {
      const select = document.getElementById('notifRecipient');
      select.innerHTML = '<option value="all">–í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</option>';
      usersData.forEach(u => {
        select.innerHTML += `<option value="${u.id}">${u.name || '–ë–µ–∑ –∏–º–µ–Ω–∏'} (@${u.username || '–Ω–µ—Ç'})</option>`;
      });
    }

    // Order Modal
    function openOrderModal(orderId) {
      const order = ordersData.find(o => o.id === orderId);
      if (!order) return;
      
      let formatsStr = '-';
      try {
        const formats = JSON.parse(order.formats || '[]');
        formatsStr = formats.length > 0 ? formats.join(', ') : '-';
      } catch(e) {
        formatsStr = order.formats || '-';
      }
      
      document.getElementById('orderModalContent').innerHTML = `
        <div class="space-y-6">
          <div class="flex items-center justify-between">
            <span class="font-mono text-lg text-gray-400">#${order.id}</span>
            <span class="status-${order.status} px-3 py-1 rounded-full text-sm font-medium">
              ${getStatusText(order.status)}
            </span>
          </div>
          
          <div class="grid grid-cols-2 gap-3">
            <div class="bg-gray-900/50 rounded-lg p-3">
              <div class="text-xs text-gray-600 mb-1 uppercase tracking-wide">–ö–ª–∏–µ–Ω—Ç</div>
              <div class="font-medium">${order.user_name || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}</div>
              <div class="text-sm text-gray-500">@${order.username || '–Ω–µ—Ç'}</div>
            </div>
            <div class="bg-gray-900/50 rounded-lg p-3">
              <div class="text-xs text-gray-600 mb-1 uppercase tracking-wide">–°—É–º–º–∞</div>
              <div class="font-medium text-xl text-green-400">$${order.total}</div>
            </div>
          </div>
          
          <div class="bg-gray-900/50 rounded-lg p-4 space-y-2 text-sm">
            <div class="flex justify-between"><span class="text-gray-600">–£—Å–ª—É–≥–∞:</span><span>${order.service}</span></div>
            <div class="flex justify-between"><span class="text-gray-600">–ù–∏—à–∞:</span><span>${order.niche}</span></div>
            <div class="flex justify-between"><span class="text-gray-600">–§–æ—Ä–º–∞—Ç—ã:</span><span>${formatsStr}</span></div>
            <div class="flex justify-between"><span class="text-gray-600">–û–ø–ª–∞—Ç–∞:</span><span>${order.payment_method || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}</span></div>
            ${order.tx_hash ? `<div class="flex justify-between"><span class="text-gray-600">TxHash:</span><span class="text-xs font-mono">${order.tx_hash.substring(0, 20)}...</span></div>` : ''}
          </div>
          
          ${order.description ? `
          <div class="bg-gray-900/50 rounded-lg p-4">
            <div class="text-xs text-gray-600 mb-2 uppercase tracking-wide">–û–ø–∏—Å–∞–Ω–∏–µ</div>
            <div class="text-sm text-gray-400">${order.description}</div>
          </div>` : ''}
          
          ${order.refs ? `
          <div class="bg-gray-900/50 rounded-lg p-4">
            <div class="text-xs text-gray-600 mb-2 uppercase tracking-wide">–†–µ—Ñ–µ—Ä–µ–Ω—Å—ã</div>
            <div class="text-sm text-gray-400 break-all">${order.refs}</div>
          </div>` : ''}

          ${(() => {
            try {
              const media = typeof order.media === 'string' ? JSON.parse(order.media) : order.media;
              if (media && Array.isArray(media) && media.length > 0) {
                return `
                <div class="bg-gray-900/50 rounded-lg p-4">
                  <div class="text-xs text-gray-600 mb-3 uppercase tracking-wide">–ú–µ–¥–∏–∞-—Ñ–∞–π–ª—ã (${media.length})</div>
                  <div class="grid grid-cols-3 gap-3">
                    ${media.map(file => {
                      if (file.type && file.type.startsWith('image/')) {
                        return `
                          <a href="${file.data}" download="${file.name}" class="block bg-gray-800 rounded-lg overflow-hidden hover:ring-2 ring-white transition">
                            <img src="${file.data}" class="w-full h-24 object-cover">
                            <div class="p-2 text-xs truncate">${file.name}</div>
                          </a>
                        `;
                      } else {
                        const icon = file.type && file.type.startsWith('video/') ? 'üé•' : 'üìÑ';
                        return `
                          <a href="${file.data}" download="${file.name}" class="block bg-gray-800 rounded-lg p-3 hover:ring-2 ring-white transition text-center">
                            <div class="text-3xl mb-2">${icon}</div>
                            <div class="text-xs truncate">${file.name}</div>
                          </a>
                        `;
                      }
                    }).join('')}
                  </div>
                </div>
                `;
              }
            } catch(e) {
              console.error('Media parse error:', e);
            }
            return '';
          })()}

          <div class="border-t border-gray-800 pt-4">
            <div class="text-xs text-gray-600 mb-3 uppercase tracking-wide">–ò–∑–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å:</div>
            <div class="grid grid-cols-2 gap-2">
              <button onclick="updateOrderStatus('${order.id}', 'pending')" class="status-pending py-2 rounded-lg font-medium text-sm ${order.status === 'pending' ? 'ring-2 ring-white' : ''}">
                –û–∂–∏–¥–∞–µ—Ç
              </button>
              <button onclick="updateOrderStatus('${order.id}', 'working')" class="status-working py-2 rounded-lg font-medium text-sm ${order.status === 'working' ? 'ring-2 ring-white' : ''}">
                –í —Ä–∞–±–æ—Ç–µ
              </button>
              <button onclick="updateOrderStatus('${order.id}', 'completed')" class="status-completed py-2 rounded-lg font-medium text-sm ${order.status === 'completed' ? 'ring-2 ring-white' : ''}">
                –ì–æ—Ç–æ–≤
              </button>
              <button onclick="updateOrderStatus('${order.id}', 'cancelled')" class="status-cancelled py-2 rounded-lg font-medium text-sm ${order.status === 'cancelled' ? 'ring-2 ring-white' : ''}">
                –û—Ç–º–µ–Ω—ë–Ω
              </button>
            </div>
          </div>

          ${order.status === 'awaiting_manager' ? `
          <div class="border-t border-gray-800 pt-4">
            <div class="text-xs text-gray-600 mb-3 uppercase tracking-wide">üí≥ –í—ã—Å—Ç–∞–≤–∏—Ç—å —Å—á–µ—Ç:</div>
            <button onclick="createInvoiceForOrder('${order.id}', ${order.user_id}, ${order.total})"
              class="w-full bg-green-600 hover:bg-green-700 text-white py-3 rounded-lg font-medium text-sm transition mb-2">
              üí≥ –°–æ–∑–¥–∞—Ç—å –∏–Ω–≤–æ–π—Å
            </button>
            <button onclick="testNotification(${order.user_id})"
              class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 rounded-lg font-medium text-sm transition">
              üîî –¢–µ—Å—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
            </button>
          </div>
          ` : ''}

          <div class="border-t border-gray-800 pt-4">
            <div class="text-xs text-gray-600 mb-3 uppercase tracking-wide">–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç—É:</div>
            <textarea id="orderMessage" rows="2" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." 
              class="w-full bg-gray-900/50 border border-gray-800 rounded-lg px-4 py-2 text-sm mb-2 focus:outline-none focus:border-white transition"></textarea>
            <button onclick="sendOrderMessage('${order.id}')" class="w-full bg-white text-black hover:bg-gray-200 py-2 rounded-lg font-medium text-sm transition">
              –û—Ç–ø—Ä–∞–≤–∏—Ç—å
            </button>
          </div>
        </div>
      `;
      
      document.getElementById('orderModal').classList.remove('hidden');
      document.getElementById('orderModal').classList.add('flex');
    }

    function closeOrderModal() {
      document.getElementById('orderModal').classList.add('hidden');
      document.getElementById('orderModal').classList.remove('flex');
    }

    // User Activity Modal
    function showUserActivity(userId, userName) {
      const userOrders = ordersData.filter(o => o.user_id === userId).sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
      const user = usersData.find(u => u.id === userId);

      if (!user) {
        showToast('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω', 'error');
        return;
      }

      document.getElementById('activityModalContent').innerHTML = `
        <div class="space-y-6">
          <!-- User Info -->
          <div class="glass rounded-xl p-4 border border-gray-800">
            <div class="flex items-center gap-4 mb-4">
              <div class="w-12 h-12 bg-gray-800 rounded-full flex items-center justify-center text-lg font-medium">
                ${(userName || 'U').charAt(0).toUpperCase()}
              </div>
              <div>
                <div class="font-medium text-lg">${userName}</div>
                <div class="text-sm text-gray-500">@${user.username || '–Ω–µ—Ç username'}</div>
              </div>
            </div>
            <div class="grid grid-cols-4 gap-3 text-center">
              <div>
                <div class="text-xs text-gray-600 mb-1">–£—Ä–æ–≤–µ–Ω—å</div>
                <div class="font-medium ${getLevelColor(user.level)}">${(user.level || 'none').toUpperCase()}</div>
              </div>
              <div>
                <div class="text-xs text-gray-600 mb-1">–í—Å–µ–≥–æ –∑–∞–∫–∞–∑–æ–≤</div>
                <div class="font-medium">${userOrders.length}</div>
              </div>
              <div>
                <div class="text-xs text-gray-600 mb-1">–ü–æ—Ç—Ä–∞—á–µ–Ω–æ</div>
                <div class="font-medium text-white">$${(user.total_spent || 0).toFixed(2)}</div>
              </div>
              <div>
                <div class="text-xs text-gray-600 mb-1">–ö–µ—à–±—ç–∫</div>
                <div class="font-medium text-green-400">$${(user.cashback || 0).toFixed(2)}</div>
              </div>
            </div>
          </div>

          <!-- Orders History -->
          <div>
            <h4 class="text-sm text-gray-500 mb-3 uppercase tracking-wide">–ò—Å—Ç–æ—Ä–∏—è –∑–∞–∫–∞–∑–æ–≤ (${userOrders.length})</h4>
            ${userOrders.length === 0 ? '<div class="text-center text-gray-500 py-8">–ó–∞–∫–∞–∑–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç</div>' : `
              <div class="space-y-3">
                ${userOrders.map(order => {
                  let formatsStr = '-';
                  try {
                    const formats = JSON.parse(order.formats || '[]');
                    formatsStr = formats.length > 0 ? formats.join(', ') : '-';
                  } catch(e) {
                    formatsStr = order.formats || '-';
                  }

                  return `
                    <div class="glass rounded-xl p-4 border border-gray-800 hover:border-gray-700 cursor-pointer transition" onclick="openOrderModal('${order.id}')">
                      <div class="flex items-start justify-between gap-4 mb-3">
                        <div class="flex-1">
                          <div class="flex items-center gap-2 mb-1">
                            <span class="font-mono text-sm text-gray-400">#${order.id}</span>
                            <span class="status-${order.status} px-2 py-0.5 rounded-full text-xs font-medium">
                              ${getStatusText(order.status)}
                            </span>
                          </div>
                          <div class="text-sm text-gray-500">${order.service} ¬∑ ${order.niche}</div>
                        </div>
                        <div class="text-right">
                          <div class="font-medium text-lg">$${order.total}</div>
                          <div class="text-xs text-gray-600">${formatDate(order.created_at)}</div>
                        </div>
                      </div>
                      ${order.description ? `
                        <div class="text-xs text-gray-600 bg-gray-900/50 rounded p-2 mt-2">
                          ${order.description.substring(0, 100)}${order.description.length > 100 ? '...' : ''}
                        </div>
                      ` : ''}
                    </div>
                  `;
                }).join('')}
              </div>
            `}
          </div>
        </div>
      `;

      document.getElementById('activityModal').classList.remove('hidden');
      document.getElementById('activityModal').classList.add('flex');
    }

    function closeActivityModal() {
      document.getElementById('activityModal').classList.add('hidden');
      document.getElementById('activityModal').classList.remove('flex');
    }

    // Actions
    async function updateOrderStatus(orderId, status) {
      try {
        await apiCall(`/api/admin/orders/${orderId}/status`, 'POST', { status });
        showToast(`–°—Ç–∞—Ç—É—Å –∏–∑–º–µ–Ω—ë–Ω –Ω–∞ "${getStatusText(status)}"`, 'success');
        await loadOrders();
        openOrderModal(orderId);
      } catch (error) {
        showToast('–û—à–∏–±–∫–∞: ' + error.message, 'error');
      }
    }

    async function sendOrderMessage(orderId) {
      const message = document.getElementById('orderMessage').value.trim();
      if (!message) {
        showToast('–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ', 'warning');
        return;
      }

      try {
        await apiCall(`/api/admin/orders/${orderId}/message`, 'POST', { message });
        showToast('–°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ', 'success');
        document.getElementById('orderMessage').value = '';
      } catch (error) {
        showToast('–û—à–∏–±–∫–∞: ' + error.message, 'error');
      }
    }

    async function createInvoiceForOrder(orderId, userId, amount) {
      const order = ordersData.find(o => o.id === orderId);
      if (!order) {
        showToast('–ó–∞–∫–∞–∑ –Ω–µ –Ω–∞–π–¥–µ–Ω', 'error');
        return;
      }

      // Check if order already has items (cart order) with potential promo code
      let promoCode = null;
      let discountAmount = 0;

      // For cart orders, check if there was a promo code applied
      // This would be stored in the order comment or we can ask admin
      const hasPromo = confirm('–ë—ã–ª –ø—Ä–∏–º–µ–Ω–µ–Ω –ø—Ä–æ–º–æ–∫–æ–¥?');
      if (hasPromo) {
        promoCode = prompt('–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –ø—Ä–æ–º–æ–∫–æ–¥–∞:');
        if (promoCode) {
          const discount = prompt('–í–≤–µ–¥–∏—Ç–µ —Ä–∞–∑–º–µ—Ä —Å–∫–∏–¥–∫–∏ ($):');
          discountAmount = parseFloat(discount) || 0;
        }
      }

      try {
        const invoice = await apiCall('/api/admin/invoices', 'POST', {
          order_id: orderId,
          user_id: userId,
          amount: amount,
          promo_code: promoCode,
          discount_amount: discountAmount
        });

        showToast('–ò–Ω–≤–æ–π—Å —Å–æ–∑–¥–∞–Ω –∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –∫–ª–∏–µ–Ω—Ç—É!', 'success');
        await loadOrders();
        closeOrderModal();
      } catch (error) {
        showToast('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∏–Ω–≤–æ–π—Å–∞: ' + error.message, 'error');
      }
    }

    async function testNotification(userId) {
      try {
        showToast('–û—Ç–ø—Ä–∞–≤–∫–∞ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è...', 'info');
        const result = await apiCall('/api/admin/test-notification', 'POST', {
          user_id: userId
        });

        if (result.success) {
          showToast('‚úÖ –¢–µ—Å—Ç–æ–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ!', 'success');
          console.log('Notification result:', result);
        } else {
          showToast('‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è', 'error');
        }
      } catch (error) {
        console.error('Test notification error:', error);
        showToast('‚ùå –û—à–∏–±–∫–∞: ' + (error.details || error.message), 'error');

        // Show detailed error in console
        if (error.details) {
          console.error('Error details:', error.details);
        }
        if (error.code) {
          console.error('Error code:', error.code);
        }
      }
    }

    async function sendNotification() {
      const recipient = document.getElementById('notifRecipient').value;
      const title = document.getElementById('notifTitle').value.trim();
      const message = document.getElementById('notifMessage').value.trim();
      const sendTelegram = document.getElementById('sendTelegram').checked;
      
      if (!title || !message) {
        showToast('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –∑–∞–≥–æ–ª–æ–≤–æ–∫ –∏ —Å–æ–æ–±—â–µ–Ω–∏–µ', 'warning');
        return;
      }
      
      try {
        await apiCall('/api/admin/notify', 'POST', {
          userId: recipient,
          title,
          message,
          sendTelegram
        });
        showToast('–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ', 'success');
        document.getElementById('notifTitle').value = '';
        document.getElementById('notifMessage').value = '';
      } catch (error) {
        showToast('–û—à–∏–±–∫–∞: ' + error.message, 'error');
      }
    }

    function sendMessageToUser(userId, name) {
      switchTab('notifications');
      document.getElementById('notifRecipient').value = userId;
      document.getElementById('notifTitle').value = `–°–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è ${name}`;
      document.getElementById('notifTitle').focus();
    }

    async function markAsPaid(referralId) {
      try {
        await apiCall(`/api/admin/referrals/${referralId}/paid`, 'POST', {});
        showToast('–û—Ç–º–µ—á–µ–Ω–æ –∫–∞–∫ –≤—ã–ø–ª–∞—á–µ–Ω–æ', 'success');
        await loadReferrals();
      } catch (error) {
        showToast('–û—à–∏–±–∫–∞: ' + error.message, 'error');
      }
    }

    // Tabs
    function switchTab(tabName) {
      document.querySelectorAll('.tab-content').forEach(t => t.classList.add('hidden'));
      document.querySelectorAll('.nav-btn').forEach(b => {
        b.classList.remove('active');
      });
      
      document.getElementById(tabName + 'Tab').classList.remove('hidden');
      document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
    }

    function filterOrders() {
      renderOrders();
    }

    function filterUsers() {
      renderUsers();
    }

    // Export
    function exportOrders() {
      const csv = [
        ['ID', '–ö–ª–∏–µ–Ω—Ç', 'Username', '–£—Å–ª—É–≥–∞', '–ù–∏—à–∞', '–°—É–º–º–∞', '–°—Ç–∞—Ç—É—Å', '–û–ø–ª–∞—Ç–∞', '–î–∞—Ç–∞'].join(','),
        ...ordersData.map(o => [
          o.id,
          o.user_name || '',
          o.username || '',
          o.service,
          o.niche,
          o.total,
          o.status,
          o.payment_method || '',
          o.created_at
        ].join(','))
      ].join('\n');
      
      downloadFile('orders.csv', csv);
      showToast('–ó–∞–∫–∞–∑—ã —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã', 'success');
    }

    function exportUsers() {
      const csv = [
        ['ID', 'Telegram ID', '–ò–º—è', 'Username', '–£—Ä–æ–≤–µ–Ω—å', '–ü–æ—Ç—Ä–∞—á–µ–Ω–æ', '–ö–µ—à–±—ç–∫', '–†–µ—Ñ. –∫–æ–¥', '–ö–æ—à–µ–ª—ë–∫', '–î–∞—Ç–∞'].join(','),
        ...usersData.map(u => [
          u.id,
          u.telegram_id,
          u.name || '',
          u.username || '',
          u.level,
          u.total_spent,
          u.cashback,
          u.referral_code,
          u.trc20_wallet || '',
          u.created_at
        ].join(','))
      ].join('\n');
      
      downloadFile('users.csv', csv);
      showToast('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã', 'success');
    }

    function downloadFile(filename, content) {
      const blob = new Blob([content], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      a.click();
      URL.revokeObjectURL(url);
    }

    function saveSettings() {
      const newUrl = document.getElementById('settingsApiUrl').value.trim().replace(/\/$/, '');
      const newKey = document.getElementById('settingsAdminKey').value.trim();
      
      apiUrl = newUrl || window.location.origin;
      adminKey = newKey;
      
      localStorage.setItem('apiUrl', newUrl);
      localStorage.setItem('adminKey', newKey);
      
      document.getElementById('currentApiUrl').textContent = apiUrl;
      showToast('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã', 'success');
    }

    // Helpers
    function getStatusText(status) {
      const statuses = {
        pending: '–û–∂–∏–¥–∞–µ—Ç',
        awaiting_manager: '–û–∂–∏–¥–∞–µ—Ç –º–µ–Ω–µ–¥–∂–µ—Ä–∞',
        awaiting_payment: '–û–∂–∏–¥–∞–µ—Ç –æ–ø–ª–∞—Ç—ã',
        pending_verification: '–ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–ø–ª–∞—Ç—ã',
        verifying: '–ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–ø–ª–∞—Ç—ã',
        working: '–í —Ä–∞–±–æ—Ç–µ',
        completed: '–ì–æ—Ç–æ–≤',
        cancelled: '–û—Ç–º–µ–Ω—ë–Ω'
      };
      return statuses[status] || status;
    }

    function getLevelColor(level) {
      const colors = {
        none: 'text-gray-500',
        bronze: 'text-orange-400',
        silver: 'text-gray-300',
        gold: 'text-yellow-400',
        platinum: 'text-cyan-300'
      };
      return colors[level] || 'text-gray-500';
    }

    function formatDate(dateStr) {
      if (!dateStr) return '-';
      const date = new Date(dateStr);
      return date.toLocaleDateString('ru-RU', {
        day: 'numeric',
        month: 'short',
        hour: '2-digit',
        minute: '2-digit'
      });
    }

    function showToast(message, type = 'info') {
      const container = document.getElementById('toastContainer');
      const colors = {
        success: 'bg-green-600 text-white',
        error: 'bg-red-600 text-white',
        warning: 'bg-yellow-600 text-black',
        info: 'bg-gray-700 text-white'
      };
      
      const toast = document.createElement('div');
      toast.className = `${colors[type]} px-4 py-3 rounded-lg shadow-lg fade-in text-sm`;
      toast.textContent = message;
      container.appendChild(toast);
      
      setTimeout(() => {
        toast.remove();
      }, 3000);
    }

    // Close modal on outside click
    document.getElementById('orderModal').addEventListener('click', (e) => {
      if (e.target.id === 'orderModal') {
        closeOrderModal();
      }
    });

    // Close on Escape key
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') closeOrderModal();
    });

    // Auto-refresh every 30 seconds
    setInterval(() => {
      if (!document.getElementById('adminPanel').classList.contains('hidden')) {
        loadOrders();
      }
    }, 30000);
  </script>
</body>
</html>
