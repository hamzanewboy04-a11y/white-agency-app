<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>White Agency ‚Äî –õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            font-family: 'Inter', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        
        :root {
            --tg-theme-bg-color: #ffffff;
            --tg-theme-text-color: #000000;
            --tg-theme-hint-color: #999999;
            --tg-theme-link-color: #2481cc;
            --tg-theme-button-color: #000000;
            --tg-theme-button-text-color: #ffffff;
            --tg-theme-secondary-bg-color: #f5f5f5;
        }
        
        body {
            background: var(--tg-theme-bg-color);
            color: var(--tg-theme-text-color);
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        body.dark {
            --tg-theme-bg-color: #1a1a1a;
            --tg-theme-text-color: #ffffff;
            --tg-theme-hint-color: #999999;
            --tg-theme-link-color: #64b5f6;
            --tg-theme-button-color: #ffffff;
            --tg-theme-button-text-color: #000000;
            --tg-theme-secondary-bg-color: #2a2a2a;
        }

        /* Dark theme improvements */
        body.dark .card {
            border: 1px solid rgba(255,255,255,0.1);
        }

        body.dark input,
        body.dark textarea,
        body.dark select {
            background: #2a2a2a;
            color: #ffffff;
            border: 1px solid rgba(255,255,255,0.2);
        }

        body.dark input::placeholder,
        body.dark textarea::placeholder {
            color: #888888;
        }

        body.dark .text-gray-700 {
            color: #e0e0e0;
        }

        body.dark .text-gray-500 {
            color: #aaaaaa;
        }

        body.dark .text-gray-400 {
            color: #999999;
        }

        body.dark .border-gray-100 {
            border-color: rgba(255,255,255,0.1);
        }

        body.dark .bg-gray-100 {
            background-color: #2a2a2a;
        }

        body.dark .hover\:bg-gray-100:hover {
            background-color: #3a3a3a;
        }
        
        .card {
            backdrop-filter: blur(10px);
            background: var(--tg-theme-secondary-bg-color);
            border: 1px solid rgba(128,128,128,0.1);
        }
        
        .tab-active {
            background: var(--tg-theme-button-color);
            color: var(--tg-theme-button-text-color);
        }
        
        .fade-in {
            animation: fadeIn 0.3s ease-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .slide-up {
            animation: slideUp 0.4s ease-out;
        }
        
        @keyframes slideUp {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }
        
        input, textarea, select {
            font-size: 16px !important;
            background: var(--tg-theme-secondary-bg-color);
            color: var(--tg-theme-text-color);
        }
        
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }
        
        .badge-platinum { background: linear-gradient(135deg, #E5E4E2 0%, #A0A0A0 50%, #E5E4E2 100%); }
        .badge-gold { background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%); }
        .badge-silver { background: linear-gradient(135deg, #C0C0C0 0%, #A0A0A0 100%); }
        .badge-bronze { background: linear-gradient(135deg, #CD7F32 0%, #8B4513 100%); }
        
        .level-bronze { border-color: #CD7F32; }
        .level-silver { border-color: #C0C0C0; }
        .level-gold { border-color: #FFD700; }
        .level-platinum { border-color: #E5E4E2; }
        
        .btn-primary {
            background: var(--tg-theme-button-color);
            color: var(--tg-theme-button-text-color);
        }
        
        .cashback-glow {
            box-shadow: 0 0 20px rgba(34, 197, 94, 0.2);
        }
        
        .loading {
            pointer-events: none;
            opacity: 0.7;
        }
        
        .skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: skeleton 1.5s infinite;
        }
        
        @keyframes skeleton {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        
        body.dark .skeleton {
            background: linear-gradient(90deg, #2a2a2a 25%, #3a3a3a 50%, #2a2a2a 75%);
            background-size: 200% 100%;
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div id="loadingScreen" class="fixed inset-0 z-[200] flex items-center justify-center" style="background: var(--tg-theme-bg-color);">
        <div class="text-center">
            <div class="w-16 h-16 border-4 border-gray-200 border-t-black rounded-full animate-spin mx-auto mb-4"></div>
            <p class="text-gray-500">–ó–∞–≥—Ä—É–∑–∫–∞...</p>
        </div>
    </div>

    <!-- Header -->
    <header class="sticky top-0 z-50 backdrop-blur-lg border-b border-gray-100 px-4 py-3" style="background: var(--tg-theme-bg-color);">
        <div class="flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="relative">
                    <div class="w-11 h-11 rounded-full bg-gradient-to-br from-gray-800 to-black flex items-center justify-center text-white font-bold text-lg border-2" id="avatarPreview">
                        ?
                    </div>
                    <div class="absolute -bottom-0.5 -right-0.5 w-4 h-4 bg-green-500 rounded-full border-2 border-white"></div>
                </div>
                <div>
                    <h1 class="font-semibold text-base" id="userName">–ó–∞–≥—Ä—É–∑–∫–∞...</h1>
                    <div class="flex items-center gap-1.5">
                        <span class="text-xs px-2 py-0.5 rounded-full badge-bronze text-white font-medium" id="userLevelBadge">Bronze</span>
                        <span class="text-xs text-gray-500" id="userDiscount">—Å–∫–∏–¥–∫–∞ 5%</span>
                    </div>
                </div>
            </div>
            <div class="flex items-center gap-2">
                <button onclick="showNotifications()" class="relative w-10 h-10 flex items-center justify-center rounded-full hover:bg-gray-100 transition-colors">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path>
                    </svg>
                    <span class="hidden absolute -top-1 -right-1 bg-red-500 text-white text-[10px] font-bold rounded-full min-w-[18px] h-[18px] flex items-center justify-center px-1" id="notifBadge">0</span>
                </button>
                <button onclick="showSettings()" class="w-10 h-10 flex items-center justify-center rounded-full hover:bg-gray-100 transition-colors">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                    </svg>
                </button>
            </div>
        </div>
    </header>

    <!-- Balance Cards -->
    <section class="px-4 py-4">
        <div class="grid grid-cols-2 gap-3">
            <!-- Cashback Card -->
            <div class="card rounded-2xl p-4 relative overflow-hidden cashback-glow">
                <div class="absolute top-0 right-0 w-20 h-20 bg-gradient-to-br from-green-400/20 to-transparent rounded-full -translate-y-1/2 translate-x-1/2"></div>
                <div class="text-xs text-gray-500 mb-1">üíµ –ö–µ—à–±—ç–∫</div>
                <div class="text-2xl font-bold text-green-600" id="cashbackBalance">$0.00</div>
                <div class="text-xs text-gray-400 mt-1">–î–æ—Å—Ç—É–ø–Ω–æ –∫ –æ–ø–ª–∞—Ç–µ</div>
                <button onclick="showCashbackHistory()" class="mt-2 text-xs text-gray-600 underline">–ò—Å—Ç–æ—Ä–∏—è</button>
            </div>
            
            <!-- Referral Card -->
            <div class="card rounded-2xl p-4 relative overflow-hidden">
                <div class="absolute top-0 right-0 w-20 h-20 bg-gradient-to-br from-blue-400/20 to-transparent rounded-full -translate-y-1/2 translate-x-1/2"></div>
                <div class="text-xs text-gray-500 mb-1">üë• –†–µ—Ñ–µ—Ä–∞–ª—ã</div>
                <div class="text-2xl font-bold" id="referralCount">0</div>
                <div class="text-xs text-green-600 mt-1 font-medium" id="referralEarnings">+$0 –∑–∞—Ä–∞–±–æ—Ç–∞–Ω–æ</div>
                <button onclick="showReferral()" class="mt-2 text-xs text-gray-600 underline">–ü—Ä–∏–≥–ª–∞—Å–∏—Ç—å</button>
            </div>
        </div>
        
        <!-- Level Progress -->
        <div class="card rounded-2xl p-4 mt-3">
            <div class="flex justify-between items-center mb-2">
                <div class="flex items-center gap-2">
                    <span class="text-sm font-medium" id="nextLevelText">–î–æ Silver</span>
                    <span class="text-xs px-2 py-0.5 rounded-full bg-gray-100" id="nextLevelDiscount">—Å–∫–∏–¥–∫–∞ 10%</span>
                </div>
                <span class="text-sm text-gray-500" id="progressText">$0 / $500</span>
            </div>
            <div class="h-2.5 bg-gray-100 rounded-full overflow-hidden">
                <div class="h-full bg-gradient-to-r from-gray-800 to-black rounded-full transition-all duration-500" id="progressBar" style="width: 0%"></div>
            </div>
            <div class="flex justify-between mt-3 text-xs">
                <div class="flex items-center gap-1">
                    <span class="w-2 h-2 rounded-full badge-bronze"></span>
                    <span class="text-gray-400">$100</span>
                </div>
                <div class="flex items-center gap-1">
                    <span class="w-2 h-2 rounded-full badge-silver"></span>
                    <span class="text-gray-400">$500</span>
                </div>
                <div class="flex items-center gap-1">
                    <span class="w-2 h-2 rounded-full badge-gold"></span>
                    <span class="text-gray-400">$1,000</span>
                </div>
                <div class="flex items-center gap-1">
                    <span class="w-2 h-2 rounded-full badge-platinum"></span>
                    <span class="text-gray-400">$10,000</span>
                </div>
            </div>
        </div>

        <!-- Referral Discount Banner (for referred users on first order) -->
        <div id="referralDiscountBanner" class="hidden card rounded-2xl p-4 mt-3 bg-gradient-to-r from-purple-500 to-pink-500 text-white">
            <div class="flex items-center gap-3">
                <div class="text-4xl">üéÅ</div>
                <div class="flex-1">
                    <p class="font-bold text-base">–£ –≤–∞—Å —Å–∫–∏–¥–∫–∞ 25% –Ω–∞ –ø–µ—Ä–≤—ã–π –∑–∞–∫–∞–∑!</p>
                    <p class="text-sm opacity-90 mt-1">–ë–æ–Ω—É—Å –æ—Ç —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π –ø—Ä–æ–≥—Ä–∞–º–º—ã</p>
                </div>
            </div>
        </div>
    </section>

    <!-- Quick Actions -->
    <section class="px-4 pb-4">
        <div class="grid grid-cols-4 gap-2">
            <button onclick="switchTab('catalog'); document.querySelector('[data-tab=catalog]').scrollIntoView({behavior: 'smooth', block: 'nearest'})" class="flex flex-col items-center gap-1.5 p-3 rounded-2xl btn-primary hover:opacity-90 transition-opacity">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"></path>
                </svg>
                <span class="text-xs font-medium">–ö–∞—Ç–∞–ª–æ–≥</span>
            </button>
            <button onclick="showCart()" class="flex flex-col items-center gap-1.5 p-3 rounded-2xl bg-gray-100 hover:bg-gray-200 transition-colors relative">
                <div id="cartBadge" class="hidden absolute -top-1 -right-1 bg-red-500 text-white text-[10px] font-bold rounded-full w-5 h-5 flex items-center justify-center">0</div>
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"></path>
                </svg>
                <span class="text-xs font-medium">–ö–æ—Ä–∑–∏–Ω–∞</span>
            </button>
            <button onclick="showGallery()" class="flex flex-col items-center gap-1.5 p-3 rounded-2xl bg-gray-100 hover:bg-gray-200 transition-colors">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                </svg>
                <span class="text-xs font-medium">–†–∞–±–æ—Ç—ã</span>
            </button>
            <button onclick="showChat()" class="flex flex-col items-center gap-1.5 p-3 rounded-2xl bg-gray-100 hover:bg-gray-200 transition-colors relative">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                </svg>
                <span class="text-xs font-medium">–ß–∞—Ç</span>
            </button>
        </div>
    </section>

    <!-- Tabs -->
    <section class="px-4 mb-4">
        <div class="flex gap-2 overflow-x-auto scrollbar-hide pb-2">
            <button onclick="switchTab('catalog')" class="tab-btn tab-active px-4 py-2 rounded-full text-sm font-medium whitespace-nowrap transition-all" data-tab="catalog">
                üõç –ö–∞—Ç–∞–ª–æ–≥
            </button>
            <button onclick="switchTab('orders')" class="tab-btn px-4 py-2 rounded-full text-sm font-medium whitespace-nowrap bg-gray-100 transition-all" data-tab="orders">
                –ó–∞–∫–∞–∑—ã
            </button>
            <button onclick="switchTab('invoices')" class="tab-btn px-4 py-2 rounded-full text-sm font-medium whitespace-nowrap bg-gray-100 transition-all relative" data-tab="invoices">
                üí≥ –°—á–µ—Ç–∞
                <span id="invoicesBadge" class="hidden absolute -top-1 -right-1 bg-red-500 text-white text-[10px] font-bold rounded-full w-4 h-4 flex items-center justify-center"></span>
            </button>
            <button onclick="switchTab('promo')" class="tab-btn px-4 py-2 rounded-full text-sm font-medium whitespace-nowrap bg-gray-100 transition-all" data-tab="promo">
                –ü—Ä–æ–º–æ–∫–æ–¥—ã
            </button>
            <button onclick="switchTab('achievements')" class="tab-btn px-4 py-2 rounded-full text-sm font-medium whitespace-nowrap bg-gray-100 transition-all" data-tab="achievements">
                –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è
            </button>
            <button onclick="switchTab('stats')" class="tab-btn px-4 py-2 rounded-full text-sm font-medium whitespace-nowrap bg-gray-100 transition-all" data-tab="stats">
                –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
            </button>
        </div>
    </section>

    <!-- Tab Content -->
    <section class="px-4 pb-24" id="tabContent">
        <!-- Catalog Tab -->
        <div id="catalogTab" class="space-y-3 fade-in">
            <div class="grid grid-cols-1 gap-3" id="catalogProducts">
                <!-- Products will be rendered here -->
            </div>
        </div>

        <!-- Orders Tab -->
        <div id="ordersTab" class="space-y-3 fade-in hidden">
            <div id="ordersList">
                <div class="text-center py-8 text-gray-400">
                    <svg class="w-16 h-16 mx-auto mb-4 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
                    </svg>
                    <p>–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –∑–∞–∫–∞–∑–æ–≤</p>
                    <button onclick="showOrderForm()" class="mt-4 px-6 py-2 btn-primary rounded-full text-sm font-medium">
                        –°–æ–∑–¥–∞—Ç—å –ø–µ—Ä–≤—ã–π –∑–∞–∫–∞–∑
                    </button>
                </div>
            </div>
        </div>

        <!-- Invoices Tab -->
        <div id="invoicesTab" class="space-y-3 fade-in hidden">
            <div class="mb-4 bg-blue-50 rounded-xl p-4 text-sm">
                <div class="flex items-start gap-2">
                    <span class="text-lg">‚ÑπÔ∏è</span>
                    <div>
                        <p class="font-medium text-blue-900">–ö–∞–∫ –æ–ø–ª–∞—Ç–∏—Ç—å —Å—á—ë—Ç?</p>
                        <p class="text-blue-700 mt-1">–í—ã–±–µ—Ä–∏—Ç–µ —Å—á—ë—Ç –Ω–∏–∂–µ –∏ –Ω–∞–∂–º–∏—Ç–µ "–û–ø–ª–∞—Ç–∏—Ç—å". –ü–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã —Å—Ç–∞—Ç—É—Å –æ–±–Ω–æ–≤–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.</p>
                    </div>
                </div>
            </div>
            <div id="invoicesList">
                <div class="text-center py-8 text-gray-400">
                    <svg class="w-16 h-16 mx-auto mb-4 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"></path>
                    </svg>
                    <p>–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç —Å—á–µ—Ç–æ–≤</p>
                </div>
            </div>
        </div>

        <!-- Promo Tab -->
        <div id="promoTab" class="space-y-3 hidden fade-in">
            <div class="card rounded-2xl p-4">
                <div class="flex gap-3">
                    <input type="text" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø—Ä–æ–º–æ–∫–æ–¥" class="flex-1 px-4 py-3 rounded-xl text-sm focus:outline-none focus:ring-2 focus:ring-black" id="promoInput">
                    <button onclick="applyPromo()" class="px-5 py-3 btn-primary rounded-xl text-sm font-medium">
                        OK
                    </button>
                </div>
            </div>
            
            <div class="card rounded-2xl p-4 border border-dashed border-gray-300">
                <div class="flex items-center justify-between">
                    <div>
                        <span class="text-xs text-gray-500">–í–∞—à –ø—Ä–æ–º–æ–∫–æ–¥ –¥–ª—è –¥—Ä—É–∑–µ–π</span>
                        <p class="font-mono text-lg font-bold mt-1" id="myPromoCode">---</p>
                    </div>
                    <button onclick="copyPromo()" class="w-10 h-10 flex items-center justify-center bg-gray-100 rounded-lg hover:bg-gray-200 transition-colors text-lg" title="–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å">
                        üìã
                    </button>
                </div>
                <p class="text-xs text-gray-400 mt-2">–î—Ä—É–≥ –ø–æ–ª—É—á–∏—Ç -15% –Ω–∞ –ø–µ—Ä–≤—ã–π –∑–∞–∫–∞–∑, –≤—ã ‚Äî 25% –æ—Ç —Å—É–º–º—ã –µ–≥–æ –∑–∞–∫–∞–∑–∞</p>
            </div>
        </div>
        
        <!-- Achievements Tab -->
        <div id="achievementsTab" class="space-y-3 hidden fade-in">
            <div class="grid grid-cols-3 gap-3" id="achievementsList">
            </div>
        </div>
        
        <!-- Stats Tab -->
        <div id="statsTab" class="space-y-3 hidden fade-in">
            <div class="card rounded-2xl p-4">
                <h3 class="font-semibold mb-4">–í–∞—à–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h3>
                <div class="space-y-3" id="statsContent">
                </div>
            </div>
        </div>
    </section>

    <!-- Bottom Navigation -->
    <nav class="fixed bottom-0 left-0 right-0 backdrop-blur-lg border-t border-gray-100 px-6 py-2 pb-6" style="background: var(--tg-theme-bg-color);">
        <div class="flex justify-around items-center">
            <button class="flex flex-col items-center gap-0.5" style="color: var(--tg-theme-button-color);">
                <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/>
                </svg>
                <span class="text-[10px] font-medium">–ì–ª–∞–≤–Ω–∞—è</span>
            </button>
            <button onclick="showReferral()" class="flex flex-col items-center gap-0.5 text-gray-400">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/>
                </svg>
                <span class="text-[10px] font-medium">–†–µ—Ñ–µ—Ä–∞–ª—ã</span>
            </button>
            <button onclick="showSettings()" class="flex flex-col items-center gap-0.5 text-gray-400">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                </svg>
                <span class="text-[10px] font-medium">–ü—Ä–æ—Ñ–∏–ª—å</span>
            </button>
        </div>
    </nav>

    <!-- Modal Overlay -->
    <div id="modalOverlay" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden" onclick="closeModal()"></div>

    <!-- Order Form Modal -->
    <div id="orderModal" class="fixed bottom-0 left-0 right-0 rounded-t-3xl z-50 hidden max-h-[90vh] overflow-y-auto" style="background: var(--tg-theme-bg-color);">
        <div class="sticky top-0 pt-4 px-6 pb-2 border-b" style="background: var(--tg-theme-bg-color);">
            <div class="w-12 h-1 bg-gray-300 rounded-full mx-auto mb-4"></div>
            <h2 class="text-xl font-bold">–ù–æ–≤—ã–π –∑–∞–∫–∞–∑</h2>
        </div>
        <div class="p-6 space-y-4">
            <div>
                <label class="text-sm font-medium text-gray-700 mb-2 block">–¢–∏–ø —É—Å–ª—É–≥–∏</label>
                <select id="serviceType" onchange="updatePrice()" class="w-full px-4 py-3 rounded-xl text-sm focus:outline-none focus:ring-2 focus:ring-black">
                    <option value="10">–°—Ç–∞—Ç–∏–∫–∞ (–æ—Ç $10)</option>
                    <option value="30">–ü–∞–∫ —Å—Ç–∞—Ç–∏–∫–∏ 5 —à—Ç (–æ—Ç $30)</option>
                    <option value="25">–í–∏–¥–µ–æ-–∫—Ä–µ–∞—Ç–∏–≤ (–æ—Ç $25)</option>
                    <option value="40">–õ–∏–ø—Å–∏–Ω–≥ (–æ—Ç $40)</option>
                    <option value="30">AI-–∞–≤–∞—Ç–∞—Ä (–æ—Ç $30)</option>
                    <option value="100">UGC-–≤–∏–¥–µ–æ (–æ—Ç $100)</option>
                    <option value="15">GIF/–ê–Ω–∏–º–∞—Ü–∏—è (–æ—Ç $15)</option>
                    <option value="200">–î–∏–∑–∞–π–Ω –ª–µ–Ω–¥–∏–Ω–≥–∞ (–æ—Ç $200)</option>
                </select>
            </div>
            <div>
                <label class="text-sm font-medium text-gray-700 mb-2 block">–ù–∏—à–∞</label>
                <select id="nicheType" class="w-full px-4 py-3 rounded-xl text-sm focus:outline-none focus:ring-2 focus:ring-black">
                    <option>Gambling / Betting</option>
                    <option>Crypto / Forex</option>
                    <option>–¢–æ–≤–∞—Ä–∫–∞</option>
                    <option>–í–∞–∫–∞–Ω—Å–∏–∏ / –õ–∏–¥–≥–µ–Ω</option>
                    <option>–î—Ä—É–≥–æ–µ</option>
                </select>
            </div>
            <div>
                <label class="text-sm font-medium text-gray-700 mb-2 block">–§–æ—Ä–º–∞—Ç / –ü–ª–∞—Ç—Ñ–æ—Ä–º–∞</label>
                <div class="flex flex-wrap gap-2" id="formatButtons">
                    <button type="button" class="format-btn px-3 py-2 rounded-lg bg-gray-100 text-sm" onclick="toggleFormat(this)">FB/Insta</button>
                    <button type="button" class="format-btn px-3 py-2 rounded-lg bg-gray-100 text-sm" onclick="toggleFormat(this)">TikTok</button>
                    <button type="button" class="format-btn px-3 py-2 rounded-lg bg-gray-100 text-sm" onclick="toggleFormat(this)">Telegram</button>
                    <button type="button" class="format-btn px-3 py-2 rounded-lg bg-gray-100 text-sm" onclick="toggleFormat(this)">9:16</button>
                    <button type="button" class="format-btn px-3 py-2 rounded-lg bg-gray-100 text-sm" onclick="toggleFormat(this)">1:1</button>
                    <button type="button" class="format-btn px-3 py-2 rounded-lg bg-gray-100 text-sm" onclick="toggleFormat(this)">4:5</button>
                </div>
            </div>
            <div>
                <label class="text-sm font-medium text-gray-700 mb-2 block">–û–ø–∏—Å–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏</label>
                <textarea id="orderDescription" class="w-full px-4 py-3 rounded-xl text-sm focus:outline-none focus:ring-2 focus:ring-black h-24 resize-none" placeholder="–û–ø–∏—à–∏—Ç–µ, —á—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å..."></textarea>
            </div>
            <div>
                <label class="text-sm font-medium text-gray-700 mb-2 block">–†–µ—Ñ–µ—Ä–µ–Ω—Å—ã (—Å—Å—ã–ª–∫–∏)</label>
                <input type="text" id="orderRefs" class="w-full px-4 py-3 rounded-xl text-sm focus:outline-none focus:ring-2 focus:ring-black" placeholder="–°—Å—ã–ª–∫–∞ –Ω–∞ –ø—Ä–∏–º–µ—Ä">
            </div>
            <div>
                <label class="text-sm font-medium text-gray-700 mb-2 block">–ú–µ–¥–∏–∞-—Ñ–∞–π–ª—ã (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
                <input type="file" id="orderMediaFiles" multiple accept="image/*,video/*,.pdf,.zip,.rar"
                    onchange="handleFileSelect(this)"
                    class="w-full px-4 py-3 rounded-xl text-sm focus:outline-none focus:ring-2 focus:ring-black bg-gray-50 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-medium file:bg-black file:text-white hover:file:bg-gray-800">
                <div class="text-xs text-gray-500 mt-1">–ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–æ—Ç–æ, –≤–∏–¥–µ–æ –∏–ª–∏ –¥–æ–∫—É–º–µ–Ω—Ç—ã (–º–∞–∫—Å 10MB –∫–∞–∂–¥—ã–π)</div>
                <div id="filePreview" class="mt-3 grid grid-cols-3 gap-2"></div>
            </div>

            <!-- Order Summary -->
            <div class="card rounded-xl p-4 space-y-3">
                <div class="flex justify-between items-center">
                    <span class="text-sm">–°—Ç–æ–∏–º–æ—Å—Ç—å</span>
                    <span class="font-bold" id="orderPrice">$10.00</span>
                </div>
                <div class="flex justify-between items-center text-green-600">
                    <span class="text-sm">–°–∫–∏–¥–∫–∞ <span id="discountLevel">Bronze</span> (-<span id="discountPercent">5</span>%)</span>
                    <span class="font-medium" id="orderDiscount">-$0.50</span>
                </div>
                <div id="referralDiscountApplied" class="hidden flex justify-between items-center text-purple-600">
                    <span class="text-sm">üéÅ –†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å–∫–∏–¥–∫–∞ (-25%)</span>
                    <span class="font-medium" id="referralDiscountAmount">-$0.00</span>
                </div>
                <div class="flex justify-between items-center">
                    <div class="flex items-center gap-2">
                        <span class="text-sm">–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–µ—à–±—ç–∫</span>
                        <span class="text-xs text-gray-400">(–º–∞–∫—Å 50%)</span>
                    </div>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" class="sr-only peer" id="useCashback" onchange="updatePrice()">
                        <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-500"></div>
                    </label>
                </div>
                <div id="cashbackApplied" class="hidden flex justify-between items-center text-green-600">
                    <span class="text-sm">–ö–µ—à–±—ç–∫ —Å–ø–∏—Å–∞–Ω</span>
                    <span class="font-medium" id="cashbackAmount">-$0.00</span>
                </div>
                <div class="border-t pt-3">
                    <div class="mb-2">
                        <input type="text" id="promoCodeInput" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø—Ä–æ–º–æ–∫–æ–¥"
                            class="w-full px-3 py-2 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-black uppercase mb-2"
                            onkeyup="this.value = this.value.toUpperCase()">
                        <button onclick="applyPromoCode()" class="w-full py-2 bg-black text-white rounded-lg text-sm font-medium hover:bg-gray-800 transition">
                            ‚úì –ü—Ä–∏–º–µ–Ω–∏—Ç—å
                        </button>
                    </div>
                    <div id="promoApplied" class="hidden flex justify-between items-center text-blue-600 text-sm bg-blue-50 px-3 py-2 rounded-lg">
                        <span>üéÅ –ü—Ä–æ–º–æ–∫–æ–¥ <span id="appliedPromoCode" class="font-semibold"></span></span>
                        <span class="font-bold" id="promoDiscount">-$0.00</span>
                    </div>
                </div>
                <div class="border-t pt-3 flex justify-between items-center">
                    <span class="font-semibold">–ò—Ç–æ–≥–æ –∫ –æ–ø–ª–∞—Ç–µ</span>
                    <span class="text-xl font-bold" id="orderTotal">$9.50</span>
                </div>
                <div class="flex justify-between items-center text-green-600 text-sm">
                    <span>–ö–µ—à–±—ç–∫ –∑–∞ –∑–∞–∫–∞–∑ (5%)</span>
                    <span class="font-medium" id="orderCashback">+$0.48</span>
                </div>
            </div>
            
            <button onclick="proceedToPayment()" id="submitOrderBtn" class="w-full py-4 btn-primary rounded-xl font-semibold transition-opacity">
                –ü–µ—Ä–µ–π—Ç–∏ –∫ –æ–ø–ª–∞—Ç–µ ‚Üí
            </button>
        </div>
    </div>

    <!-- Tips Modal -->
    <div id="tipsModal" class="fixed bottom-0 left-0 right-0 rounded-t-3xl z-50 hidden" style="background: var(--tg-theme-bg-color);">
        <div class="p-6">
            <div class="w-12 h-1 bg-gray-300 rounded-full mx-auto mb-4"></div>
            <h2 class="text-xl font-bold text-center mb-2">üíù –ß–∞–µ–≤—ã–µ –¥–∏–∑–∞–π–Ω–µ—Ä—É</h2>
            <p class="text-sm text-gray-500 text-center mb-6">100% —Å—É–º–º—ã –ø–æ–ª—É—á–∏—Ç –¥–∏–∑–∞–π–Ω–µ—Ä –Ω–∞ TRC-20</p>
            
            <div class="grid grid-cols-4 gap-3 mb-4">
                <button onclick="selectTip(5)" class="tip-btn py-3 rounded-xl bg-gray-100 font-bold hover:bg-gray-200 transition-colors">$5</button>
                <button onclick="selectTip(10)" class="tip-btn py-3 rounded-xl bg-gray-100 font-bold hover:bg-gray-200 transition-colors">$10</button>
                <button onclick="selectTip(20)" class="tip-btn py-3 rounded-xl bg-gray-100 font-bold hover:bg-gray-200 transition-colors">$20</button>
                <button onclick="selectTip(50)" class="tip-btn py-3 rounded-xl bg-gray-100 font-bold hover:bg-gray-200 transition-colors">$50</button>
            </div>
            
            <input type="number" id="customTip" placeholder="–°–≤–æ—è —Å—É–º–º–∞ $" class="w-full px-4 py-3 rounded-xl text-sm focus:outline-none focus:ring-2 focus:ring-black mb-4">
            
            <textarea id="tipMessage" class="w-full px-4 py-3 rounded-xl text-sm focus:outline-none focus:ring-2 focus:ring-black h-20 resize-none mb-4" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ –¥–∏–∑–∞–π–Ω–µ—Ä—É (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)"></textarea>
            
            <button onclick="sendTip()" class="w-full py-4 bg-green-600 text-white rounded-xl font-semibold hover:bg-green-700 transition-colors">
                –û—Ç–ø—Ä–∞–≤–∏—Ç—å —á–∞–µ–≤—ã–µ
            </button>
        </div>
    </div>

    <!-- Referral Modal -->
    <div id="referralModal" class="fixed bottom-0 left-0 right-0 rounded-t-3xl z-50 hidden max-h-[85vh] overflow-y-auto" style="background: var(--tg-theme-bg-color);">
        <div class="p-6">
            <div class="w-12 h-1 bg-gray-300 rounded-full mx-auto mb-4"></div>
            <h2 class="text-xl font-bold text-center mb-2">üë• –†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞</h2>
            <p class="text-sm text-gray-500 text-center mb-6">–ü—Ä–∏–≥–ª–∞—à–∞–π –¥—Ä—É–∑–µ–π –∏ –∑–∞—Ä–∞–±–∞—Ç—ã–≤–∞–π</p>
            
            <div class="card rounded-2xl p-5 bg-gradient-to-br from-green-600 to-green-700 text-white mb-4 shadow-lg">
                <div class="text-center mb-3">
                    <p class="text-5xl font-bold drop-shadow-lg">25%</p>
                    <p class="text-base font-medium mt-2">—Å –ø–µ—Ä–≤–æ–≥–æ –∑–∞–∫–∞–∑–∞ –∫–∞–∂–¥–æ–≥–æ –¥—Ä—É–≥–∞</p>
                </div>
                <p class="text-sm text-center bg-white/20 rounded-full px-4 py-1 mx-auto inline-block">–ë–µ—Å—Å—Ä–æ—á–Ω–æ –∏ –±–µ–∑ –ª–∏–º–∏—Ç–æ–≤!</p>
            </div>

            <div class="card rounded-2xl p-4 mb-4" style="background: var(--tg-theme-secondary-bg-color); border: 1px solid rgba(128,128,128,0.2);">
                <p class="text-sm mb-2 font-medium">–í–∞—à–∞ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å—Å—ã–ª–∫–∞</p>
                <div class="flex gap-2">
                    <input type="text" readonly id="refLinkInput" value="" class="flex-1 bg-black/5 px-3 py-2 rounded-lg text-xs font-mono border border-gray-200" style="color: var(--tg-theme-text-color);">
                    <button onclick="copyRefLink()" class="w-10 h-10 flex items-center justify-center bg-black text-white rounded-lg hover:bg-gray-800 transition-colors text-lg" title="–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å">üìã</button>
                </div>
            </div>
            
            <div class="grid grid-cols-2 gap-3 mb-6">
                <div class="card rounded-xl p-4 text-center">
                    <p class="text-3xl font-bold" id="refCountModal">0</p>
                    <p class="text-xs text-gray-500">–ü—Ä–∏–≥–ª–∞—à–µ–Ω–æ</p>
                </div>
                <div class="card rounded-xl p-4 text-center">
                    <p class="text-3xl font-bold text-green-600" id="refEarningsModal">$0</p>
                    <p class="text-xs text-gray-500">–ó–∞—Ä–∞–±–æ—Ç–∞–Ω–æ</p>
                </div>
            </div>
            
            <div class="card rounded-xl p-4 mb-4">
                <h3 class="font-semibold mb-3">–ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç?</h3>
                <div class="space-y-3 text-sm">
                    <div class="flex gap-3">
                        <span class="w-6 h-6 rounded-full bg-black text-white flex items-center justify-center text-xs flex-shrink-0">1</span>
                        <p>–ü–æ–¥–µ–ª–∏—Å—å —Å—Å—ã–ª–∫–æ–π —Å –¥—Ä—É–≥–æ–º</p>
                    </div>
                    <div class="flex gap-3">
                        <span class="w-6 h-6 rounded-full bg-black text-white flex items-center justify-center text-xs flex-shrink-0">2</span>
                        <p>–î—Ä—É–≥ –ø–æ–ª—É—á–∞–µ—Ç <strong>-15%</strong> –Ω–∞ –ø–µ—Ä–≤—ã–π –∑–∞–∫–∞–∑</p>
                    </div>
                    <div class="flex gap-3">
                        <span class="w-6 h-6 rounded-full bg-green-500 text-white flex items-center justify-center text-xs flex-shrink-0">$</span>
                        <p>–¢—ã –ø–æ–ª—É—á–∞–µ—à—å <strong>25%</strong> –æ—Ç –µ–≥–æ –ø–µ—Ä–≤–æ–≥–æ –∑–∞–∫–∞–∑–∞ –Ω–∞ TRC-20</p>
                    </div>
                </div>
            </div>
            
            <div id="referralsList" class="mb-4"></div>
            
            <button onclick="shareRefLink()" class="w-full py-4 btn-primary rounded-xl font-semibold transition-opacity">
                –ü–æ–¥–µ–ª–∏—Ç—å—Å—è —Å—Å—ã–ª–∫–æ–π
            </button>
        </div>
    </div>

    <!-- Cart Modal -->
    <div id="cartModal" class="fixed bottom-0 left-0 right-0 rounded-t-3xl z-50 hidden max-h-[90vh] overflow-y-auto" style="background: var(--tg-theme-bg-color);">
        <div class="p-6">
            <div class="w-12 h-1 bg-gray-300 rounded-full mx-auto mb-4"></div>
            <h2 class="text-xl font-bold text-center mb-2">üõí –ö–æ—Ä–∑–∏–Ω–∞</h2>
            <p class="text-sm text-gray-500 text-center mb-6">–í–∞—à–∏ —Ç–æ–≤–∞—Ä—ã –¥–ª—è –∑–∞–∫–∞–∑–∞</p>

            <div id="cartItems" class="space-y-3 mb-6">
                <!-- Cart items will be rendered here -->
            </div>

            <div id="cartEmpty" class="hidden text-center py-8 text-gray-400">
                <svg class="w-16 h-16 mx-auto mb-4 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"></path>
                </svg>
                <p>–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞</p>
                <button onclick="closeModal(); switchTab('catalog')" class="mt-4 px-6 py-2 btn-primary rounded-full text-sm font-medium">
                    –ü–µ—Ä–µ–π—Ç–∏ –≤ –∫–∞—Ç–∞–ª–æ–≥
                </button>
            </div>

            <div id="cartSummary" class="hidden">
                <div class="border-t pt-4 space-y-3">
                    <div class="flex justify-between text-sm">
                        <span class="text-gray-600">–¢–æ–≤–∞—Ä–æ–≤:</span>
                        <span id="cartItemCount" class="font-medium">0</span>
                    </div>
                    <div class="flex justify-between text-sm">
                        <span class="text-gray-600">–°—É–º–º–∞:</span>
                        <span id="cartSubtotal" class="font-medium">$0.00</span>
                    </div>
                    <div id="cartDiscount" class="flex justify-between text-sm text-green-600 hidden">
                        <span>–°–∫–∏–¥–∫–∞ –ø–æ –ø—Ä–æ–º–æ–∫–æ–¥—É:</span>
                        <span id="cartDiscountAmount">-$0.00</span>
                    </div>
                    <div class="flex justify-between items-center border-t pt-2">
                        <span class="text-lg font-semibold">–ò—Ç–æ–≥–æ:</span>
                        <span class="text-2xl font-bold" id="cartTotal">$0.00</span>
                    </div>
                </div>

                <div class="mt-4 space-y-3">
                    <label class="text-sm font-medium block">–ü—Ä–æ–º–æ–∫–æ–¥ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
                    <div class="flex gap-2">
                        <input type="text" id="cartPromoCode" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø—Ä–æ–º–æ–∫–æ–¥..." class="flex-1 px-4 py-3 rounded-xl text-sm focus:outline-none focus:ring-2 focus:ring-black uppercase">
                        <button onclick="applyPromoCode()" class="w-12 h-12 flex items-center justify-center bg-black text-white rounded-xl hover:bg-gray-800 transition-colors text-xl" title="–ü—Ä–∏–º–µ–Ω–∏—Ç—å">
                            ‚úì
                        </button>
                    </div>
                    <p id="promoError" class="text-xs text-red-500 hidden"></p>
                    <p id="promoSuccess" class="text-xs text-green-600 hidden"></p>
                </div>

                <div class="mt-4 space-y-3">
                    <label class="text-sm font-medium block">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫ –∑–∞–∫–∞–∑—É (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
                    <textarea id="cartComment" rows="3" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–∂–µ–ª–∞–Ω–∏—è..." class="w-full px-4 py-3 rounded-xl text-sm focus:outline-none focus:ring-2 focus:ring-black resize-none"></textarea>
                </div>

                <button onclick="sendCartToManager()" class="w-full mt-6 py-4 btn-primary rounded-xl font-semibold transition-opacity">
                    üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –º–µ–Ω–µ–¥–∂–µ—Ä—É
                </button>
                <p class="text-xs text-gray-500 text-center mt-2">–ú–µ–Ω–µ–¥–∂–µ—Ä —Å–≤—è–∂–µ—Ç—Å—è —Å –≤–∞–º–∏ –¥–ª—è —É—Ç–æ—á–Ω–µ–Ω–∏—è –¥–µ—Ç–∞–ª–µ–π</p>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="fixed bottom-0 left-0 right-0 rounded-t-3xl z-50 hidden max-h-[90vh] overflow-y-auto" style="background: var(--tg-theme-bg-color);">
        <div class="p-6">
            <div class="w-12 h-1 bg-gray-300 rounded-full mx-auto mb-4"></div>
            <h2 class="text-xl font-bold text-center mb-6">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è</h2>
            
            <div class="flex flex-col items-center mb-6">
                <div class="relative">
                    <div class="w-24 h-24 rounded-full bg-gradient-to-br from-gray-800 to-black flex items-center justify-center text-white text-3xl font-bold border-3" id="settingsAvatar">
                        ?
                    </div>
                </div>
                <p class="text-sm text-gray-500 mt-2" id="settingsUsername">@username</p>
                <div class="mt-2 px-3 py-1 rounded-full text-white text-xs font-medium" id="settingsLevelBadge">Bronze</div>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label class="text-sm font-medium text-gray-700 mb-2 block">–ò–º—è</label>
                    <input type="text" id="settingsName" class="w-full px-4 py-3 rounded-xl text-sm focus:outline-none focus:ring-2 focus:ring-black">
                </div>
                
                <!-- TRC-20 Wallet -->
                <div class="pt-4 border-t">
                    <div class="flex items-center gap-2 mb-2">
                        <span class="text-lg">üíé</span>
                        <label class="text-sm font-medium text-gray-700">–ö–æ—à–µ–ª—ë–∫ TRC-20 (–¥–ª—è –≤—ã–ø–ª–∞—Ç)</label>
                    </div>
                    <input type="text" id="trc20Wallet" placeholder="TRC-20 –∞–¥—Ä–µ—Å –∫–æ—à–µ–ª—å–∫–∞ USDT" class="w-full px-4 py-3 rounded-xl text-sm font-mono focus:outline-none focus:ring-2 focus:ring-black">
                    <p class="text-xs text-gray-400 mt-2">–°—é–¥–∞ –±—É–¥—É—Ç –ø—Ä–∏—Ö–æ–¥–∏—Ç—å —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–µ –≤—ã–ø–ª–∞—Ç—ã</p>
                </div>

                <!-- Withdrawals Section -->
                <div class="pt-4 border-t">
                    <div class="flex items-center gap-2 mb-3">
                        <span class="text-lg">üí∏</span>
                        <h3 class="font-semibold">–ó–∞–ø—Ä–æ—Å –Ω–∞ –≤—ã–ø–ª–∞—Ç—É</h3>
                    </div>

                    <div class="space-y-3">
                        <!-- Cashback Balance -->
                        <div class="card rounded-xl p-4 bg-gradient-to-br from-green-50 to-emerald-50">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-sm font-medium text-gray-700">üí∞ –ë–∞–ª–∞–Ω—Å –∫–µ—à–±—ç–∫–∞</span>
                                <span class="text-xl font-bold text-green-600" id="withdrawCashbackBalance">$0.00</span>
                            </div>
                            <button onclick="requestWithdrawal('cashback')" class="w-full py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg text-sm font-medium transition-colors">
                                –ó–∞–ø—Ä–æ—Å–∏—Ç—å –≤—ã–ø–ª–∞—Ç—É –∫–µ—à–±—ç–∫–∞
                            </button>
                        </div>

                        <!-- Referral Balance -->
                        <div class="card rounded-xl p-4 bg-gradient-to-br from-blue-50 to-indigo-50">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-sm font-medium text-gray-700">üë• –†–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–π –¥–æ—Ö–æ–¥</span>
                                <span class="text-xl font-bold text-blue-600" id="withdrawReferralBalance">$0.00</span>
                            </div>
                            <button onclick="requestWithdrawal('referral')" class="w-full py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-sm font-medium transition-colors">
                                –ó–∞–ø—Ä–æ—Å–∏—Ç—å –≤—ã–ø–ª–∞—Ç—É —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤
                            </button>
                        </div>
                    </div>

                    <p class="text-xs text-gray-400 mt-3">‚ö†Ô∏è –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –∫–æ—à–µ–ª—ë–∫ TRC-20 —É–∫–∞–∑–∞–Ω –≤–µ—Ä–Ω–æ</p>

                    <button onclick="showWithdrawalHistory()" class="w-full mt-3 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg text-sm font-medium transition-colors">
                        üìú –ò—Å—Ç–æ—Ä–∏—è –≤—ã–ø–ª–∞—Ç
                    </button>
                </div>

                <div class="pt-4 border-t">
                    <h3 class="font-semibold mb-3">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center">
                            <span class="text-sm">–°—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞</span>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" class="sr-only peer" id="notifOrders" checked>
                                <div class="w-11 h-6 bg-gray-200 rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-black"></div>
                            </label>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-sm">–ê–∫—Ü–∏–∏ –∏ —Å–∫–∏–¥–∫–∏</span>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" class="sr-only peer" id="notifPromo" checked>
                                <div class="w-11 h-6 bg-gray-200 rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-black"></div>
                            </label>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-sm">–†–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–µ –≤—ã–ø–ª–∞—Ç—ã</span>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" class="sr-only peer" id="notifRef" checked>
                                <div class="w-11 h-6 bg-gray-200 rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-black"></div>
                            </label>
                        </div>
                    </div>
                </div>
            </div>
            
            <button onclick="saveSettings()" class="w-full py-4 btn-primary rounded-xl font-semibold mt-6">
                –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
            </button>
        </div>
    </div>

    <!-- Prices Modal -->
    <div id="pricesModal" class="fixed bottom-0 left-0 right-0 rounded-t-3xl z-50 hidden max-h-[90vh] overflow-y-auto" style="background: var(--tg-theme-bg-color);">
        <div class="p-6">
            <div class="w-12 h-1 bg-gray-300 rounded-full mx-auto mb-4"></div>
            <h2 class="text-xl font-bold text-center mb-2">üí∞ –¶–µ–Ω—ã –Ω–∞ —É—Å–ª—É–≥–∏</h2>
            <p class="text-sm text-gray-500 text-center mb-6">–í–∞—à–∞ —Å–∫–∏–¥–∫–∞: <span class="text-green-600 font-bold" id="priceDiscount">-5%</span></p>
            
            <div class="space-y-2" id="pricesList"></div>
            
            <div class="card rounded-xl p-4 bg-green-50 mt-4">
                <p class="text-sm text-center">+ <strong>5% –∫–µ—à–±—ç–∫</strong> —Å –∫–∞–∂–¥–æ–≥–æ –∑–∞–∫–∞–∑–∞!</p>
            </div>
        </div>
    </div>

    <!-- Gallery Modal -->
    <div id="galleryModal" class="fixed bottom-0 left-0 right-0 rounded-t-3xl z-50 hidden max-h-[90vh] overflow-y-auto" style="background: var(--tg-theme-bg-color);">
        <div class="p-6">
            <div class="w-12 h-1 bg-gray-300 rounded-full mx-auto mb-4"></div>
            <h2 class="text-xl font-bold text-center mb-6">üñºÔ∏è –í–∞—à–∏ —Ä–∞–±–æ—Ç—ã</h2>
            <div id="galleryContent" class="grid grid-cols-2 gap-3">
                <div class="text-center py-8 text-gray-400 col-span-2">
                    <p>–†–∞–±–æ—Ç—ã –ø–æ—è–≤—è—Ç—Å—è –ø–æ—Å–ª–µ –ø–µ—Ä–≤–æ–≥–æ –∑–∞–∫–∞–∑–∞</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Review Modal -->
    <div id="reviewModal" class="fixed bottom-0 left-0 right-0 rounded-t-3xl z-50 hidden" style="background: var(--tg-theme-bg-color);">
        <div class="p-6">
            <div class="w-12 h-1 bg-gray-300 rounded-full mx-auto mb-4"></div>
            <h2 class="text-xl font-bold text-center mb-2">‚≠ê –û—Å—Ç–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤</h2>
            <p class="text-sm text-gray-500 text-center mb-6">–ü–æ–ª—É—á–∏—Ç–µ $2 –Ω–∞ –∫–µ—à–±—ç–∫ –∑–∞ —á–µ—Å—Ç–Ω—ã–π –æ—Ç–∑—ã–≤</p>
            
            <div class="flex justify-center gap-2 mb-6">
                <button onclick="setRating(1)" class="rating-star text-3xl text-gray-300 hover:text-yellow-400 transition-colors">‚òÖ</button>
                <button onclick="setRating(2)" class="rating-star text-3xl text-gray-300 hover:text-yellow-400 transition-colors">‚òÖ</button>
                <button onclick="setRating(3)" class="rating-star text-3xl text-gray-300 hover:text-yellow-400 transition-colors">‚òÖ</button>
                <button onclick="setRating(4)" class="rating-star text-3xl text-gray-300 hover:text-yellow-400 transition-colors">‚òÖ</button>
                <button onclick="setRating(5)" class="rating-star text-3xl text-gray-300 hover:text-yellow-400 transition-colors">‚òÖ</button>
            </div>
            
            <input type="hidden" id="reviewOrderId" value="">
            <textarea id="reviewText" class="w-full px-4 py-3 rounded-xl text-sm focus:outline-none focus:ring-2 focus:ring-black h-28 resize-none mb-4" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ –≤–∞—à –æ—Ç–∑—ã–≤..."></textarea>
            
            <button onclick="submitReview()" class="w-full py-4 btn-primary rounded-xl font-semibold">
                –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∏ –ø–æ–ª—É—á–∏—Ç—å $2
            </button>
        </div>
    </div>

    <!-- Cashback History Modal -->
    <div id="cashbackModal" class="fixed bottom-0 left-0 right-0 rounded-t-3xl z-50 hidden max-h-[85vh] overflow-y-auto" style="background: var(--tg-theme-bg-color);">
        <div class="p-6">
            <div class="w-12 h-1 bg-gray-300 rounded-full mx-auto mb-4"></div>
            <h2 class="text-xl font-bold text-center mb-2">üíµ –ò—Å—Ç–æ—Ä–∏—è –∫–µ—à–±—ç–∫–∞</h2>
            <p class="text-sm text-gray-500 text-center mb-6">–ë–∞–ª–∞–Ω—Å: <span class="text-green-600 font-bold" id="cashbackModalBalance">$0.00</span></p>
            <div class="space-y-3" id="cashbackHistory"></div>
        </div>
    </div>

    <!-- Withdrawal History Modal -->
    <div id="withdrawalHistoryModal" class="fixed bottom-0 left-0 right-0 rounded-t-3xl z-50 hidden max-h-[85vh] overflow-y-auto" style="background: var(--tg-theme-bg-color);">
        <div class="p-6">
            <div class="w-12 h-1 bg-gray-300 rounded-full mx-auto mb-4"></div>
            <h2 class="text-xl font-bold text-center mb-4">üí∏ –ò—Å—Ç–æ—Ä–∏—è –≤—ã–ø–ª–∞—Ç</h2>

            <!-- Filter Tabs -->
            <div class="flex gap-2 mb-4">
                <button onclick="filterWithdrawals('all')" class="withdrawal-filter-btn flex-1 py-2 rounded-lg bg-black text-white text-sm font-medium transition" data-filter="all">
                    –í—Å–µ
                </button>
                <button onclick="filterWithdrawals('pending')" class="withdrawal-filter-btn flex-1 py-2 rounded-lg bg-gray-200 text-gray-700 text-sm font-medium transition" data-filter="pending">
                    –í –æ–±—Ä–∞–±–æ—Ç–∫–µ
                </button>
                <button onclick="filterWithdrawals('completed')" class="withdrawal-filter-btn flex-1 py-2 rounded-lg bg-gray-200 text-gray-700 text-sm font-medium transition" data-filter="completed">
                    –í—ã–ø–ª–∞—á–µ–Ω–æ
                </button>
            </div>

            <div class="space-y-3" id="withdrawalHistoryList">
                <div class="text-center text-gray-500 py-8">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
            </div>
        </div>
    </div>

    <!-- Payment Modal -->
    <div id="paymentModal" class="fixed bottom-0 left-0 right-0 rounded-t-3xl z-50 hidden max-h-[90vh] overflow-y-auto" style="background: var(--tg-theme-bg-color);">
        <div class="p-6">
            <div class="w-12 h-1 bg-gray-300 rounded-full mx-auto mb-4"></div>
            <h2 class="text-xl font-bold text-center mb-2">üí≥ –û–ø–ª–∞—Ç–∞ –∑–∞–∫–∞–∑–∞</h2>
            <p class="text-sm text-gray-500 text-center mb-6">–ö –æ–ø–ª–∞—Ç–µ: <span class="text-black font-bold text-lg" id="paymentAmount">$0.00</span></p>
            
            <!-- Payment Methods Tabs -->
            <div class="flex gap-2 mb-6">
                <!-- TON payment hidden by default as requested -->
                <button onclick="selectPaymentMethod('ton')" class="payment-method-btn hidden flex-1 py-3 rounded-xl bg-blue-500 text-white font-medium transition-all" data-method="ton">
                    üíé TON
                </button>
                <button onclick="selectPaymentMethod('usdt')" class="payment-method-btn flex-1 py-3 rounded-xl bg-black text-white font-medium transition-all" data-method="usdt">
                    üíµ USDT TRC-20
                </button>
            </div>

            <!-- TON Payment (hidden) -->
            <div id="tonPayment" class="space-y-4 hidden">
                <div class="card rounded-2xl p-4 bg-gradient-to-r from-blue-500 to-blue-600 text-white">
                    <p class="text-sm opacity-90 mb-1">–°—É–º–º–∞ –≤ TON (–ø—Ä–∏–º–µ—Ä–Ω–æ)</p>
                    <p class="text-3xl font-bold" id="tonAmount">~ 0 TON</p>
                    <p class="text-xs opacity-75 mt-2">–ö—É—Ä—Å –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏</p>
                </div>
                
                <button onclick="payWithTon()" class="w-full py-4 bg-blue-500 text-white rounded-xl font-semibold hover:bg-blue-600 transition-colors flex items-center justify-center gap-2">
                    <span>üíé</span> –û–ø–ª–∞—Ç–∏—Ç—å —á–µ—Ä–µ–∑ TON Connect
                </button>
                
                <p class="text-xs text-gray-400 text-center">–û—Ç–∫—Ä–æ–µ—Ç—Å—è –≤–∞—à TON-–∫–æ—à–µ–ª—ë–∫ –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è</p>
            </div>
            
            <!-- USDT TRC-20 Payment (Default) -->
            <div id="usdtPayment" class="space-y-4">
                <div class="card rounded-2xl p-4 border-2 border-dashed border-gray-300">
                    <p class="text-sm text-gray-500 mb-2">–û—Ç–ø—Ä–∞–≤—å—Ç–µ USDT (TRC-20) –Ω–∞ –∞–¥—Ä–µ—Å:</p>
                    <div class="bg-gray-100 rounded-xl p-3 flex items-center gap-2">
                        <code class="text-xs flex-1 break-all font-mono" id="usdtAddress">TAXtuQh2zJHks5yZQ2zzVdEFExs7ktoYuV</code>
                        <button onclick="copyUsdtAddress()" class="p-2 hover:bg-gray-200 rounded-lg transition-colors">
                            üìã
                        </button>
                    </div>
                </div>
                
                <div class="card rounded-2xl p-4 bg-yellow-50 border border-yellow-200">
                    <div class="flex gap-2">
                        <span class="text-yellow-600">‚ö†Ô∏è</span>
                        <div class="text-sm">
                            <p class="font-medium text-yellow-800">–í–∞–∂–Ω–æ!</p>
                            <p class="text-yellow-700">–û—Ç–ø—Ä–∞–≤–ª—è–π—Ç–µ —Ç–æ–ª—å–∫–æ USDT –≤ —Å–µ—Ç–∏ TRC-20. –î—Ä—É–≥–∏–µ —Å–µ—Ç–∏ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è.</p>
                        </div>
                    </div>
                </div>
                
                <div>
                    <label class="text-sm font-medium text-gray-700 mb-2 block">–•–µ—à —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ (TxID)</label>
                    <input type="text" id="txHash" placeholder="–í—Å—Ç–∞–≤—å—Ç–µ —Ö–µ—à –ø–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã..." class="w-full px-4 py-3 rounded-xl text-sm font-mono focus:outline-none focus:ring-2 focus:ring-green-500">
                    <div class="flex items-center justify-between mt-2">
                        <p class="text-xs text-gray-400">–ù–∞–π–¥–∏—Ç–µ –≤ –∏—Å—Ç–æ—Ä–∏–∏ –≤–∞—à–µ–≥–æ –∫–æ—à–µ–ª—å–∫–∞</p>
                        <button type="button" onclick="checkTronScan()" class="text-xs text-blue-600 hover:text-blue-700">
                            üîç –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞ TronScan
                        </button>
                    </div>
                </div>
                
                <button onclick="confirmUsdtPayment()" id="confirmUsdtBtn" class="w-full py-4 bg-green-600 text-white rounded-xl font-semibold hover:bg-green-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                    ‚úì –Ø –æ–ø–ª–∞—Ç–∏–ª, –ø—Ä–æ–≤–µ—Ä–∏—Ç—å
                </button>
            </div>
            
            <div class="mt-6 pt-4 border-t">
                <button onclick="closeModal()" class="w-full py-3 text-gray-500 text-sm">
                    –û—Ç–º–µ–Ω–∏—Ç—å
                </button>
            </div>
        </div>
    </div>

    <!-- Notifications Modal -->
    <div id="notifModal" class="fixed bottom-0 left-0 right-0 rounded-t-3xl z-50 hidden max-h-[85vh] overflow-y-auto" style="background: var(--tg-theme-bg-color);">
        <div class="p-6">
            <div class="w-12 h-1 bg-gray-300 rounded-full mx-auto mb-4"></div>
            <h2 class="text-xl font-bold text-center mb-6">üîî –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</h2>
            <div class="space-y-3" id="notificationsList"></div>
        </div>
    </div>

    <!-- Invoice Modal -->
    <div id="invoiceModal" class="fixed bottom-0 left-0 right-0 rounded-t-3xl z-50 hidden max-h-[90vh] overflow-y-auto" style="background: var(--tg-theme-bg-color);">
        <div class="p-6">
            <div class="w-12 h-1 bg-gray-300 rounded-full mx-auto mb-4"></div>
            <h2 class="text-xl font-bold text-center mb-6">üí≥ –°—á–µ—Ç –Ω–∞ –æ–ø–ª–∞—Ç—É</h2>
            <div id="invoiceContent"></div>
        </div>
    </div>

    <!-- Toast -->
    <div id="toast" class="fixed top-20 left-1/2 -translate-x-1/2 bg-black text-white px-6 py-3 rounded-full text-sm font-medium shadow-lg z-[100] hidden">
        <span id="toastMessage">–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!</span>
    </div>

    <script>
        // ==================== CONFIGURATION ====================
        const CONFIG = {
            API_URL: 'https://white-agency-app-production.up.railway.app', // Fixed: added https://
            BOT_USERNAME: 'WhiteAgency_Official_bot',
            MANAGER_USERNAME: 'WhiteAgency_manager',
            PAYMENT_ADDRESS: 'TAXtuQh2zJHks5yZQ2zzVdEFExs7ktoYuV', // TRC-20 USDT payment address
            CASHBACK_PERCENT: 5,
            REFERRAL_PERCENT: 25,
            REVIEW_BONUS: 2,
            MAX_CASHBACK_USAGE: 0.5,
            LEVELS: {
                none: { min: 0, discount: 0, next: 'bronze' },
                bronze: { min: 100, discount: 5, next: 'silver' },
                silver: { min: 500, discount: 10, next: 'gold' },
                gold: { min: 1000, discount: 15, next: 'platinum' },
                platinum: { min: 10000, discount: 20, next: null }
            },
            PRICES: [
                { name: '–°—Ç–∞—Ç–∏–∫–∞', desc: '1 –∫—Ä–µ–∞—Ç–∏–≤', price: 10 },
                { name: '–ü–∞–∫ —Å—Ç–∞—Ç–∏–∫–∏', desc: '5 –∫—Ä–µ–∞—Ç–∏–≤–æ–≤', price: 30 },
                { name: '–í–∏–¥–µ–æ-–∫—Ä–µ–∞—Ç–∏–≤', desc: '9:16 / 4:5 / 1:1', price: 25 },
                { name: '–õ–∏–ø—Å–∏–Ω–≥', desc: '–î–≤–∏–∂–µ–Ω–∏–µ –≥—É–± –ø–æ–¥ —Ç–µ–∫—Å—Ç', price: 40 },
                { name: 'AI-–∞–≤–∞—Ç–∞—Ä', desc: '–ù–µ–π—Ä–æ-–ø–µ—Ä—Å–æ–Ω–∞–∂', price: 30 },
                { name: 'UGC-–≤–∏–¥–µ–æ', desc: '–î–æ 15 —Å–µ–∫', price: 100 },
                { name: 'GIF/–ê–Ω–∏–º–∞—Ü–∏—è', desc: 'Motion-–¥–∏–∑–∞–π–Ω', price: 15 },
                { name: '–î–∏–∑–∞–π–Ω –ª–µ–Ω–¥–∏–Ω–≥–∞', desc: 'UX/UI', price: 200 }
            ]
        };

        // ==================== STATE ====================
        let state = {
            user: null,
            tgUser: null,
            isLoading: true,
            appSettings: null,
            products: [], // Products from API
            cart: [], // {productId, name, price, quantity}
            appliedPromo: null // {code, discount_percent, discount_amount}
        };

        // ==================== TELEGRAM WEBAPP ====================
        const tg = window.Telegram?.WebApp;

        function initTelegram() {
            if (!tg) {
                console.warn('Telegram WebApp not available');
                state.tgUser = {
                    id: 'demo_' + Date.now(),
                    first_name: 'Demo',
                    last_name: 'User',
                    username: 'demo_user'
                };
                return;
            }

            tg.ready();
            tg.expand();
            
            if (tg.colorScheme === 'dark') {
                document.body.classList.add('dark');
            }
            
            if (tg.initDataUnsafe?.user) {
                state.tgUser = tg.initDataUnsafe.user;
            }
            
            tg.BackButton.onClick(() => {
                closeModal();
            });
            
            tg.MainButton.setParams({
                text: '–ù–æ–≤—ã–π –∑–∞–∫–∞–∑',
                color: '#000000',
                text_color: '#ffffff'
            });
        }

        // ==================== API ====================
        async function apiRequest(endpoint, method = 'GET', data = null) {
            const url = CONFIG.API_URL + endpoint;
            const options = {
                method,
                headers: {
                    'Content-Type': 'application/json',
                }
            };
            
            if (tg?.initData) {
                options.headers['X-Telegram-Init-Data'] = tg.initData;
            }
            
            if (data) {
                options.body = JSON.stringify(data);
            }
            
            try {
                const response = await fetch(url, options);
                if (!response.ok) throw new Error('API Error');
                return await response.json();
            } catch (error) {
                console.error('API Error:', error);
                return null;
            }
        }

        async function loadUserData() {
            if (CONFIG.API_URL) {
                const data = await apiRequest('/api/user');
                if (data) {
                    state.user = data;
                    updateUI();
                    return;
                }
            }
            
            const saved = localStorage.getItem('whiteagency_user');
            if (saved) {
                state.user = JSON.parse(saved);
            } else {
                state.user = {
                    id: state.tgUser?.id || 'demo',
                    name: state.tgUser?.first_name || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å',
                    username: state.tgUser?.username || '',
                    level: 'none',
                    totalSpent: 0,
                    cashback: 0,
                    referralCode: generateRefCode(),
                    referrals: [],
                    referralEarnings: 0,
                    orders: [],
                    cashbackHistory: [],
                    notifications: [],
                    trc20Wallet: '',
                    settings: {
                        notifOrders: true,
                        notifPromo: true,
                        notifRef: true
                    }
                };
                saveUserData();
            }
            updateUI();
        }

        function saveUserData() {
            localStorage.setItem('whiteagency_user', JSON.stringify(state.user));
            
            if (CONFIG.API_URL) {
                apiRequest('/api/user', 'POST', state.user);
            }
        }

        async function loadAppSettings() {
            try {
                if (CONFIG.API_URL) {
                    const settings = await apiRequest('/api/settings');
                    if (settings && settings.services) {
                        state.appSettings = settings;
                        // Update CONFIG.PRICES with server settings
                        CONFIG.PRICES = settings.services;
                        // Update service select dropdown
                        updateServiceOptions();
                        // Update prices modal
                        renderPrices();
                        console.log('App settings loaded from server');
                    }
                }
            } catch (error) {
                console.error('Failed to load app settings:', error);
                // Use default CONFIG.PRICES if API fails
            }
        }

        async function loadProducts() {
            try {
                if (CONFIG.API_URL) {
                    const products = await apiRequest('/api/products');
                    if (products && products.length > 0) {
                        state.products = products.map(p => ({
                            id: p.id,
                            name: p.name,
                            desc: p.description || '',
                            price: p.price,
                            icon: p.icon || 'üé®'
                        }));
                        console.log('Products loaded from server:', state.products.length);
                    } else {
                        // Use CONFIG.PRICES as fallback
                        state.products = CONFIG.PRICES.map((p, i) => ({
                            id: i,
                            name: p.name,
                            desc: p.desc,
                            price: p.price,
                            icon: ['üé®', 'üé¨', 'üé•', 'üó£Ô∏è', 'ü§ñ', 'üìπ', '‚ú®', 'üíª'][i] || 'üé®'
                        }));
                    }
                } else {
                    // No API, use CONFIG.PRICES
                    state.products = CONFIG.PRICES.map((p, i) => ({
                        id: i,
                        name: p.name,
                        desc: p.desc,
                        price: p.price,
                        icon: ['üé®', 'üé¨', 'üé•', 'üó£Ô∏è', 'ü§ñ', 'üìπ', '‚ú®', 'üíª'][i] || 'üé®'
                    }));
                }
            } catch (error) {
                console.error('Failed to load products:', error);
                // Use CONFIG.PRICES as fallback
                state.products = CONFIG.PRICES.map((p, i) => ({
                    id: i,
                    name: p.name,
                    desc: p.desc,
                    price: p.price,
                    icon: ['üé®', 'üé¨', 'üé•', 'üó£Ô∏è', 'ü§ñ', 'üìπ', '‚ú®', 'üíª'][i] || 'üé®'
                }));
            }
        }

        function updateServiceOptions() {
            const select = document.getElementById('serviceType');
            if (!select) return;

            select.innerHTML = CONFIG.PRICES.map(service =>
                `<option value="${service.price}">${service.name} (–æ—Ç $${service.price})</option>`
            ).join('');
        }

        function generateRefCode() {
            const name = state.tgUser?.first_name || 'USER';
            const rand = Math.random().toString(36).substring(2, 6).toUpperCase();
            return name.substring(0, 4).toUpperCase() + rand;
        }

        // ==================== UI UPDATES ====================
        function updateUI() {
            if (!state.user) return;
            
            const user = state.user;
            const level = CONFIG.LEVELS[user.level] || CONFIG.LEVELS.none;
            
            document.getElementById('userName').textContent = user.name;
            document.getElementById('avatarPreview').textContent = user.name[0].toUpperCase();
            document.getElementById('avatarPreview').className = `w-11 h-11 rounded-full bg-gradient-to-br from-gray-800 to-black flex items-center justify-center text-white font-bold text-lg border-2 level-${user.level || 'bronze'}`;
            
            const levelBadge = document.getElementById('userLevelBadge');
            levelBadge.textContent = user.level ? user.level.charAt(0).toUpperCase() + user.level.slice(1) : 'New';
            levelBadge.className = `text-xs px-2 py-0.5 rounded-full badge-${user.level || 'bronze'} text-white font-medium`;
            document.getElementById('userDiscount').textContent = `—Å–∫–∏–¥–∫–∞ ${level.discount}%`;
            
            document.getElementById('cashbackBalance').textContent = `$${user.cashback.toFixed(2)}`;
            
            document.getElementById('referralCount').textContent = user.referrals.length;
            document.getElementById('referralEarnings').textContent = `+$${user.referralEarnings.toFixed(2)} –∑–∞—Ä–∞–±–æ—Ç–∞–Ω–æ`;
            
            updateProgressBar();
            
            document.getElementById('myPromoCode').textContent = user.referralCode;
            document.getElementById('refLinkInput').value = `t.me/${CONFIG.BOT_USERNAME}?start=${user.referralCode}`;
            
            renderOrders();
            renderInvoices();
            renderStats();
            renderAchievements();
            renderPrices();
            
            document.getElementById('settingsName').value = user.name;
            document.getElementById('settingsAvatar').textContent = user.name[0].toUpperCase();
            document.getElementById('settingsUsername').textContent = user.username ? `@${user.username}` : 'Telegram';
            document.getElementById('settingsLevelBadge').textContent = user.level || 'New';
            document.getElementById('settingsLevelBadge').className = `mt-2 px-3 py-1 rounded-full badge-${user.level || 'bronze'} text-white text-xs font-medium`;
            document.getElementById('trc20Wallet').value = user.trc20Wallet || '';
            document.getElementById('notifOrders').checked = user.settings.notifOrders;
            document.getElementById('notifPromo').checked = user.settings.notifPromo;
            document.getElementById('notifRef').checked = user.settings.notifRef;

            // Update withdrawal balances
            document.getElementById('withdrawCashbackBalance').textContent = `$${(user.cashback || 0).toFixed(2)}`;
            document.getElementById('withdrawReferralBalance').textContent = `$${(user.referral_earnings || 0).toFixed(2)}`;
            
            const unread = user.notifications.filter(n => !n.read).length;
            const notifBadge = document.getElementById('notifBadge');
            if (unread > 0) {
                notifBadge.textContent = unread > 99 ? '99+' : unread;
                notifBadge.classList.remove('hidden');
            } else {
                notifBadge.classList.add('hidden');
            }

            // Show/hide referral discount banner
            const isReferred = user.orders && user.orders.length === 0 && user.referredBy;
            const banner = document.getElementById('referralDiscountBanner');
            if (banner) {
                if (isReferred) {
                    banner.classList.remove('hidden');
                } else {
                    banner.classList.add('hidden');
                }
            }
        }

        function updateProgressBar() {
            const user = state.user;
            const currentLevel = CONFIG.LEVELS[user.level] || CONFIG.LEVELS.none;
            const nextLevelKey = currentLevel.next;
            
            if (!nextLevelKey) {
                document.getElementById('nextLevelText').textContent = '–ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å!';
                document.getElementById('nextLevelDiscount').textContent = 'üéâ';
                document.getElementById('progressText').textContent = '';
                document.getElementById('progressBar').style.width = '100%';
                return;
            }
            
            const nextLevel = CONFIG.LEVELS[nextLevelKey];
            const progress = Math.min((user.totalSpent / nextLevel.min) * 100, 100);
            
            document.getElementById('nextLevelText').textContent = `–î–æ ${nextLevelKey.charAt(0).toUpperCase() + nextLevelKey.slice(1)}`;
            document.getElementById('nextLevelDiscount').textContent = `—Å–∫–∏–¥–∫–∞ ${nextLevel.discount}%`;
            document.getElementById('progressText').textContent = `$${user.totalSpent.toFixed(0)} / $${nextLevel.min}`;
            document.getElementById('progressBar').style.width = `${progress}%`;
        }

        function renderOrders() {
            try {
                const container = document.getElementById('ordersList');
                const orders = state.user.orders || [];

                if (orders.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8 text-gray-400">
                        <svg class="w-16 h-16 mx-auto mb-4 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
                        </svg>
                        <p>–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –∑–∞–∫–∞–∑–æ–≤</p>
                        <button onclick="showOrderForm()" class="mt-4 px-6 py-2 btn-primary rounded-full text-sm font-medium">
                            –°–æ–∑–¥–∞—Ç—å –ø–µ—Ä–≤—ã–π –∑–∞–∫–∞–∑
                        </button>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = orders.slice().reverse().map(order => {
                const statusClasses = {
                    pending: 'bg-yellow-100 text-yellow-700 border-l-yellow-500',
                    awaiting_manager: 'bg-yellow-100 text-yellow-700 border-l-yellow-500',
                    awaiting_payment: 'bg-orange-100 text-orange-700 border-l-orange-500',
                    pending_verification: 'bg-yellow-100 text-yellow-700 border-l-yellow-500',
                    verifying: 'bg-blue-100 text-blue-700 border-l-blue-500',
                    working: 'bg-blue-100 text-blue-700 border-l-blue-500',
                    completed: 'bg-green-100 text-green-700 border-l-green-500',
                    cancelled: 'bg-red-100 text-red-700 border-l-red-500'
                };
                const statusTexts = {
                    pending: '‚è≥ –û–∂–∏–¥–∞–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏',
                    awaiting_manager: 'üë§ –û–∂–∏–¥–∞–µ—Ç –º–µ–Ω–µ–¥–∂–µ—Ä–∞ (–æ–±—ã—á–Ω–æ 2-4 —á–∞—Å–∞)',
                    awaiting_payment: 'üí≥ –û–∂–∏–¥–∞–µ—Ç –æ–ø–ª–∞—Ç—ã - –ø—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—á–µ—Ç–∞',
                    pending_verification: '‚è≥ –ù–∞ –ø—Ä–æ–≤–µ—Ä–∫–µ –ø–ª–∞—Ç–µ–∂–∞',
                    verifying: 'üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–ø–ª–∞—Ç—É',
                    working: 'üé® –í —Ä–∞–±–æ—Ç–µ - —Å–æ–∑–¥–∞—ë–º –≤–∞—à –∑–∞–∫–∞–∑!',
                    completed: '‚úÖ –ì–æ—Ç–æ–≤–æ - –º–æ–∂–µ—Ç–µ —Å–∫–∞—á–∞—Ç—å',
                    cancelled: '‚ùå –û—Ç–º–µ–Ω—ë–Ω'
                };
                const statusHints = {
                    awaiting_manager: '–ú–µ–Ω–µ–¥–∂–µ—Ä —Å–∫–æ—Ä–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç –≤–∞—à –∑–∞–∫–∞–∑ –∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç —Å—á—ë—Ç –Ω–∞ –æ–ø–ª–∞—Ç—É',
                    awaiting_payment: '–°—á—ë—Ç —Å–æ–∑–¥–∞–Ω! –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤–æ –≤–∫–ª–∞–¥–∫—É "–°—á–µ—Ç–∞" –¥–ª—è –æ–ø–ª–∞—Ç—ã',
                    verifying: '–ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–∞—à—É –æ–ø–ª–∞—Ç—É, –æ–±—ã—á–Ω–æ —ç—Ç–æ –∑–∞–Ω–∏–º–∞–µ—Ç –¥–æ 10 –º–∏–Ω—É—Ç',
                    working: '–í–∞—à –∑–∞–∫–∞–∑ –≤ —Ä–∞–±–æ—Ç–µ! –í—ã –ø–æ–ª—É—á–∏—Ç–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∫–æ–≥–¥–∞ –±—É–¥–µ—Ç –≥–æ—Ç–æ–≤'
                };

                // Fallback –¥–ª—è –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã—Ö —Å—Ç–∞—Ç—É—Å–æ–≤
                const statusClass = statusClasses[order.status] || 'bg-gray-100 text-gray-700 border-l-gray-500';
                const statusText = statusTexts[order.status] || order.status;
                const statusHint = statusHints[order.status] || '';
                const borderClass = statusClass.split(' ').pop();

                // Check if this is a cart order (has items)
                const isCartOrder = Array.isArray(order.items) && order.items.length > 0;

                let orderDetails = '';
                let orderTypeIcon = '';
                if (isCartOrder) {
                    // Show cart items
                    const itemsList = order.items.map(item =>
                        `${item.name} x${item.quantity}`
                    ).join(', ');
                    orderTypeIcon = '<span class="inline-block px-2 py-0.5 bg-purple-100 text-purple-700 rounded text-xs font-medium mr-2">üì¶ –ö–∞—Ç–∞–ª–æ–≥</span>';
                    orderDetails = `
                        ${orderTypeIcon}
                        <h3 class="font-semibold mt-2">–ó–∞–∫–∞–∑ –∏–∑ –∫–æ—Ä–∑–∏–Ω—ã</h3>
                        <p class="text-xs text-gray-500">${itemsList}</p>
                        ${order.comment ? `<p class="text-xs text-gray-400 mt-1">üí¨ ${order.comment}</p>` : ''}
                    `;
                } else {
                    // Show old-style order
                    orderTypeIcon = '<span class="inline-block px-2 py-0.5 bg-blue-100 text-blue-700 rounded text-xs font-medium mr-2">üé® –£—Å–ª—É–≥–∞</span>';
                    let formatsText = '';
                    if (Array.isArray(order.formats)) {
                        formatsText = order.formats.join(', ');
                    } else if (typeof order.formats === 'string') {
                        try {
                            const parsed = JSON.parse(order.formats);
                            formatsText = Array.isArray(parsed) ? parsed.join(', ') : order.formats;
                        } catch {
                            formatsText = order.formats;
                        }
                    } else {
                        formatsText = '–ù–µ —É–∫–∞–∑–∞–Ω–æ';
                    }
                    orderDetails = `
                        ${orderTypeIcon}
                        <h3 class="font-semibold mt-2">${order.service || '–£—Å–ª—É–≥–∞'}</h3>
                        <p class="text-xs text-gray-500">${order.niche || ''} ‚Ä¢ ${formatsText}</p>
                    `;
                }

                return `
                    <div class="card rounded-2xl p-4 border-l-4 ${borderClass}">
                        <div class="flex justify-between items-start mb-3">
                            <div class="flex-1">
                                <span class="text-xs px-2 py-0.5 rounded-full ${statusClass} font-medium">${statusText}</span>
                                ${statusHint ? `<p class="text-xs text-gray-500 mt-2 italic">üí° ${statusHint}</p>` : ''}
                                ${orderDetails}
                            </div>
                            <div class="text-right">
                                <span class="text-lg font-bold">$${(order.total || 0).toFixed(2)}</span>
                                ${order.cashbackEarned ? `<p class="text-xs text-green-600">+$${(order.cashbackEarned || 0).toFixed(2)} –∫–µ—à–±—ç–∫</p>` : ''}
                            </div>
                        </div>
                        ${order.status === 'completed' ? `
                            <div class="flex gap-2 mt-2">
                                ${!order.reviewed ? `<button onclick="showReviewForOrder('${order.id}')" class="text-xs px-3 py-1.5 bg-gray-100 rounded-full hover:bg-gray-200">‚≠ê –û—Ç–∑—ã–≤ (+$2)</button>` : ''}
                                <button onclick="showTipsForOrder('${order.id}')" class="text-xs px-3 py-1.5 bg-green-100 text-green-700 rounded-full hover:bg-green-200">üíù –ß–∞–µ–≤—ã–µ</button>
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
            } catch (error) {
                console.error('Error rendering orders:', error);
                const container = document.getElementById('ordersList');
                if (container) {
                    container.innerHTML = `
                        <div class="text-center py-8 text-red-500">
                            <p>‚ö†Ô∏è –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–∫–∞–∑–æ–≤</p>
                            <button onclick="location.reload()" class="mt-4 px-6 py-2 bg-black text-white rounded-full text-sm">
                                –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É
                            </button>
                        </div>
                    `;
                }
            }
        }

        function renderInvoices() {
            try {
                const container = document.getElementById('invoicesList');
                const invoices = state.user.invoices || [];

                // Count pending invoices for badge
                const pendingCount = invoices.filter(inv => inv.status === 'pending').length;
                const invoicesBadge = document.getElementById('invoicesBadge');
                if (pendingCount > 0) {
                    invoicesBadge.textContent = pendingCount;
                    invoicesBadge.classList.remove('hidden');
                } else {
                    invoicesBadge.classList.add('hidden');
                }

                if (invoices.length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-8 text-gray-400">
                            <svg class="w-16 h-16 mx-auto mb-4 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"></path>
                            </svg>
                            <p>–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç —Å—á–µ—Ç–æ–≤</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = invoices.slice().reverse().map(invoice => {
                    const statusConfig = {
                        pending: { bg: 'bg-yellow-100', text: 'text-yellow-700', border: 'border-l-yellow-500', label: '‚è≥ –û–∂–∏–¥–∞–µ—Ç –æ–ø–ª–∞—Ç—ã', btn: 'bg-green-600 hover:bg-green-700' },
                        verifying: { bg: 'bg-blue-100', text: 'text-blue-700', border: 'border-l-blue-500', label: 'üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–ª–∞—Ç–µ–∂–∞', btn: 'bg-gray-400 cursor-not-allowed' },
                        paid: { bg: 'bg-green-100', text: 'text-green-700', border: 'border-l-green-500', label: '‚úÖ –û–ø–ª–∞—á–µ–Ω–æ', btn: '' },
                        cancelled: { bg: 'bg-red-100', text: 'text-red-700', border: 'border-l-red-500', label: '‚ùå –û—Ç–º–µ–Ω—ë–Ω', btn: '' }
                    };

                    const status = statusConfig[invoice.status] || statusConfig.pending;
                    const date = new Date(invoice.created_at).toLocaleString('ru-RU', {
                        day: '2-digit',
                        month: '2-digit',
                        year: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });

                    let paymentButton = '';
                    if (invoice.status === 'pending') {
                        paymentButton = `
                            <button onclick="window.location.hash='invoice_${invoice.id}'; location.reload();"
                                    class="w-full ${status.btn} text-white py-3 rounded-xl font-medium transition-colors">
                                üí≥ –û–ø–ª–∞—Ç–∏—Ç—å —Å—á—ë—Ç
                            </button>
                        `;
                    } else if (invoice.status === 'verifying') {
                        paymentButton = `
                            <button disabled class="w-full ${status.btn} text-white py-3 rounded-xl font-medium opacity-50">
                                ‚è≥ –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–ª–∞—Ç—ë–∂...
                            </button>
                        `;
                    } else if (invoice.status === 'paid' && invoice.tx_hash) {
                        paymentButton = `
                            <a href="https://tronscan.org/#/transaction/${invoice.tx_hash}"
                               target="_blank"
                               class="block w-full bg-gray-100 text-gray-700 py-2 rounded-lg text-xs font-medium text-center hover:bg-gray-200 transition-colors">
                                üîó –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é
                            </a>
                        `;
                    }

                    return `
                        <div class="card rounded-2xl p-4 border-l-4 ${status.border}">
                            <div class="flex justify-between items-start mb-3">
                                <div class="flex-1">
                                    <span class="text-xs px-2 py-0.5 rounded-full ${status.bg} ${status.text} font-medium">${status.label}</span>
                                    <h3 class="font-semibold mt-2">–°—á—ë—Ç #${invoice.id}</h3>
                                    <p class="text-xs text-gray-500">${date}</p>
                                    ${invoice.order_id ? `<p class="text-xs text-gray-400 mt-1">–ó–∞–∫–∞–∑: ${invoice.order_id}</p>` : ''}
                                </div>
                                <div class="text-right">
                                    <span class="text-xl font-bold">${invoice.amount.toFixed(2)}</span>
                                    <p class="text-xs text-gray-500">USDT</p>
                                </div>
                            </div>
                            ${paymentButton}
                        </div>
                    `;
                }).join('');

            } catch (error) {
                console.error('Error rendering invoices:', error);
                const container = document.getElementById('invoicesList');
                if (container) {
                    container.innerHTML = `
                        <div class="text-center py-8 text-red-500">
                            <p>‚ö†Ô∏è –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—á–µ—Ç–æ–≤</p>
                            <button onclick="location.reload()" class="mt-4 px-6 py-2 bg-black text-white rounded-full text-sm">
                                –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É
                            </button>
                        </div>
                    `;
                }
            }
        }

        function renderStats() {
            const user = state.user;
            const level = CONFIG.LEVELS[user.level] || CONFIG.LEVELS.none;
            const saved = user.totalSpent * (level.discount / 100);
            
            document.getElementById('statsContent').innerHTML = `
                <div class="flex justify-between items-center">
                    <span class="text-gray-600">–í—Å–µ–≥–æ –∑–∞–∫–∞–∑–æ–≤</span>
                    <span class="font-bold">${user.orders.length}</span>
                </div>
                <div class="flex justify-between items-center">
                    <span class="text-gray-600">–ü–æ—Ç—Ä–∞—á–µ–Ω–æ</span>
                    <span class="font-bold">$${user.totalSpent.toFixed(2)}</span>
                </div>
                <div class="flex justify-between items-center">
                    <span class="text-gray-600">–°—ç–∫–æ–Ω–æ–º–ª–µ–Ω–æ (—Å–∫–∏–¥–∫–∏)</span>
                    <span class="font-bold text-green-600">$${saved.toFixed(2)}</span>
                </div>
                <div class="flex justify-between items-center">
                    <span class="text-gray-600">–ö–µ—à–±—ç–∫ –ø–æ–ª—É—á–µ–Ω–æ</span>
                    <span class="font-bold text-green-600">$${user.cashbackHistory.filter(h => h.amount > 0).reduce((a, b) => a + b.amount, 0).toFixed(2)}</span>
                </div>
                <div class="flex justify-between items-center">
                    <span class="text-gray-600">–ó–∞—Ä–∞–±–æ—Ç–æ–∫ —Å —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤</span>
                    <span class="font-bold text-green-600">$${user.referralEarnings.toFixed(2)}</span>
                </div>
            `;
        }

        function renderAchievements() {
            const user = state.user;
            const achievements = [
                { id: 'first', icon: 'üéØ', name: '–ü–µ—Ä–≤—ã–π –∑–∞–∫–∞–∑', desc: '1 –∑–∞–∫–∞–∑', unlocked: user.orders.length >= 1 },
                { id: 'vip', icon: 'üèÜ', name: 'VIP', desc: '10+ –∑–∞–∫–∞–∑–æ–≤', unlocked: user.orders.length >= 10 },
                { id: 'reviewer', icon: '‚≠ê', name: '–û—Ç–∑—ã–≤—á–∏–≤—ã–π', desc: '5 –æ—Ç–∑—ã–≤–æ–≤', unlocked: user.orders.filter(o => o.reviewed).length >= 5 },
                { id: 'networker', icon: 'ü§ù', name: '–ù–µ—Ç–≤–æ—Ä–∫–µ—Ä', desc: '3+ —Ä–µ—Ñ–µ—Ä–∞–ª–∞', unlocked: user.referrals.length >= 3 },
                { id: 'bronze', icon: 'ü•â', name: 'Bronze', desc: '$100+ –∑–∞–∫–∞–∑–æ–≤', unlocked: user.totalSpent >= 100 },
                { id: 'silver', icon: 'ü•à', name: 'Silver', desc: '$500+ –∑–∞–∫–∞–∑–æ–≤', unlocked: user.totalSpent >= 500 },
                { id: 'gold', icon: 'ü•á', name: 'Gold', desc: '$1000+ –∑–∞–∫–∞–∑–æ–≤', unlocked: user.totalSpent >= 1000 },
                { id: 'platinum', icon: 'üíé', name: 'Platinum', desc: '$10,000+', unlocked: user.totalSpent >= 10000 },
            ];
            
            document.getElementById('achievementsList').innerHTML = achievements.map(a => `
                <div class="card rounded-2xl p-3 text-center ${!a.unlocked ? 'opacity-40' : ''}">
                    <div class="w-12 h-12 mx-auto rounded-full ${a.unlocked ? 'badge-gold' : 'bg-gray-200'} flex items-center justify-center text-2xl mb-2">${a.unlocked ? a.icon : 'üîí'}</div>
                    <p class="text-xs font-medium">${a.name}</p>
                    <p class="text-[10px] text-gray-400">${a.desc}</p>
                </div>
            `).join('');
        }

        function renderPrices() {
            const level = CONFIG.LEVELS[state.user?.level] || CONFIG.LEVELS.none;
            const discountEl = document.getElementById('priceDiscount');
            const listEl = document.getElementById('pricesList');

            if (discountEl) {
                discountEl.textContent = `-${level.discount}%`;
            }

            if (listEl) {
                listEl.innerHTML = CONFIG.PRICES.map(p => {
                    const discounted = p.price * (1 - level.discount / 100);
                    return `
                        <div class="flex justify-between items-center py-3 border-b border-gray-100">
                            <div>
                                <p class="font-medium">${p.name}</p>
                                <p class="text-xs text-gray-400">${p.desc}</p>
                            </div>
                            <div class="text-right">
                                ${level.discount > 0 ? `<p class="text-gray-400 line-through text-sm">$${p.price}</p>` : ''}
                                <p class="font-bold text-green-600">$${discounted.toFixed(2)}</p>
                            </div>
                        </div>
                    `;
                }).join('');
            }
        }

        // ==================== MODALS ====================
        function showModal(modalId) {
            document.getElementById('modalOverlay').classList.remove('hidden');
            document.getElementById(modalId).classList.remove('hidden');
            document.getElementById(modalId).classList.add('slide-up');
            if (tg) tg.BackButton.show();
        }

        function closeModal() {
            document.getElementById('modalOverlay').classList.add('hidden');
            document.querySelectorAll('[id$="Modal"]').forEach(modal => {
                modal.classList.add('hidden');
            });
            if (tg) tg.BackButton.hide();
        }

        function showOrderForm() { showModal('orderModal'); updatePrice(); }
        function showTips() { showModal('tipsModal'); }
        function showReferral() { 
            showModal('referralModal');
            document.getElementById('refCountModal').textContent = state.user.referrals.length;
            document.getElementById('refEarningsModal').textContent = `$${state.user.referralEarnings.toFixed(2)}`;
        }
        function showSettings() { showModal('settingsModal'); }
        function showGallery() { showModal('galleryModal'); }
        function showPrices() { showModal('pricesModal'); }
        function showReview() { showModal('reviewModal'); }
        function showCashbackHistory() { 
            showModal('cashbackModal');
            document.getElementById('cashbackModalBalance').textContent = `$${state.user.cashback.toFixed(2)}`;
            renderCashbackHistory();
        }
        function showNotifications() {
            showModal('notifModal');
            renderNotifications();
            state.user.notifications.forEach(n => n.read = true);
            saveUserData();
            document.getElementById('notifBadge').classList.add('hidden');
        }

        function showChat() {
            if (tg) {
                tg.openTelegramLink(`https://t.me/${CONFIG.MANAGER_USERNAME}`);
            } else {
                window.open(`https://t.me/${CONFIG.MANAGER_USERNAME}`, '_blank');
            }
        }

        function showReviewForOrder(orderId) {
            document.getElementById('reviewOrderId').value = orderId;
            showModal('reviewModal');
        }

        function showTipsForOrder(orderId) {
            showModal('tipsModal');
        }

        function renderCashbackHistory() {
            const history = state.user.cashbackHistory || [];
            document.getElementById('cashbackHistory').innerHTML = history.length === 0 
                ? '<p class="text-center text-gray-400 py-4">–ò—Å—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞</p>'
                : history.slice().reverse().map(h => `
                    <div class="flex justify-between items-center py-3 border-b border-gray-100">
                        <div>
                            <p class="font-medium text-sm">${h.description}</p>
                            <p class="text-xs text-gray-400">${new Date(h.date).toLocaleDateString('ru-RU')}</p>
                        </div>
                        <span class="${h.amount > 0 ? 'text-green-600' : 'text-red-500'} font-medium">${h.amount > 0 ? '+' : ''}$${h.amount.toFixed(2)}</span>
                    </div>
                `).join('');
        }

        function renderNotifications() {
            const notifs = state.user.notifications || [];
            document.getElementById('notificationsList').innerHTML = notifs.length === 0 
                ? '<p class="text-center text-gray-400 py-4">–ù–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π</p>'
                : notifs.slice().reverse().map(n => `
                    <div class="card rounded-xl p-4 ${n.read ? 'opacity-60' : ''}">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="font-medium text-sm">${n.title}</p>
                                <p class="text-xs text-gray-500 mt-1">${n.message}</p>
                            </div>
                            <span class="text-xs text-gray-400">${timeAgo(n.date)}</span>
                        </div>
                    </div>
                `).join('');
        }

        // ==================== TABS ====================
        function switchTab(tabName) {
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('tab-active');
                btn.classList.add('bg-gray-100');
            });
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('tab-active');
            document.querySelector(`[data-tab="${tabName}"]`).classList.remove('bg-gray-100');
            
            document.querySelectorAll('#tabContent > div').forEach(tab => tab.classList.add('hidden'));
            document.getElementById(`${tabName}Tab`).classList.remove('hidden');
        }

        // ==================== ORDER FORM ====================
        let selectedFormats = [];
        let uploadedFiles = [];
        let appliedPromo = null; // {code: 'SUMMER', discount: 10}

        function toggleFormat(btn) {
            const format = btn.textContent;
            if (selectedFormats.includes(format)) {
                selectedFormats = selectedFormats.filter(f => f !== format);
                btn.classList.remove('bg-black', 'text-white');
                btn.classList.add('bg-gray-100');
            } else {
                selectedFormats.push(format);
                btn.classList.add('bg-black', 'text-white');
                btn.classList.remove('bg-gray-100');
            }
        }

        async function handleFileSelect(input) {
            const files = Array.from(input.files);
            const preview = document.getElementById('filePreview');
            preview.innerHTML = '';
            uploadedFiles = [];

            if (files.length === 0) return;

            showToast('üìé –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–∞–π–ª–æ–≤...');

            for (const file of files) {
                // Check file size (max 10MB)
                if (file.size > 10 * 1024 * 1024) {
                    showToast(`‚ùå –§–∞–π–ª "${file.name}" —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π (–º–∞–∫—Å 10MB)`);
                    continue;
                }

                try {
                    // Convert to base64
                    const base64 = await fileToBase64(file);

                    uploadedFiles.push({
                        name: file.name,
                        type: file.type,
                        size: file.size,
                        data: base64
                    });

                    // Add preview
                    const previewItem = document.createElement('div');
                    previewItem.className = 'relative bg-gray-100 rounded-lg p-2 text-center';

                    if (file.type.startsWith('image/')) {
                        previewItem.innerHTML = `
                            <img src="${base64}" class="w-full h-20 object-cover rounded mb-1">
                            <p class="text-xs truncate">${file.name}</p>
                        `;
                    } else {
                        const icon = file.type.startsWith('video/') ? 'üé•' : 'üìÑ';
                        previewItem.innerHTML = `
                            <div class="text-3xl mb-1">${icon}</div>
                            <p class="text-xs truncate">${file.name}</p>
                        `;
                    }

                    preview.appendChild(previewItem);
                } catch (error) {
                    console.error('File processing error:', error);
                    showToast(`‚ùå –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ "${file.name}"`);
                }
            }

            showToast(`‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ —Ñ–∞–π–ª–æ–≤: ${uploadedFiles.length}`);
        }

        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        function updatePrice() {
            const basePrice = parseFloat(document.getElementById('serviceType').value);
            const level = CONFIG.LEVELS[state.user?.level] || CONFIG.LEVELS.none;
            const discount = level.discount;
            const discountAmount = basePrice * (discount / 100);
            let afterDiscount = basePrice - discountAmount;

            // Check if user is eligible for referral discount (first order)
            const isReferred = state.user && state.user.orders && state.user.orders.length === 0 && state.user.referredBy;
            let referralDiscountAmount = 0;
            if (isReferred) {
                referralDiscountAmount = afterDiscount * 0.25; // 25% referral discount
                afterDiscount -= referralDiscountAmount;
            }

            // Apply promo code
            let promoDiscountAmount = 0;
            if (appliedPromo) {
                promoDiscountAmount = afterDiscount * (appliedPromo.discount / 100);
                afterDiscount -= promoDiscountAmount;
            }

            let cashbackUsed = 0;
            const useCashback = document.getElementById('useCashback').checked;
            if (useCashback && state.user) {
                const maxCashback = afterDiscount * CONFIG.MAX_CASHBACK_USAGE;
                cashbackUsed = Math.min(state.user.cashback, maxCashback);
            }

            const total = afterDiscount - cashbackUsed;
            const earnedCashback = total * (CONFIG.CASHBACK_PERCENT / 100);

            document.getElementById('orderPrice').textContent = `$${basePrice.toFixed(2)}`;
            document.getElementById('discountLevel').textContent = state.user?.level || 'New';
            document.getElementById('discountPercent').textContent = discount;
            document.getElementById('orderDiscount').textContent = `-$${discountAmount.toFixed(2)}`;
            document.getElementById('orderTotal').textContent = `$${total.toFixed(2)}`;
            document.getElementById('orderCashback').textContent = `+$${earnedCashback.toFixed(2)}`;

            if (useCashback && cashbackUsed > 0) {
                document.getElementById('cashbackApplied').classList.remove('hidden');
                document.getElementById('cashbackAmount').textContent = `-$${cashbackUsed.toFixed(2)}`;
            } else {
                document.getElementById('cashbackApplied').classList.add('hidden');
            }

            // Show referral discount if applied
            if (isReferred && referralDiscountAmount > 0) {
                document.getElementById('referralDiscountApplied').classList.remove('hidden');
                document.getElementById('referralDiscountAmount').textContent = `-$${referralDiscountAmount.toFixed(2)}`;
            } else {
                document.getElementById('referralDiscountApplied').classList.add('hidden');
            }

            // Show promo discount if applied
            if (appliedPromo) {
                document.getElementById('promoApplied').classList.remove('hidden');
                document.getElementById('appliedPromoCode').textContent = appliedPromo.code;
                document.getElementById('promoDiscount').textContent = `-$${promoDiscountAmount.toFixed(2)}`;
            } else {
                document.getElementById('promoApplied').classList.add('hidden');
            }
        }

        async function applyPromoCode() {
            const code = document.getElementById('promoCodeInput').value.trim().toUpperCase();

            if (!code) {
                showToast('–í–≤–µ–¥–∏—Ç–µ –ø—Ä–æ–º–æ–∫–æ–¥');
                return;
            }

            try {
                showToast('–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ–º–æ–∫–æ–¥–∞...');
                const result = await apiRequest(`/api/promo/${code}`);

                if (result && result.valid) {
                    appliedPromo = {
                        code: result.code,
                        discount: result.discount
                    };
                    showToast(`‚úÖ –ü—Ä–æ–º–æ–∫–æ–¥ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω! –°–∫–∏–¥–∫–∞ ${result.discount}%`);
                    updatePrice();
                } else {
                    showToast(`‚ùå ${result.error || '–ü—Ä–æ–º–æ–∫–æ–¥ –Ω–µ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω'}`);
                }
            } catch (error) {
                console.error('Promo check error:', error);
                showToast('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–æ–º–æ–∫–æ–¥–∞');
            }
        }

        function proceedToPayment() {
            const serviceSelect = document.getElementById('serviceType');
            const basePrice = parseFloat(serviceSelect.value);
            const level = CONFIG.LEVELS[state.user?.level] || CONFIG.LEVELS.none;
            const discountAmount = basePrice * (level.discount / 100);
            let afterDiscount = basePrice - discountAmount;

            // Check if user is eligible for referral discount (first order)
            const isReferred = state.user && state.user.orders && state.user.orders.length === 0 && state.user.referredBy;
            let referralDiscountAmount = 0;
            if (isReferred) {
                referralDiscountAmount = afterDiscount * 0.25; // 25% referral discount
                afterDiscount -= referralDiscountAmount;
            }

            // Apply promo code
            let promoDiscountAmount = 0;
            if (appliedPromo) {
                promoDiscountAmount = afterDiscount * (appliedPromo.discount / 100);
                afterDiscount -= promoDiscountAmount;
            }

            let cashbackUsed = 0;
            if (document.getElementById('useCashback').checked) {
                const maxCashback = afterDiscount * CONFIG.MAX_CASHBACK_USAGE;
                cashbackUsed = Math.min(state.user.cashback, maxCashback);
            }

            const total = afterDiscount - cashbackUsed;
            const cashbackEarned = total * (CONFIG.CASHBACK_PERCENT / 100);

            const order = {
                id: 'ORD' + Date.now(),
                service: serviceSelect.options[serviceSelect.selectedIndex].text.split('(')[0].trim(),
                niche: document.getElementById('nicheType').value,
                formats: selectedFormats.length > 0 ? selectedFormats : ['–ù–µ —É–∫–∞–∑–∞–Ω–æ'],
                description: document.getElementById('orderDescription').value,
                refs: document.getElementById('orderRefs').value,
                media: uploadedFiles, // Array of uploaded files with base64 data
                basePrice,
                discount: discountAmount,
                referralDiscount: referralDiscountAmount,
                promoCode: appliedPromo ? appliedPromo.code : null,
                promoDiscount: promoDiscountAmount,
                cashbackUsed,
                total,
                cashbackEarned,
                status: 'pending',
                reviewed: false,
                createdAt: new Date().toISOString()
            };

            closeModal();
            setTimeout(() => {
                showPayment(total, order);
            }, 300);
        }

        function updateUserLevel() {
            const spent = state.user.totalSpent;
            let newLevel = 'none';
            
            if (spent >= 10000) newLevel = 'platinum';
            else if (spent >= 1000) newLevel = 'gold';
            else if (spent >= 500) newLevel = 'silver';
            else if (spent >= 100) newLevel = 'bronze';
            
            if (newLevel !== state.user.level && newLevel !== 'none') {
                state.user.level = newLevel;
                state.user.notifications.push({
                    title: 'üéâ –ù–æ–≤—ã–π —É—Ä–æ–≤–µ–Ω—å!',
                    message: `–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º! –¢–µ–ø–µ—Ä—å –≤—ã ${newLevel.charAt(0).toUpperCase() + newLevel.slice(1)}. –°–∫–∏–¥–∫–∞ ${CONFIG.LEVELS[newLevel].discount}%`,
                    date: new Date().toISOString(),
                    read: false
                });
            }
        }

        // ==================== REVIEW ====================
        let currentRating = 0;

        function setRating(rating) {
            currentRating = rating;
            document.querySelectorAll('.rating-star').forEach((star, index) => {
                star.classList.toggle('text-yellow-400', index < rating);
                star.classList.toggle('text-gray-300', index >= rating);
            });
        }

        function submitReview() {
            if (currentRating === 0) {
                showToast('–ü–æ—Å—Ç–∞–≤—å—Ç–µ –æ—Ü–µ–Ω–∫—É');
                return;
            }
            
            const orderId = document.getElementById('reviewOrderId').value;
            const reviewText = document.getElementById('reviewText').value;
            
            const order = state.user.orders.find(o => o.id === orderId);
            if (order) order.reviewed = true;
            
            state.user.cashback += CONFIG.REVIEW_BONUS;
            state.user.cashbackHistory.push({
                amount: CONFIG.REVIEW_BONUS,
                description: '–ë–æ–Ω—É—Å –∑–∞ –æ—Ç–∑—ã–≤',
                date: new Date().toISOString()
            });
            
            saveUserData();
            updateUI();
            
            currentRating = 0;
            document.querySelectorAll('.rating-star').forEach(star => {
                star.classList.add('text-gray-300');
                star.classList.remove('text-yellow-400');
            });
            document.getElementById('reviewText').value = '';
            document.getElementById('reviewOrderId').value = '';
            
            closeModal();
            showToast(`‚≠ê –°–ø–∞—Å–∏–±–æ –∑–∞ –æ—Ç–∑—ã–≤! +$${CONFIG.REVIEW_BONUS} –Ω–∞ –∫–µ—à–±—ç–∫`);
            
            if (tg) tg.HapticFeedback.notificationOccurred('success');
        }

        // ==================== TIPS ====================
        let selectedTip = 0;

        function selectTip(amount) {
            selectedTip = amount;
            document.querySelectorAll('.tip-btn').forEach(btn => {
                btn.classList.remove('bg-black', 'text-white');
                btn.classList.add('bg-gray-100');
            });
            event.target.classList.add('bg-black', 'text-white');
            event.target.classList.remove('bg-gray-100');
            document.getElementById('customTip').value = '';
        }

        function sendTip() {
            const customTip = document.getElementById('customTip').value;
            const amount = customTip ? parseFloat(customTip) : selectedTip;
            
            if (amount <= 0) {
                showToast('–í—ã–±–µ—Ä–∏—Ç–µ —Å—É–º–º—É');
                return;
            }
            
            closeModal();
            showToast(`üíù –û—Ç–∫—Ä—ã—Ç–∏–µ –æ–ø–ª–∞—Ç—ã $${amount}...`);
            
            selectedTip = 0;
            document.querySelectorAll('.tip-btn').forEach(btn => {
                btn.classList.remove('bg-black', 'text-white');
                btn.classList.add('bg-gray-100');
            });
            document.getElementById('customTip').value = '';
            document.getElementById('tipMessage').value = '';
        }

        // ==================== PROMO ====================
        function applyPromo() {
            const promo = document.getElementById('promoInput').value.trim();
            if (!promo) return;
            
            showToast('‚úÖ –ü—Ä–æ–º–æ–∫–æ–¥ –ø—Ä–∏–º–µ–Ω—ë–Ω!');
            document.getElementById('promoInput').value = '';
            
            if (tg) tg.HapticFeedback.notificationOccurred('success');
        }

        function copyPromo() {
            navigator.clipboard.writeText(state.user.referralCode);
            showToast('üìã –ü—Ä–æ–º–æ–∫–æ–¥ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω!');
            if (tg) tg.HapticFeedback.impactOccurred('light');
        }

        function copyRefLink() {
            const link = `t.me/${CONFIG.BOT_USERNAME}?start=${state.user.referralCode}`;
            navigator.clipboard.writeText(link);
            showToast('üìã –°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞!');
            if (tg) tg.HapticFeedback.impactOccurred('light');
        }

        function shareRefLink() {
            const link = `t.me/${CONFIG.BOT_USERNAME}?start=${state.user.referralCode}`;
            const text = `–ö—Ä—É—Ç—ã–µ –∫—Ä–µ–∞—Ç–∏–≤—ã –¥–ª—è —Ä–µ–∫–ª–∞–º—ã! -15% –Ω–∞ –ø–µ—Ä–≤—ã–π –∑–∞–∫–∞–∑ üëâ`;
            
            if (tg) {
                tg.openTelegramLink(`https://t.me/share/url?url=${encodeURIComponent(link)}&text=${encodeURIComponent(text)}`);
            } else {
                navigator.clipboard.writeText(`${text} ${link}`);
                showToast('üìã –°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞!');
            }
        }

        // ==================== SETTINGS ====================
        function saveSettings() {
            state.user.name = document.getElementById('settingsName').value;
            state.user.trc20Wallet = document.getElementById('trc20Wallet').value;
            state.user.settings.notifOrders = document.getElementById('notifOrders').checked;
            state.user.settings.notifPromo = document.getElementById('notifPromo').checked;
            state.user.settings.notifRef = document.getElementById('notifRef').checked;

            saveUserData();
            updateUI();
            closeModal();
            showToast('‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã');

            if (tg) tg.HapticFeedback.notificationOccurred('success');
        }

        // ==================== WITHDRAWALS ====================
        let withdrawalHistoryData = [];
        let currentWithdrawalFilter = 'all';

        async function requestWithdrawal(type) {
            try {
                // Check if wallet is configured
                if (!state.user.trc20Wallet || state.user.trc20Wallet.trim() === '') {
                    showToast('‚ö†Ô∏è –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –¥–æ–±–∞–≤—å—Ç–µ TRC-20 –∫–æ—à–µ–ª–µ–∫ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö');
                    if (tg) tg.HapticFeedback.notificationOccurred('warning');
                    return;
                }

                // Get balance
                const balance = type === 'cashback' ? (state.user.cashback || 0) : (state.user.referral_earnings || 0);
                const balanceLabel = type === 'cashback' ? '–∫–µ—à–±—ç–∫–∞' : '—Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–≥–æ –¥–æ—Ö–æ–¥–∞';

                // Check if balance is sufficient
                if (balance <= 0) {
                    showToast(`‚ö†Ô∏è –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤ –¥–ª—è –≤—ã–ø–ª–∞—Ç—ã ${balanceLabel}`);
                    if (tg) tg.HapticFeedback.notificationOccurred('warning');
                    return;
                }

                // Ask for confirmation
                const confirmed = confirm(
                    `–ó–∞–ø—Ä–æ—Å–∏—Ç—å –≤—ã–ø–ª–∞—Ç—É ${balanceLabel}?\n\n` +
                    `–°—É–º–º–∞: $${balance.toFixed(2)}\n` +
                    `–ö–æ—à–µ–ª–µ–∫: ${state.user.trc20Wallet}\n\n` +
                    `–í—ã–ø–ª–∞—Ç–∞ –±—É–¥–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∞–Ω–∞ –≤ —Ç–µ—á–µ–Ω–∏–µ 24 —á–∞—Å–æ–≤.`
                );

                if (!confirmed) return;

                // Send withdrawal request
                const response = await apiRequest('/api/withdrawal-request', 'POST', {
                    type: type,
                    amount: balance
                });

                if (response.error === 'no_wallet') {
                    showToast('‚ö†Ô∏è –î–æ–±–∞–≤—å—Ç–µ TRC-20 –∫–æ—à–µ–ª–µ–∫ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö');
                    if (tg) tg.HapticFeedback.notificationOccurred('warning');
                    return;
                }

                if (response.error === 'insufficient_balance') {
                    showToast(`‚ö†Ô∏è –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤ –¥–ª—è –≤—ã–ø–ª–∞—Ç—ã`);
                    if (tg) tg.HapticFeedback.notificationOccurred('warning');
                    return;
                }

                if (response.success) {
                    showToast('‚úÖ –ó–∞–ø—Ä–æ—Å –Ω–∞ –≤—ã–ø–ª–∞—Ç—É –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω! –û–∂–∏–¥–∞–π—Ç–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏.');
                    if (tg) tg.HapticFeedback.notificationOccurred('success');

                    // Refresh user data
                    await loadUserData();
                } else {
                    throw new Error(response.message || '–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–ø—Ä–æ—Å–∞');
                }

            } catch (error) {
                console.error('Withdrawal request error:', error);
                showToast('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∑–∞–ø—Ä–æ—Å–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.');
                if (tg) tg.HapticFeedback.notificationOccurred('error');
            }
        }

        async function showWithdrawalHistory() {
            showModal('withdrawalHistoryModal');
            currentWithdrawalFilter = 'all';

            // Reset filter buttons
            document.querySelectorAll('.withdrawal-filter-btn').forEach(btn => {
                if (btn.dataset.filter === 'all') {
                    btn.classList.add('bg-black', 'text-white');
                    btn.classList.remove('bg-gray-200', 'text-gray-700');
                } else {
                    btn.classList.remove('bg-black', 'text-white');
                    btn.classList.add('bg-gray-200', 'text-gray-700');
                }
            });

            try {
                withdrawalHistoryData = await apiRequest('/api/withdrawals');
                renderWithdrawalHistory();
            } catch (error) {
                console.error('Error loading withdrawal history:', error);
                document.getElementById('withdrawalHistoryList').innerHTML =
                    '<div class="text-center text-red-500 py-8">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏</div>';
            }
        }

        function filterWithdrawals(filter) {
            currentWithdrawalFilter = filter;

            // Update button styles
            document.querySelectorAll('.withdrawal-filter-btn').forEach(btn => {
                if (btn.dataset.filter === filter) {
                    btn.classList.add('bg-black', 'text-white');
                    btn.classList.remove('bg-gray-200', 'text-gray-700');
                } else {
                    btn.classList.remove('bg-black', 'text-white');
                    btn.classList.add('bg-gray-200', 'text-gray-700');
                }
            });

            renderWithdrawalHistory();
        }

        function renderWithdrawalHistory() {
            const container = document.getElementById('withdrawalHistoryList');

            // Filter withdrawals
            let filtered = withdrawalHistoryData;
            if (currentWithdrawalFilter !== 'all') {
                filtered = withdrawalHistoryData.filter(w => w.status === currentWithdrawalFilter);
            }

            if (filtered.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-500 py-8">–ù–µ—Ç –≤—ã–ø–ª–∞—Ç</div>';
                return;
            }

            const statusConfig = {
                pending: { label: '–í –æ–±—Ä–∞–±–æ—Ç–∫–µ', color: 'bg-yellow-100 text-yellow-700', icon: '‚è≥' },
                completed: { label: '–í—ã–ø–ª–∞—á–µ–Ω–æ', color: 'bg-green-100 text-green-700', icon: '‚úÖ' },
                cancelled: { label: '–û—Ç–º–µ–Ω–µ–Ω–æ', color: 'bg-red-100 text-red-700', icon: '‚ùå' }
            };

            const typeConfig = {
                cashback: { label: '–ö–µ—à–±—ç–∫', icon: 'üí∞' },
                referral: { label: '–†–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–π', icon: 'üë•' }
            };

            container.innerHTML = filtered.map(w => {
                const status = statusConfig[w.status] || statusConfig.pending;
                const type = typeConfig[w.type] || typeConfig.cashback;
                const date = new Date(w.created_at).toLocaleString('ru-RU', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });

                let txHashHTML = '';
                if (w.tx_hash) {
                    txHashHTML = `
                        <div class="mt-2 pt-2 border-t border-gray-200">
                            <p class="text-xs text-gray-500">TxHash:</p>
                            <a href="https://tronscan.org/#/transaction/${w.tx_hash}"
                               target="_blank"
                               class="text-xs font-mono text-blue-600 hover:underline break-all">
                                ${w.tx_hash}
                            </a>
                        </div>
                    `;
                }

                return `
                    <div class="card rounded-xl p-4 border border-gray-200">
                        <div class="flex items-start justify-between mb-2">
                            <div class="flex-1">
                                <div class="flex items-center gap-2 mb-1">
                                    <span class="text-lg">${type.icon}</span>
                                    <span class="font-medium text-sm">${type.label}</span>
                                    <span class="${status.color} px-2 py-0.5 rounded-full text-xs font-medium">
                                        ${status.icon} ${status.label}
                                    </span>
                                </div>
                                <p class="text-xs text-gray-500">${date}</p>
                            </div>
                            <div class="text-right">
                                <p class="text-xl font-bold text-green-600">$${w.amount.toFixed(2)}</p>
                            </div>
                        </div>
                        <div class="text-xs text-gray-600 mt-2">
                            <p class="font-mono truncate">–ö–æ—à–µ–ª–µ–∫: ${w.wallet_address}</p>
                        </div>
                        ${txHashHTML}
                    </div>
                `;
            }).join('');
        }

        // ==================== UTILS ====================
        function showToast(message) {
            const toast = document.getElementById('toast');
            document.getElementById('toastMessage').textContent = message;
            toast.classList.remove('hidden');
            setTimeout(() => toast.classList.add('hidden'), 2500);
        }

        function timeAgo(date) {
            const seconds = Math.floor((new Date() - new Date(date)) / 1000);
            if (seconds < 60) return '—Ç–æ–ª—å–∫–æ —á—Ç–æ';
            if (seconds < 3600) return `${Math.floor(seconds / 60)} –º–∏–Ω`;
            if (seconds < 86400) return `${Math.floor(seconds / 3600)} —á–∞—Å`;
            return `${Math.floor(seconds / 86400)} –¥–Ω`;
        }

        // ==================== INIT ====================
        async function init() {
            initTelegram();

            // Load user data, app settings, and products in parallel
            await Promise.all([
                loadUserData(),
                loadAppSettings(),
                loadProducts()
            ]);

            // Render catalog
            renderCatalog();

            // Load cart from localStorage
            const savedCart = localStorage.getItem('whiteagency_cart');
            if (savedCart) {
                state.cart = JSON.parse(savedCart);
                updateCartBadge();
            }

            document.getElementById('loadingScreen').style.display = 'none';
            state.isLoading = false;
        }

        // ==================== CATALOG & CART ====================

        function renderCatalog() {
            const container = document.getElementById('catalogProducts');
            const products = state.products.length > 0 ? state.products : CONFIG.PRICES.map((p, i) => ({
                id: i,
                name: p.name,
                desc: p.desc,
                price: p.price,
                icon: ['üé®', 'üé¨', 'üé•', 'üó£Ô∏è', 'ü§ñ', 'üìπ', '‚ú®', 'üíª'][i] || 'üé®'
            }));

            container.innerHTML = products.map((product, index) => {
                return `
                    <div class="card rounded-2xl p-4 hover:shadow-lg transition-shadow">
                        <div class="flex gap-4">
                            <div class="w-16 h-16 bg-gradient-to-br from-gray-800 to-black rounded-xl flex items-center justify-center text-3xl flex-shrink-0">
                                ${product.icon}
                            </div>
                            <div class="flex-1">
                                <h3 class="font-semibold text-base mb-1">${product.name}</h3>
                                <p class="text-xs text-gray-500 mb-2">${product.desc}</p>
                                <div class="flex items-center justify-between">
                                    <span class="text-2xl font-bold">$${product.price}</span>
                                    <button onclick="addToCart(${product.id})" class="px-4 py-2 bg-black text-white rounded-lg text-sm font-medium hover:bg-gray-800 transition-colors">
                                        + –í –∫–æ—Ä–∑–∏–Ω—É
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function addToCart(productId) {
            const product = state.products.find(p => p.id === productId);
            if (!product) return;

            const existingItem = state.cart.find(item => item.productId === productId);

            if (existingItem) {
                existingItem.quantity++;
            } else {
                state.cart.push({
                    productId: productId,
                    name: product.name,
                    desc: product.desc,
                    price: product.price,
                    quantity: 1
                });
            }

            saveCart();
            updateCartBadge();
            showToast(`${product.name} –¥–æ–±–∞–≤–ª–µ–Ω –≤ –∫–æ—Ä–∑–∏–Ω—É`);
        }

        function removeFromCart(productId) {
            state.cart = state.cart.filter(item => item.productId !== productId);
            saveCart();
            updateCartBadge();
            renderCart();
        }

        function updateCartQuantity(productId, delta) {
            const item = state.cart.find(i => i.productId === productId);
            if (!item) return;

            item.quantity += delta;
            if (item.quantity <= 0) {
                removeFromCart(productId);
            } else {
                saveCart();
                renderCart();
            }
        }

        function saveCart() {
            localStorage.setItem('whiteagency_cart', JSON.stringify(state.cart));
        }

        function updateCartBadge() {
            const badge = document.getElementById('cartBadge');
            const totalItems = state.cart.reduce((sum, item) => sum + item.quantity, 0);

            if (totalItems > 0) {
                badge.textContent = totalItems;
                badge.classList.remove('hidden');
            } else {
                badge.classList.add('hidden');
            }
        }

        function showCart() {
            renderCart();
            showModal('cartModal');
        }

        function renderCart() {
            const container = document.getElementById('cartItems');
            const emptyState = document.getElementById('cartEmpty');
            const summary = document.getElementById('cartSummary');

            if (state.cart.length === 0) {
                container.innerHTML = '';
                emptyState.classList.remove('hidden');
                summary.classList.add('hidden');
                return;
            }

            emptyState.classList.add('hidden');
            summary.classList.remove('hidden');

            container.innerHTML = state.cart.map(item => `
                <div class="card rounded-xl p-4">
                    <div class="flex items-start gap-3">
                        <div class="flex-1">
                            <h3 class="font-medium text-sm mb-1">${item.name}</h3>
                            <p class="text-xs text-gray-500 mb-2">${item.desc}</p>
                            <div class="flex items-center justify-between">
                                <span class="text-lg font-bold">$${(item.price * item.quantity).toFixed(2)}</span>
                                <div class="flex items-center gap-2">
                                    <button onclick="updateCartQuantity(${item.productId}, -1)" class="w-8 h-8 bg-gray-200 rounded-lg flex items-center justify-center hover:bg-gray-300 transition-colors">
                                        ‚àí
                                    </button>
                                    <span class="w-8 text-center font-medium">${item.quantity}</span>
                                    <button onclick="updateCartQuantity(${item.productId}, 1)" class="w-8 h-8 bg-black text-white rounded-lg flex items-center justify-center hover:bg-gray-800 transition-colors">
                                        +
                                    </button>
                                    <button onclick="removeFromCart(${item.productId})" class="ml-2 w-8 h-8 bg-red-100 text-red-600 rounded-lg flex items-center justify-center hover:bg-red-200 transition-colors" title="–£–¥–∞–ª–∏—Ç—å">
                                        √ó
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');

            const totalItems = state.cart.reduce((sum, item) => sum + item.quantity, 0);
            const subtotal = state.cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);

            let discount = 0;
            if (state.appliedPromo) {
                discount = state.appliedPromo.discount_amount;
            }

            const totalPrice = subtotal - discount;

            document.getElementById('cartItemCount').textContent = totalItems;
            document.getElementById('cartSubtotal').textContent = `$${subtotal.toFixed(2)}`;
            document.getElementById('cartTotal').textContent = `$${totalPrice.toFixed(2)}`;

            // Show/hide discount
            if (state.appliedPromo) {
                document.getElementById('cartDiscount').classList.remove('hidden');
                document.getElementById('cartDiscountAmount').textContent = `-$${discount.toFixed(2)}`;
            } else {
                document.getElementById('cartDiscount').classList.add('hidden');
            }
        }

        async function applyPromoCode() {
            const promoInput = document.getElementById('cartPromoCode');
            const code = promoInput.value.trim().toUpperCase();
            const promoError = document.getElementById('promoError');
            const promoSuccess = document.getElementById('promoSuccess');

            promoError.classList.add('hidden');
            promoSuccess.classList.add('hidden');

            if (!code) {
                promoError.textContent = '–í–≤–µ–¥–∏—Ç–µ –ø—Ä–æ–º–æ–∫–æ–¥';
                promoError.classList.remove('hidden');
                return;
            }

            try {
                // Check promo code with API
                const promo = await apiRequest(`/api/promo/${code}`);

                if (!promo || !promo.valid) {
                    promoError.textContent = promo?.error || '–ü—Ä–æ–º–æ–∫–æ–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω –∏–ª–∏ –Ω–µ–∞–∫—Ç–∏–≤–µ–Ω';
                    promoError.classList.remove('hidden');
                    return;
                }

                // Calculate discount
                const subtotal = state.cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
                const discountAmount = (subtotal * promo.discount) / 100;

                state.appliedPromo = {
                    code: code,
                    discount_percent: promo.discount,
                    discount_amount: discountAmount
                };

                promoSuccess.textContent = `–ü—Ä–æ–º–æ–∫–æ–¥ –ø—Ä–∏–º–µ–Ω–µ–Ω! –°–∫–∏–¥–∫–∞ ${promo.discount}%`;
                promoSuccess.classList.remove('hidden');
                promoInput.disabled = true;

                renderCart();
                showToast(`‚úÖ –ü—Ä–æ–º–æ–∫–æ–¥ ${code} –ø—Ä–∏–º–µ–Ω–µ–Ω (-${promo.discount}%)`);
            } catch (error) {
                console.error('Promo code error:', error);
                promoError.textContent = '–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–æ–º–æ–∫–æ–¥–∞';
                promoError.classList.remove('hidden');
            }
        }

        async function sendCartToManager() {
            if (state.cart.length === 0) {
                showToast('–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞');
                return;
            }

            const comment = document.getElementById('cartComment').value.trim();
            const items = state.cart.map(item => ({
                name: item.name,
                price: item.price,
                quantity: item.quantity,
                total: item.price * item.quantity
            }));

            const subtotal = state.cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);

            let discountAmount = 0;
            let promoCode = null;
            if (state.appliedPromo) {
                discountAmount = state.appliedPromo.discount_amount;
                promoCode = state.appliedPromo.code;
            }

            const totalPrice = subtotal - discountAmount;

            const orderData = {
                id: 'ORD' + Date.now(),
                user_id: state.user?.id,
                items: items,
                comment: comment,
                promo_code: promoCode,
                discount_amount: discountAmount,
                subtotal: subtotal,
                total: totalPrice,
                status: 'awaiting_manager',
                created_at: new Date().toISOString()
            };

            try {
                // Send to server
                if (CONFIG.API_URL) {
                    await apiRequest('/api/cart-orders', 'POST', orderData);
                }

                // Clear cart and promo
                state.cart = [];
                state.appliedPromo = null;
                saveCart();
                updateCartBadge();
                document.getElementById('cartPromoCode').value = '';
                document.getElementById('cartPromoCode').disabled = false;

                closeModal();
                showToast('‚úÖ –ó–∞–∫–∞–∑ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –º–µ–Ω–µ–¥–∂–µ—Ä—É!');

                // Reload user data to update orders list
                await loadUserData();

            } catch (error) {
                console.error('Error sending cart order:', error);
                showToast('‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∑–∞–∫–∞–∑–∞');
            }
        }

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') closeModal();
        });

        document.getElementById('modalOverlay').addEventListener('touchmove', (e) => {
            e.preventDefault();
        }, { passive: false });

        // ==================== PAYMENT ====================
        let currentPaymentMethod = 'ton';
        let pendingOrder = null;
        const USDT_ADDRESS = 'TUgg2zUetS8JicSZNSxpTnGeA2hPGfVt9Q';
        const TON_ADDRESS = 'UQDqWKqWEE4h8D2bGNXGYjPzYfYJfCO3q_K8a_8KxvKGcxiK'; // Replace with your TON wallet

        // TON payment (simple deep link, no Connect SDK needed)
        // TON Connect SDK is unstable, using simple deep link for better stability
        
        function selectPaymentMethod(method) {
            currentPaymentMethod = method;
            document.querySelectorAll('.payment-method-btn').forEach(btn => {
                const isActive = btn.dataset.method === method;
                btn.classList.toggle('bg-blue-500', isActive && method === 'ton');
                btn.classList.toggle('bg-green-600', isActive && method === 'usdt');
                btn.classList.toggle('text-white', isActive);
                btn.classList.toggle('bg-gray-100', !isActive);
            });
            
            document.getElementById('tonPayment').classList.toggle('hidden', method !== 'ton');
            document.getElementById('usdtPayment').classList.toggle('hidden', method !== 'usdt');
        }
        
        function showPayment(amount, orderData) {
            pendingOrder = orderData;
            document.getElementById('paymentAmount').textContent = `$${amount.toFixed(2)}`;
            
            const tonRate = 2.5;
            const tonAmount = (amount / tonRate).toFixed(2);
            document.getElementById('tonAmount').textContent = `~ ${tonAmount} TON`;
            
            showModal('paymentModal');
        }
        
        function copyUsdtAddress() {
            navigator.clipboard.writeText(USDT_ADDRESS);
            showToast('üìã –ê–¥—Ä–µ—Å —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω!');
            if (tg) tg.HapticFeedback.impactOccurred('light');
        }
        
        document.getElementById('txHash')?.addEventListener('input', function() {
            const btn = document.getElementById('confirmUsdtBtn');
            btn.disabled = this.value.length < 10;
        });
        
        function payWithTon() {
            // Simple TON deep link payment (stable, no SDK needed)
            const tonAmount = (pendingOrder.total / 2.5).toFixed(2);
            const url = `ton://transfer/${TON_ADDRESS}?amount=${tonAmount * 1e9}&text=Order_${pendingOrder.id}`;

            if (tg) {
                tg.openLink(url);
            } else {
                window.open(url, '_blank');
            }

            showToast('üíé –û—Ç–∫—Ä–æ–π—Ç–µ TON –∫–æ—à–µ–ª—ë–∫ –∏ –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é');

            // After payment, switch to USDT input for hash
            setTimeout(() => {
                selectPaymentMethod('usdt');
                document.getElementById('txHash').placeholder = '–í—Å—Ç–∞–≤—å—Ç–µ —Ö–µ—à TON-—Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏...';
                showToast('–ü–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã –≤—Å—Ç–∞–≤—å—Ç–µ —Ö–µ—à —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏');
            }, 2000);
        }
        
        function checkTronScan() {
            const txHash = document.getElementById('txHash').value.trim();
            if (!txHash) {
                showToast('–í–≤–µ–¥–∏—Ç–µ —Ö–µ—à —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏');
                return;
            }

            const url = `https://tronscan.org/#/transaction/${txHash}`;
            if (tg) {
                tg.openLink(url);
            } else {
                window.open(url, '_blank');
            }
        }

        async function confirmUsdtPayment() {
            const txHash = document.getElementById('txHash').value.trim();
            const confirmBtn = document.getElementById('confirmUsdtBtn');

            if (!txHash) {
                showToast('‚ùå –í–≤–µ–¥–∏—Ç–µ —Ö–µ—à —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏');
                return;
            }

            if (txHash.length < 10) {
                showToast('‚ùå –°–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π —Ö–µ—à');
                return;
            }

            // Validate TRC20 hash format (64 hex characters)
            const trc20HashPattern = /^[a-fA-F0-9]{64}$/;

            if (!trc20HashPattern.test(txHash)) {
                showToast('‚ö†Ô∏è –§–æ—Ä–º–∞—Ç –Ω–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç TRC20');
                return;
            }

            // Show loading state
            confirmBtn.disabled = true;
            confirmBtn.textContent = '–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏...';
            showToast('üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é –Ω–∞ TronScan...');

            try {
                // Verify transaction on TronScan
                const verification = await apiRequest('/api/verify-tronscan', 'POST', {
                    txHash: txHash,
                    expectedAmount: pendingOrder.total,
                    recipientAddress: CONFIG.PAYMENT_ADDRESS
                });

                confirmBtn.disabled = false;
                confirmBtn.textContent = '–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –æ–ø–ª–∞—Ç—É';

                if (verification && verification.verified) {
                    // Transaction verified successfully
                    showToast('‚úÖ –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞!');
                    completeOrder(txHash);
                } else {
                    // Transaction not verified
                    const errorMsg = verification?.error || '–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞';
                    showToast('‚ùå ' + errorMsg);

                    // Show detailed error
                    if (confirm(errorMsg + '\n\n–û—Ç–∫—Ä—ã—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é –Ω–∞ TronScan –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏?')) {
                        checkTronScan();
                    }
                }
            } catch (error) {
                console.error('Verification error:', error);
                confirmBtn.disabled = false;
                confirmBtn.textContent = '–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –æ–ø–ª–∞—Ç—É';
                showToast('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑');
            }
        }
        
        function completeOrder(txHash) {
            if (!pendingOrder) return;

            pendingOrder.txHash = txHash;
            pendingOrder.paymentMethod = currentPaymentMethod;
            pendingOrder.paymentStatus = 'pending_verification';

            // Send to server
            if (CONFIG.API_URL) {
                apiRequest('/api/orders', 'POST', pendingOrder).catch(err => {
                    console.error('Failed to send order to server:', err);
                });

                // Apply promo code usage
                if (pendingOrder.promoCode) {
                    apiRequest('/api/promo/apply', 'POST', {
                        code: pendingOrder.promoCode,
                        user_id: state.user.id,
                        order_id: pendingOrder.id
                    }).catch(err => {
                        console.error('Failed to apply promo:', err);
                    });
                }
            }

            state.user.orders.push(pendingOrder);
            state.user.totalSpent += pendingOrder.total;

            // Only deduct used cashback, DON'T add earned cashback yet
            state.user.cashback -= pendingOrder.cashbackUsed || 0;

            if (pendingOrder.cashbackUsed > 0) {
                state.user.cashbackHistory.push({
                    amount: -pendingOrder.cashbackUsed,
                    description: `–û–ø–ª–∞—Ç–∞ –∑–∞–∫–∞–∑–∞ #${pendingOrder.id}`,
                    date: new Date().toISOString()
                });
            }
            // Cashback will be added by admin when order is completed

            updateUserLevel();
            
            state.user.notifications.push({
                title: 'üì¶ –ó–∞–∫–∞–∑ –æ—Ñ–æ—Ä–º–ª–µ–Ω',
                message: `–ó–∞–∫–∞–∑ #${pendingOrder.id} –æ–∂–∏–¥–∞–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –æ–ø–ª–∞—Ç—ã`,
                date: new Date().toISOString(),
                read: false
            });
            
            saveUserData();
            updateUI();
            
            pendingOrder = null;
            document.getElementById('txHash').value = '';
            document.getElementById('confirmUsdtBtn').disabled = true;
            
            closeModal();
            showToast('‚úÖ –ó–∞–∫–∞–∑ –æ—Ñ–æ—Ä–º–ª–µ–Ω! –û–∂–∏–¥–∞–π—Ç–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –æ–ø–ª–∞—Ç—ã');

            if (tg) tg.HapticFeedback.notificationOccurred('success');
        }

        // ==================== INVOICE FUNCTIONS ====================

        async function showInvoice(invoiceId) {
            try {
                const invoice = await apiRequest(`/api/invoices/${invoiceId}`);
                if (!invoice) {
                    showToast('‚ùå –ò–Ω–≤–æ–π—Å –Ω–µ –Ω–∞–π–¥–µ–Ω');
                    return;
                }

                const items = invoice.items || [];
                const itemsList = items.length > 0
                    ? items.map(item => `<div class="flex justify-between text-sm">
                        <span>${item.name} x${item.quantity}</span>
                        <span>$${item.total}</span>
                    </div>`).join('')
                    : '<div class="text-sm text-gray-500">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∑–∞–∫–∞–∑–µ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞</div>';

                document.getElementById('invoiceContent').innerHTML = `
                    <div class="space-y-4">
                        <div class="text-center mb-4">
                            <div class="text-gray-500 text-sm">–ù–æ–º–µ—Ä —Å—á–µ—Ç–∞</div>
                            <div class="font-mono text-lg">#${invoice.id}</div>
                        </div>

                        <div class="card rounded-xl p-4">
                            <div class="text-xs text-gray-500 mb-2">–î–µ—Ç–∞–ª–∏ –∑–∞–∫–∞–∑–∞</div>
                            ${itemsList}
                            ${invoice.comment ? `<div class="text-xs text-gray-500 mt-2">${invoice.comment}</div>` : ''}
                        </div>

                        <div class="card rounded-xl p-4">
                            <div class="flex justify-between mb-2">
                                <span class="text-gray-500">–°—É–º–º–∞:</span>
                                <span>$${invoice.amount}</span>
                            </div>
                            ${invoice.promo_code ? `
                            <div class="flex justify-between mb-2 text-green-600">
                                <span>–ü—Ä–æ–º–æ–∫–æ–¥ ${invoice.promo_code}:</span>
                                <span>-$${invoice.discount_amount}</span>
                            </div>
                            ` : ''}
                            <div class="flex justify-between font-bold text-lg border-t pt-2">
                                <span>–ò—Ç–æ–≥–æ:</span>
                                <span>$${invoice.final_amount}</span>
                            </div>
                        </div>

                        ${invoice.status === 'awaiting_payment' ? `
                        <div class="card rounded-xl p-4">
                            <div class="text-xs text-gray-500 mb-2">–ê–¥—Ä–µ—Å –¥–ª—è –æ–ø–ª–∞—Ç—ã (TRC-20 USDT)</div>
                            <div class="flex gap-2">
                                <input type="text" readonly value="${invoice.payment_address}"
                                    class="flex-1 bg-gray-100 rounded-lg px-3 py-2 text-sm font-mono">
                                <button onclick="navigator.clipboard.writeText('${invoice.payment_address}'); showToast('–ê–¥—Ä–µ—Å —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω')"
                                    class="btn-primary px-4 py-2 rounded-lg">
                                    üìã
                                </button>
                            </div>
                        </div>

                        <div class="card rounded-xl p-4">
                            <div class="text-xs text-gray-500 mb-2">–•–µ—à —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ (TxHash)</div>
                            <input type="text" id="invoiceTxHash" placeholder="–í—Å—Ç–∞–≤—å—Ç–µ —Ö–µ—à TRC-20 —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏"
                                class="w-full bg-gray-100 rounded-lg px-3 py-3 text-sm font-mono mb-3">
                            <button onclick="verifyInvoicePayment('${invoice.id}')"
                                class="w-full btn-primary py-3 rounded-xl font-semibold">
                                ‚úÖ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ–ø–ª–∞—Ç—É
                            </button>
                        </div>
                        ` : ''}

                        ${invoice.status === 'paid' ? `
                        <div class="card rounded-xl p-4 bg-green-50 text-center">
                            <div class="text-4xl mb-2">‚úÖ</div>
                            <div class="font-semibold text-green-700">–û–ø–ª–∞—Ç–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞!</div>
                            <div class="text-sm text-green-600 mt-1">–ó–∞–∫–∞–∑ –ø—Ä–∏–Ω—è—Ç –≤ —Ä–∞–±–æ—Ç—É</div>
                        </div>
                        ` : ''}
                    </div>
                `;

                showModal('invoiceModal');
            } catch (error) {
                console.error('Error loading invoice:', error);
                showToast('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–Ω–≤–æ–π—Å–∞');
            }
        }

        async function verifyInvoicePayment(invoiceId) {
            const txHash = document.getElementById('invoiceTxHash').value.trim();

            if (!txHash) {
                showToast('‚ùå –í–≤–µ–¥–∏—Ç–µ —Ö–µ—à —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏');
                return;
            }

            if (txHash.length < 10) {
                showToast('‚ùå –°–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π —Ö–µ—à');
                return;
            }

            // Validate TRC20 hash format
            const trc20HashPattern = /^[a-fA-F0-9]{64}$/;
            if (!trc20HashPattern.test(txHash)) {
                showToast('‚ö†Ô∏è –§–æ—Ä–º–∞—Ç –Ω–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç TRC20');
                return;
            }

            showToast('üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é –Ω–∞ TronScan...');

            try {
                // First, update invoice with tx_hash
                await apiRequest(`/api/invoices/${invoiceId}/verify`, 'POST', { tx_hash: txHash });

                // Get invoice details for verification
                const invoice = await apiRequest(`/api/invoices/${invoiceId}`);

                // Verify transaction on TronScan
                const verification = await apiRequest('/api/verify-tronscan', 'POST', {
                    txHash: txHash,
                    expectedAmount: invoice.final_amount,
                    recipientAddress: invoice.payment_address
                });

                if (verification && verification.verified) {
                    // Transaction verified successfully
                    showToast('‚úÖ –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞!');

                    // Confirm payment
                    await apiRequest(`/api/invoices/${invoiceId}/confirm`, 'POST', {});

                    // Reload invoice to show updated status
                    await showInvoice(invoiceId);

                    // Reload user data to update orders
                    await loadUserData();
                } else {
                    const errorMsg = verification?.error || '–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞';
                    showToast('‚ùå ' + errorMsg);

                    if (confirm(errorMsg + '\n\n–û—Ç–∫—Ä—ã—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é –Ω–∞ TronScan –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏?')) {
                        const url = `https://tronscan.org/#/transaction/${txHash}`;
                        if (tg) {
                            tg.openLink(url);
                        } else {
                            window.open(url, '_blank');
                        }
                    }
                }
            } catch (error) {
                console.error('Verification error:', error);
                showToast('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑');
            }
        }

        // Handle invoice deep link (from Telegram notification)
        function handleInvoiceDeepLink() {
            // Check URL hash first (from Web App button)
            const hash = window.location.hash;
            if (hash && hash.startsWith('#invoice_')) {
                const invoiceId = hash.replace('#invoice_', '');
                console.log('Opening invoice from URL hash:', invoiceId);
                // Show invoice after app loads
                setTimeout(() => {
                    showInvoice(invoiceId);
                }, 1000);
                return;
            }

            // Fallback to start_param
            if (tg && tg.initDataUnsafe?.start_param) {
                const startParam = tg.initDataUnsafe.start_param;
                if (startParam.startsWith('invoice_')) {
                    const invoiceId = startParam.replace('invoice_', '');
                    console.log('Opening invoice from start_param:', invoiceId);
                    // Show invoice after app loads
                    setTimeout(() => {
                        showInvoice(invoiceId);
                    }, 1000);
                }
            }
        }

        init();
        handleInvoiceDeepLink();
    </script>
</body>
</html>
